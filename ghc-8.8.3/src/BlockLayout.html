<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>nativeGen/BlockLayout.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>--</span>
<a name="line-2"></a><span class='hs-comment'>-- Copyright (c) 2018 Andreas Klebinger</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies, ScopedTypeVariables, CPP #-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# OPTIONS_GHC -fprof-auto #-}</span>
<a name="line-8"></a><span class='hs-comment'>--{-# OPTIONS_GHC -ddump-simpl -ddump-to-file -ddump-cmm #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>BlockLayout</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>sequenceTop</span> <span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcPrelude</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Instruction</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NCGMonad</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CFG</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BlockId</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Cmm</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hoopl.Collections</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hoopl.Label</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hoopl.Block</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span><span class='hs-layout'>,</span> <span class='hs-conid'>GeneralFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>backendMaintainsCfg</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>-- DEBUGGING ONLY</span>
<a name="line-37"></a><span class='hs-comment'>--import Debug</span>
<a name="line-38"></a><span class='hs-comment'>--import Debug.Trace</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeDups</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCmm</span> <span class='hs-conid'>()</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Foldable</span> <span class='hs-layout'>(</span><span class='hs-varid'>toList</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Hoopl.Graph</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Applicative</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-comment'>{-
<a name="line-51"></a>  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-52"></a>  ~~~ Note [Chain based CFG serialization]
<a name="line-53"></a>  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-54"></a>
<a name="line-55"></a>  For additional information also look at
<a name="line-56"></a>  https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/CodeLayout
<a name="line-57"></a>
<a name="line-58"></a>  We have a CFG with edge weights based on which we try to place blocks next to
<a name="line-59"></a>  each other.
<a name="line-60"></a>
<a name="line-61"></a>  Edge weights not only represent likelyhood of control transfer between blocks
<a name="line-62"></a>  but also how much a block would benefit from being placed sequentially after
<a name="line-63"></a>  it's predecessor.
<a name="line-64"></a>  For example blocks which are preceeded by an info table are more likely to end
<a name="line-65"></a>  up in a different cache line than their predecessor. So there is less benefit
<a name="line-66"></a>  in placing them sequentially.
<a name="line-67"></a>
<a name="line-68"></a>  For example consider this example:
<a name="line-69"></a>
<a name="line-70"></a>  A:  ...
<a name="line-71"></a>      jmp cond D (weak successor)
<a name="line-72"></a>      jmp B
<a name="line-73"></a>  B:  ...
<a name="line-74"></a>      jmp C
<a name="line-75"></a>  C:  ...
<a name="line-76"></a>      jmp X
<a name="line-77"></a>  D:  ...
<a name="line-78"></a>      jmp B (weak successor)
<a name="line-79"></a>
<a name="line-80"></a>  We determine a block layout by building up chunks (calling them chains) of
<a name="line-81"></a>  possible control flows for which blocks will be placed sequentially.
<a name="line-82"></a>
<a name="line-83"></a>  Eg for our example we might end up with two chains like:
<a name="line-84"></a>  [A-&gt;B-&gt;C-&gt;X],[D]. Blocks inside chains will always be placed sequentially.
<a name="line-85"></a>  However there is no particular order in which chains are placed since
<a name="line-86"></a>  (hopefully) the blocks for which sequentially is important have already
<a name="line-87"></a>  been placed in the same chain.
<a name="line-88"></a>
<a name="line-89"></a>  -----------------------------------------------------------------------------
<a name="line-90"></a>      First try to create a lists of good chains.
<a name="line-91"></a>  -----------------------------------------------------------------------------
<a name="line-92"></a>
<a name="line-93"></a>  We do so by taking a block not yet placed in a chain and
<a name="line-94"></a>  looking at these cases:
<a name="line-95"></a>
<a name="line-96"></a>  *)  Check if the best predecessor of the block is at the end of a chain.
<a name="line-97"></a>      If so add the current block to the end of that chain.
<a name="line-98"></a>
<a name="line-99"></a>      Eg if we look at block C and already have the chain (A -&gt; B)
<a name="line-100"></a>      then we extend the chain to (A -&gt; B -&gt; C).
<a name="line-101"></a>
<a name="line-102"></a>      Combined with the fact that we process blocks in reverse post order
<a name="line-103"></a>      this means loop bodies and trivially sequential control flow already
<a name="line-104"></a>      ends up as a single chain.
<a name="line-105"></a>
<a name="line-106"></a>  *)  Otherwise we create a singleton chain from the block we are looking at.
<a name="line-107"></a>      Eg if we have from the example above already constructed (A-&gt;B)
<a name="line-108"></a>      and look at D we create the chain (D) resulting in the chains [A-&gt;B, D]
<a name="line-109"></a>
<a name="line-110"></a>  -----------------------------------------------------------------------------
<a name="line-111"></a>      We then try to fuse chains.
<a name="line-112"></a>  -----------------------------------------------------------------------------
<a name="line-113"></a>
<a name="line-114"></a>  There are edge cases which result in two chains being created which trivially
<a name="line-115"></a>  represent linear control flow. For example we might have the chains
<a name="line-116"></a>  [(A-B-C),(D-E)] with an cfg triangle:
<a name="line-117"></a>
<a name="line-118"></a>      A-----&gt;C-&gt;D-&gt;E
<a name="line-119"></a>       \-&gt;B-/
<a name="line-120"></a>
<a name="line-121"></a>  We also get three independent chains if two branches end with a jump
<a name="line-122"></a>  to a common successor.
<a name="line-123"></a>
<a name="line-124"></a>  We take care of these cases by fusing chains which are connected by an
<a name="line-125"></a>  edge.
<a name="line-126"></a>
<a name="line-127"></a>  We do so by looking at the list of edges sorted by weight.
<a name="line-128"></a>  Given the edge (C -&gt; D) we try to find two chains such that:
<a name="line-129"></a>      * C is at the end of chain one.
<a name="line-130"></a>      * D is in front of chain two.
<a name="line-131"></a>      * If two such chains exist we fuse them.
<a name="line-132"></a>  We then remove the edge and repeat the process for the rest of the edges.
<a name="line-133"></a>
<a name="line-134"></a>  -----------------------------------------------------------------------------
<a name="line-135"></a>      Place indirect successors (neighbours) after each other
<a name="line-136"></a>  -----------------------------------------------------------------------------
<a name="line-137"></a>
<a name="line-138"></a>  We might have chains [A,B,C,X],[E] in a CFG of the sort:
<a name="line-139"></a>
<a name="line-140"></a>    A ---&gt; B ---&gt; C --------&gt; X(exit)
<a name="line-141"></a>                   \- -&gt;E- -/
<a name="line-142"></a>
<a name="line-143"></a>  While E does not follow X it's still beneficial to place them near each other.
<a name="line-144"></a>  This can be advantageous if eg C,X,E will end up in the same cache line.
<a name="line-145"></a>
<a name="line-146"></a>  TODO: If we remove edges as we use them (eg if we build up A-&gt;B remove A-&gt;B
<a name="line-147"></a>        from the list) we could save some more work in later phases.
<a name="line-148"></a>
<a name="line-149"></a>
<a name="line-150"></a>  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-151"></a>  ~~~ Note [Triangle Control Flow]
<a name="line-152"></a>  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-153"></a>
<a name="line-154"></a>  Checking if an argument is already evaluating leads to a somewhat
<a name="line-155"></a>  special case  which looks like this:
<a name="line-156"></a>
<a name="line-157"></a>    A:
<a name="line-158"></a>        if (R1 &amp; 7 != 0) goto Leval; else goto Lwork;
<a name="line-159"></a>    Leval: // global
<a name="line-160"></a>        call (I64[R1])(R1) returns to Lwork, args: 8, res: 8, upd: 8;
<a name="line-161"></a>    Lwork: // global
<a name="line-162"></a>        ...
<a name="line-163"></a>
<a name="line-164"></a>        A
<a name="line-165"></a>        |\
<a name="line-166"></a>        | Leval
<a name="line-167"></a>        |/ - (This edge can be missing because of optimizations)
<a name="line-168"></a>        Lwork
<a name="line-169"></a>
<a name="line-170"></a>  Once we hit the metal the call instruction is just 2-3 bytes large
<a name="line-171"></a>  depending on the register used. So we lay out the assembly like this:
<a name="line-172"></a>
<a name="line-173"></a>        movq %rbx,%rax
<a name="line-174"></a>        andl $7,%eax
<a name="line-175"></a>        cmpq $1,%rax
<a name="line-176"></a>        jne Lwork
<a name="line-177"></a>    Leval:
<a name="line-178"></a>        jmp *(%rbx) # encoded in 2-3 bytes.
<a name="line-179"></a>    &lt;info table&gt;
<a name="line-180"></a>    Lwork:
<a name="line-181"></a>        ...
<a name="line-182"></a>
<a name="line-183"></a>  We could explicitly check for this control flow pattern.
<a name="line-184"></a>
<a name="line-185"></a>  This is advantageous because:
<a name="line-186"></a>  * It's optimal if the argument isn't evaluated.
<a name="line-187"></a>  * If it's evaluated we only have the extra cost of jumping over
<a name="line-188"></a>    the 2-3 bytes for the call.
<a name="line-189"></a>  * Guarantees the smaller encoding for the conditional jump.
<a name="line-190"></a>
<a name="line-191"></a>  However given that Lwork usually has an info table we
<a name="line-192"></a>  penalize this edge. So Leval should get placed first
<a name="line-193"></a>  either way and things work out for the best.
<a name="line-194"></a>
<a name="line-195"></a>  Optimizing for the evaluated case instead would penalize
<a name="line-196"></a>  the other code path. It adds an jump as we can't fall through
<a name="line-197"></a>  to Lwork because of the info table.
<a name="line-198"></a>  Assuming that Lwork is large the chance that the "call" ends up
<a name="line-199"></a>  in the same cache line is also fairly small.
<a name="line-200"></a>
<a name="line-201"></a>-}</span>
<a name="line-202"></a>
<a name="line-203"></a>
<a name="line-204"></a><a name="neighbourOverlapp"></a><span class='hs-comment'>-- | Look at X number of blocks in two chains to determine</span>
<a name="line-205"></a><span class='hs-comment'>--   if they are "neighbours".</span>
<a name="line-206"></a><span class='hs-definition'>neighbourOverlapp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-207"></a><span class='hs-definition'>neighbourOverlapp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="fuseEdgeThreshold"></a><span class='hs-comment'>-- | Only edges heavier than this are considered</span>
<a name="line-210"></a><span class='hs-comment'>--   for fusing two chains into a single chain.</span>
<a name="line-211"></a><span class='hs-definition'>fuseEdgeThreshold</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EdgeWeight</span>
<a name="line-212"></a><span class='hs-definition'>fuseEdgeThreshold</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-213"></a>
<a name="line-214"></a>
<a name="line-215"></a><a name="BlockChain"></a><span class='hs-comment'>-- | A non empty ordered sequence of basic blocks.</span>
<a name="line-216"></a><a name="BlockChain"></a><span class='hs-comment'>--   It is suitable for serialization in this order.</span>
<a name="line-217"></a><a name="BlockChain"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BlockChain</span>
<a name="line-218"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockChain</span>
<a name="line-219"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>chainMembers</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>LabelSet</span>
<a name="line-220"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>chainBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>BlockSequence</span>
<a name="line-221"></a>    <span class='hs-layout'>}</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="instance%20Eq%20(BlockChain)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-224"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>s1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>s2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-225"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>s2</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="instance%20Outputable%20(BlockChain)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-228"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-229"></a>        <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Chain:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="WeightedEdge"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WeightedEdge</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WeightedEdge</span> <span class='hs-varop'>!</span><span class='hs-conid'>BlockId</span> <span class='hs-varop'>!</span><span class='hs-conid'>BlockId</span> <span class='hs-conid'>EdgeWeight</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="instance%20Ord%20(BlockChain)"></a><span class='hs-comment'>-- Useful for things like sets and debugging purposes, sorts by blocks</span>
<a name="line-234"></a><a name="instance%20Ord%20(BlockChain)"></a><span class='hs-comment'>-- in the chain.</span>
<a name="line-235"></a><a name="instance%20Ord%20(BlockChain)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-236"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varop'>`compare`</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-237"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lbls1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>lbls2</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="instance%20Ord%20WeightedEdge"></a><span class='hs-comment'>-- | Non deterministic! (Uniques) Sorts edges by weight and nodes.</span>
<a name="line-240"></a><a name="instance%20Ord%20WeightedEdge"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>WeightedEdge</span> <span class='hs-keyword'>where</span>
<a name="line-241"></a>  <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from1</span> <span class='hs-varid'>to1</span> <span class='hs-varid'>weight1</span><span class='hs-layout'>)</span>
<a name="line-242"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from2</span> <span class='hs-varid'>to2</span> <span class='hs-varid'>weight2</span><span class='hs-layout'>)</span>
<a name="line-243"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>weight1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>weight2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>weight1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>weight2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>from1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>from2</span> <span class='hs-varop'>||</span>
<a name="line-244"></a>      <span class='hs-varid'>weight1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>weight2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>from1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>from2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>to1</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>to2</span>
<a name="line-245"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-246"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>from1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>from2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>to1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>to2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>weight1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>weight2</span>
<a name="line-247"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-248"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-249"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="instance%20Outputable%20WeightedEdge"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WeightedEdge</span> <span class='hs-keyword'>where</span>
<a name="line-252"></a>    <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-253"></a>        <span class='hs-varid'>ppr</span> <span class='hs-varid'>from</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>to</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="WeightedEdgeList"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>WeightedEdgeList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WeightedEdge</span><span class='hs-keyglyph'>]</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="noDups"></a><span class='hs-definition'>noDups</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-258"></a><span class='hs-definition'>noDups</span> <span class='hs-varid'>chains</span> <span class='hs-keyglyph'>=</span>
<a name="line-259"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>chainBlocks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>chainToBlocks</span> <span class='hs-varid'>chains</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-260"></a>        <span class='hs-layout'>(</span><span class='hs-sel'>_blocks</span><span class='hs-layout'>,</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>chainBlocks</span>
<a name="line-261"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dups</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>True</span>
<a name="line-262"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Duplicates:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"chains"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>chains</span> <span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="inFront"></a><span class='hs-definition'>inFront</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-265"></a><span class='hs-definition'>inFront</span> <span class='hs-varid'>bid</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqFront</span> <span class='hs-varid'>seq</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bid</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="chainMember"></a><span class='hs-definition'>chainMember</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-269"></a><span class='hs-definition'>chainMember</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>chain</span>
<a name="line-270"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setMember</span> <span class='hs-varid'>bid</span> <span class='hs-varop'>.</span> <span class='hs-varid'>chainMembers</span> <span class='hs-varop'>$</span> <span class='hs-varid'>chain</span>
<a name="line-271"></a>
<a name="line-272"></a><a name="chainSingleton"></a><span class='hs-definition'>chainSingleton</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span>
<a name="line-273"></a><span class='hs-definition'>chainSingleton</span> <span class='hs-varid'>lbl</span>
<a name="line-274"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockChain</span> <span class='hs-layout'>(</span><span class='hs-varid'>setSingleton</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span>
<a name="line-275"></a>
<a name="line-276"></a><a name="chainSnoc"></a><span class='hs-definition'>chainSnoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span>
<a name="line-277"></a><span class='hs-definition'>chainSnoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-varid'>lbl</span>
<a name="line-278"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockChain</span> <span class='hs-layout'>(</span><span class='hs-varid'>setInsert</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>lbls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqSnoc</span> <span class='hs-varid'>blks</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span>
<a name="line-279"></a>
<a name="line-280"></a><a name="chainConcat"></a><span class='hs-definition'>chainConcat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span>
<a name="line-281"></a><span class='hs-definition'>chainConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls1</span> <span class='hs-varid'>blks1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls2</span> <span class='hs-varid'>blks2</span><span class='hs-layout'>)</span>
<a name="line-282"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockChain</span> <span class='hs-layout'>(</span><span class='hs-varid'>setUnion</span> <span class='hs-varid'>lbls1</span> <span class='hs-varid'>lbls2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>blks1</span> <span class='hs-varop'>`seqConcat`</span> <span class='hs-varid'>blks2</span><span class='hs-layout'>)</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="chainToBlocks"></a><span class='hs-definition'>chainToBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-285"></a><span class='hs-definition'>chainToBlocks</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqToList</span> <span class='hs-varid'>blks</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="breakChainAt"></a><span class='hs-comment'>-- | Given the Chain A -&gt; B -&gt; C -&gt; D and we break at C</span>
<a name="line-288"></a><span class='hs-comment'>--   we get the two Chains (A -&gt; B, C -&gt; D) as result.</span>
<a name="line-289"></a><span class='hs-definition'>breakChainAt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span>
<a name="line-290"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>,</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span>
<a name="line-291"></a><span class='hs-definition'>breakChainAt</span> <span class='hs-varid'>bid</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-varid'>lbls</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span>
<a name="line-292"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>setMember</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>lbls</span><span class='hs-layout'>)</span>
<a name="line-293"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Block not in chain"</span>
<a name="line-294"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-295"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lblks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rblks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lbl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span>
<a name="line-296"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>seqToList</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span>
<a name="line-297"></a>          <span class='hs-comment'>--TODO: Remove old</span>
<a name="line-298"></a>          <span class='hs-comment'>--lblSet :: [GenBasicBlock i] -&gt; BlockChain</span>
<a name="line-299"></a>          <span class='hs-comment'>--lblSet blks =</span>
<a name="line-300"></a>          <span class='hs-comment'>--  setFromList</span>
<a name="line-301"></a>                <span class='hs-comment'>--(map (\(BasicBlock lbl _) -&gt; lbl) $ toList blks)</span>
<a name="line-302"></a>      <span class='hs-keyword'>in</span>
<a name="line-303"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-layout'>(</span><span class='hs-varid'>setFromList</span> <span class='hs-varid'>lblks</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqFromBids</span> <span class='hs-varid'>lblks</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-304"></a>       <span class='hs-conid'>BlockChain</span> <span class='hs-layout'>(</span><span class='hs-varid'>setFromList</span> <span class='hs-varid'>rblks</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>seqFromBids</span> <span class='hs-varid'>rblks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-305"></a>
<a name="line-306"></a><a name="takeR"></a><span class='hs-definition'>takeR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-307"></a><span class='hs-definition'>takeR</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-308"></a>    <span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-varop'>.</span> <span class='hs-varid'>seqToRList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blks</span>
<a name="line-309"></a>
<a name="line-310"></a>
<a name="line-311"></a><a name="takeL"></a><span class='hs-definition'>takeL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-312"></a><span class='hs-definition'>takeL</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockChain</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>--error "TODO: takeLn"</span>
<a name="line-313"></a>    <span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-varop'>.</span> <span class='hs-varid'>seqToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blks</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="fuseChains"></a><span class='hs-comment'>-- | For a given list of chains try to fuse chains with strong</span>
<a name="line-316"></a><span class='hs-comment'>--   edges between them into a single chain.</span>
<a name="line-317"></a><span class='hs-comment'>--   Returns the list of fused chains together with a set of</span>
<a name="line-318"></a><span class='hs-comment'>--   used edges. The set of edges is indirectly encoded in the</span>
<a name="line-319"></a><span class='hs-comment'>--   chains so doesn't need to be considered for later passes.</span>
<a name="line-320"></a><span class='hs-definition'>fuseChains</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WeightedEdgeList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span>
<a name="line-321"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>WeightedEdge</span><span class='hs-layout'>)</span>
<a name="line-322"></a><span class='hs-definition'>fuseChains</span> <span class='hs-varid'>weights</span> <span class='hs-varid'>chains</span>
<a name="line-323"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fronts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFromList</span> <span class='hs-varop'>$</span>
<a name="line-324"></a>                    <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>chain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeL</span> <span class='hs-num'>1</span> <span class='hs-varid'>chain</span><span class='hs-layout'>,</span><span class='hs-varid'>chain</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-325"></a>                    <span class='hs-varid'>mapElems</span> <span class='hs-varid'>chains</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span>
<a name="line-326"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>chains'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>weights</span> <span class='hs-varid'>chains</span> <span class='hs-varid'>fronts</span> <span class='hs-conid'>Set.empty</span>
<a name="line-327"></a>      <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>chains'</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>)</span>
<a name="line-328"></a>    <span class='hs-keyword'>where</span>
<a name="line-329"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WeightedEdgeList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span>
<a name="line-330"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>WeightedEdge</span>
<a name="line-331"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set.Set</span> <span class='hs-conid'>WeightedEdge</span><span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span>
<a name="line-332"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>chainsEnd</span> <span class='hs-varid'>chainsFront</span> <span class='hs-varid'>used</span>
<a name="line-333"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>chainsEnd</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>,</span> <span class='hs-varid'>chainsFront</span><span class='hs-layout'>)</span>
<a name="line-334"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-layout'>(</span><span class='hs-varid'>edge</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>edges</span><span class='hs-layout'>)</span> <span class='hs-varid'>chainsEnd</span> <span class='hs-varid'>chainsFront</span> <span class='hs-varid'>used</span>
<a name="line-335"></a>            <span class='hs-comment'>--Since we order edges descending by weight we can stop here</span>
<a name="line-336"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>w</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fuseEdgeThreshold</span>
<a name="line-337"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>chainsEnd</span><span class='hs-layout'>,</span> <span class='hs-varid'>used</span><span class='hs-layout'>,</span> <span class='hs-varid'>chainsFront</span><span class='hs-layout'>)</span>
<a name="line-338"></a>            <span class='hs-comment'>--Fuse the two chains</span>
<a name="line-339"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>from</span> <span class='hs-varid'>chainsEnd</span>
<a name="line-340"></a>            <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>c2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>to</span> <span class='hs-varid'>chainsFront</span>
<a name="line-341"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>c2</span>
<a name="line-342"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newChain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chainConcat</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span>
<a name="line-343"></a>                  <span class='hs-varid'>front</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeL</span> <span class='hs-num'>1</span> <span class='hs-varid'>newChain</span>
<a name="line-344"></a>                  <span class='hs-varid'>end</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeR</span> <span class='hs-num'>1</span> <span class='hs-varid'>newChain</span>
<a name="line-345"></a>                  <span class='hs-varid'>chainsFront'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>front</span> <span class='hs-varid'>newChain</span> <span class='hs-varop'>$</span>
<a name="line-346"></a>                                 <span class='hs-varid'>mapDelete</span> <span class='hs-varid'>to</span> <span class='hs-varid'>chainsFront</span>
<a name="line-347"></a>                  <span class='hs-varid'>chainsEnd'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>end</span> <span class='hs-varid'>newChain</span> <span class='hs-varop'>$</span>
<a name="line-348"></a>                                 <span class='hs-varid'>mapDelete</span> <span class='hs-varid'>from</span> <span class='hs-varid'>chainsEnd</span>
<a name="line-349"></a>              <span class='hs-keyword'>in</span> <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>chainsEnd'</span> <span class='hs-varid'>chainsFront'</span>
<a name="line-350"></a>                            <span class='hs-layout'>(</span><span class='hs-conid'>Set.insert</span> <span class='hs-varid'>edge</span> <span class='hs-varid'>used</span><span class='hs-layout'>)</span>
<a name="line-351"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-352"></a>            <span class='hs-comment'>--Check next edge</span>
<a name="line-353"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>chainsEnd</span> <span class='hs-varid'>chainsFront</span> <span class='hs-varid'>used</span>
<a name="line-354"></a>
<a name="line-355"></a>
<a name="line-356"></a><span class='hs-comment'>-- See also Note [Chain based CFG serialization]</span>
<a name="line-357"></a><span class='hs-comment'>-- We have the chains (A-B-C-D) and (E-F) and an Edge C-&gt;E.</span>
<a name="line-358"></a><span class='hs-comment'>--</span>
<a name="line-359"></a><span class='hs-comment'>-- While placing the later after the former doesn't result in sequential</span>
<a name="line-360"></a><span class='hs-comment'>-- control flow it is still be benefical since block C and E might end</span>
<a name="line-361"></a><span class='hs-comment'>-- up in the same cache line.</span>
<a name="line-362"></a><span class='hs-comment'>--</span>
<a name="line-363"></a><span class='hs-comment'>-- So we place these chains next to each other even if we can't fuse them.</span>
<a name="line-364"></a><span class='hs-comment'>--</span>
<a name="line-365"></a><span class='hs-comment'>--   A -&gt; B -&gt; C -&gt; D</span>
<a name="line-366"></a><span class='hs-comment'>--             v</span>
<a name="line-367"></a><span class='hs-comment'>--             - -&gt; E -&gt; F ...</span>
<a name="line-368"></a><span class='hs-comment'>--</span>
<a name="line-369"></a><span class='hs-comment'>-- Simple heuristic to chose which chains we want to combine:</span>
<a name="line-370"></a><span class='hs-comment'>--   * Process edges in descending priority.</span>
<a name="line-371"></a><span class='hs-comment'>--   * Check if there is a edge near the end of one chain which goes</span>
<a name="line-372"></a><span class='hs-comment'>--     to a block near the start of another edge.</span>
<a name="line-373"></a><span class='hs-comment'>--</span>
<a name="line-374"></a><span class='hs-comment'>-- While we could take into account the space between the two blocks which</span>
<a name="line-375"></a><span class='hs-comment'>-- share an edge this blows up compile times quite a bit. It requires</span>
<a name="line-376"></a><span class='hs-comment'>-- us to find all edges between two chains, check the distance for all edges,</span>
<a name="line-377"></a><span class='hs-comment'>-- rank them based on the distance and and only then we can select two chains</span>
<a name="line-378"></a><span class='hs-comment'>-- to combine. Which would add a lot of complexity for little gain.</span>
<a name="line-379"></a>
<a name="line-380"></a><a name="combineNeighbourhood"></a><span class='hs-comment'>-- | For a given list of chains and edges try to combine chains with strong</span>
<a name="line-381"></a><span class='hs-comment'>--   edges between them.</span>
<a name="line-382"></a><span class='hs-definition'>combineNeighbourhood</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WeightedEdgeList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span>
<a name="line-383"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span>
<a name="line-384"></a><span class='hs-definition'>combineNeighbourhood</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>chains</span>
<a name="line-385"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTraceIt "Neigbours" $</span>
<a name="line-386"></a>      <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>endFrontier</span> <span class='hs-varid'>startFrontier</span>
<a name="line-387"></a>    <span class='hs-keyword'>where</span>
<a name="line-388"></a>        <span class='hs-comment'>--Build maps from chain ends to chains</span>
<a name="line-389"></a>        <span class='hs-varid'>endFrontier</span><span class='hs-layout'>,</span> <span class='hs-varid'>startFrontier</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FrontierMap</span>
<a name="line-390"></a>        <span class='hs-varid'>endFrontier</span> <span class='hs-keyglyph'>=</span>
<a name="line-391"></a>            <span class='hs-varid'>mapFromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>chain</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-392"></a>                                <span class='hs-keyword'>let</span> <span class='hs-varid'>ends</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEnds</span> <span class='hs-varid'>chain</span>
<a name="line-393"></a>                                    <span class='hs-varid'>entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ends</span><span class='hs-layout'>,</span><span class='hs-varid'>chain</span><span class='hs-layout'>)</span>
<a name="line-394"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>entry</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ends</span> <span class='hs-layout'>)</span> <span class='hs-varid'>chains</span>
<a name="line-395"></a>        <span class='hs-varid'>startFrontier</span> <span class='hs-keyglyph'>=</span>
<a name="line-396"></a>            <span class='hs-varid'>mapFromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>chain</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-397"></a>                                <span class='hs-keyword'>let</span> <span class='hs-varid'>front</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFronts</span> <span class='hs-varid'>chain</span>
<a name="line-398"></a>                                    <span class='hs-varid'>entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>front</span><span class='hs-layout'>,</span><span class='hs-varid'>chain</span><span class='hs-layout'>)</span>
<a name="line-399"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>entry</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>front</span><span class='hs-layout'>)</span> <span class='hs-varid'>chains</span>
<a name="line-400"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WeightedEdgeList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FrontierMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FrontierMap</span>
<a name="line-401"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span>
<a name="line-402"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>chainEnds</span> <span class='hs-sel'>_chainFronts</span> <span class='hs-keyglyph'>=</span>
<a name="line-403"></a>            <span class='hs-varid'>ordNub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapElems</span> <span class='hs-varid'>chainEnds</span>
<a name="line-404"></a>        <span class='hs-varid'>applyEdges</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-sel'>_w</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>edges</span><span class='hs-layout'>)</span> <span class='hs-varid'>chainEnds</span> <span class='hs-varid'>chainFronts</span>
<a name="line-405"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1_e</span><span class='hs-layout'>,</span><span class='hs-varid'>c1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>from</span> <span class='hs-varid'>chainEnds</span>
<a name="line-406"></a>            <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2_f</span><span class='hs-layout'>,</span><span class='hs-varid'>c2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>to</span> <span class='hs-varid'>chainFronts</span>
<a name="line-407"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>c2</span> <span class='hs-comment'>-- Avoid trying to concat a short chain with itself.</span>
<a name="line-408"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>newChain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chainConcat</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span>
<a name="line-409"></a>                  <span class='hs-varid'>newChainFrontier</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getFronts</span> <span class='hs-varid'>newChain</span>
<a name="line-410"></a>                  <span class='hs-varid'>newChainEnds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEnds</span> <span class='hs-varid'>newChain</span>
<a name="line-411"></a>                  <span class='hs-varid'>newFronts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FrontierMap</span>
<a name="line-412"></a>                  <span class='hs-varid'>newFronts</span> <span class='hs-keyglyph'>=</span>
<a name="line-413"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>withoutOld</span> <span class='hs-keyglyph'>=</span>
<a name="line-414"></a>                            <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapDelete</span> <span class='hs-varid'>b</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FrontierMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>chainFronts</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2_f</span> <span class='hs-varop'>++</span> <span class='hs-varid'>getFronts</span> <span class='hs-varid'>c1</span><span class='hs-layout'>)</span>
<a name="line-415"></a>                        <span class='hs-varid'>entry</span> <span class='hs-keyglyph'>=</span>
<a name="line-416"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>newChainFrontier</span><span class='hs-layout'>,</span><span class='hs-varid'>newChain</span><span class='hs-layout'>)</span> <span class='hs-comment'>--let bound to ensure sharing</span>
<a name="line-417"></a>                    <span class='hs-keyword'>in</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>x</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-418"></a>                              <span class='hs-varid'>withoutOld</span> <span class='hs-varid'>newChainFrontier</span>
<a name="line-419"></a>
<a name="line-420"></a>                  <span class='hs-varid'>newEnds</span> <span class='hs-keyglyph'>=</span>
<a name="line-421"></a>                    <span class='hs-keyword'>let</span> <span class='hs-varid'>withoutOld</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapDelete</span> <span class='hs-varid'>b</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>chainEnds</span> <span class='hs-layout'>(</span><span class='hs-varid'>c1_e</span> <span class='hs-varop'>++</span> <span class='hs-varid'>getEnds</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>
<a name="line-422"></a>                        <span class='hs-varid'>entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>newChainEnds</span><span class='hs-layout'>,</span><span class='hs-varid'>newChain</span><span class='hs-layout'>)</span> <span class='hs-comment'>--let bound to ensure sharing</span>
<a name="line-423"></a>                    <span class='hs-keyword'>in</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>x</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-424"></a>                              <span class='hs-varid'>withoutOld</span> <span class='hs-varid'>newChainEnds</span>
<a name="line-425"></a>              <span class='hs-keyword'>in</span>
<a name="line-426"></a>                <span class='hs-comment'>-- pprTrace "ApplyEdges"</span>
<a name="line-427"></a>                <span class='hs-comment'>--  (text "before" $$</span>
<a name="line-428"></a>                <span class='hs-comment'>--   text "fronts" &lt;+&gt; ppr chainFronts $$</span>
<a name="line-429"></a>                <span class='hs-comment'>--   text "ends" &lt;+&gt; ppr chainEnds $$</span>
<a name="line-430"></a>
<a name="line-431"></a>                <span class='hs-comment'>--   text "various" $$</span>
<a name="line-432"></a>                <span class='hs-comment'>--   text "newChain" &lt;+&gt; ppr newChain $$</span>
<a name="line-433"></a>                <span class='hs-comment'>--   text "newChainFrontier" &lt;+&gt; ppr newChainFrontier $$</span>
<a name="line-434"></a>                <span class='hs-comment'>--   text "newChainEnds" &lt;+&gt; ppr newChainEnds $$</span>
<a name="line-435"></a>                <span class='hs-comment'>--   text "drop" &lt;+&gt; ppr ((c2_f ++ getFronts c1) ++ (c1_e ++ getEnds c2)) $$</span>
<a name="line-436"></a>
<a name="line-437"></a>                <span class='hs-comment'>--   text "after" $$</span>
<a name="line-438"></a>                <span class='hs-comment'>--   text "fronts" &lt;+&gt; ppr newFronts $$</span>
<a name="line-439"></a>                <span class='hs-comment'>--   text "ends" &lt;+&gt; ppr newEnds</span>
<a name="line-440"></a>                <span class='hs-comment'>--   )</span>
<a name="line-441"></a>                 <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>newEnds</span> <span class='hs-varid'>newFronts</span>
<a name="line-442"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-443"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-comment'>--pprTrace "noNeigbours" (ppr ()) $</span>
<a name="line-444"></a>              <span class='hs-varid'>applyEdges</span> <span class='hs-varid'>edges</span> <span class='hs-varid'>chainEnds</span> <span class='hs-varid'>chainFronts</span>
<a name="line-445"></a>         <span class='hs-keyword'>where</span>
<a name="line-446"></a>
<a name="line-447"></a>        <span class='hs-varid'>getFronts</span> <span class='hs-varid'>chain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeL</span> <span class='hs-varid'>neighbourOverlapp</span> <span class='hs-varid'>chain</span>
<a name="line-448"></a>        <span class='hs-varid'>getEnds</span> <span class='hs-varid'>chain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeR</span> <span class='hs-varid'>neighbourOverlapp</span> <span class='hs-varid'>chain</span>
<a name="line-449"></a>
<a name="line-450"></a>
<a name="line-451"></a>
<a name="line-452"></a><a name="buildChains"></a><span class='hs-comment'>-- See [Chain based CFG serialization]</span>
<a name="line-453"></a><span class='hs-definition'>buildChains</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CFG</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-454"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span>  <span class='hs-comment'>-- Resulting chains.</span>
<a name="line-455"></a>               <span class='hs-layout'>,</span> <span class='hs-conid'>Set.Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>--List of fused edges.</span>
<a name="line-456"></a><span class='hs-definition'>buildChains</span> <span class='hs-varid'>succWeights</span> <span class='hs-varid'>blocks</span>
<a name="line-457"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>fusedEdges</span><span class='hs-layout'>,</span> <span class='hs-varid'>chains</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildNext</span> <span class='hs-varid'>setEmpty</span> <span class='hs-varid'>mapEmpty</span> <span class='hs-varid'>blocks</span> <span class='hs-conid'>Set.empty</span>
<a name="line-458"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>chains</span><span class='hs-layout'>,</span> <span class='hs-varid'>fusedEdges</span><span class='hs-layout'>)</span>
<a name="line-459"></a>  <span class='hs-keyword'>where</span>
<a name="line-460"></a>    <span class='hs-comment'>-- We keep a map from the last block in a chain to the chain itself.</span>
<a name="line-461"></a>    <span class='hs-comment'>-- This we we can easily check if an block should be appened to an</span>
<a name="line-462"></a>    <span class='hs-comment'>-- existing chain!</span>
<a name="line-463"></a>    <span class='hs-varid'>buildNext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelSet</span>
<a name="line-464"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span> <span class='hs-comment'>-- Map from last element to chain.</span>
<a name="line-465"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Blocks to place</span>
<a name="line-466"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set.Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span>
<a name="line-467"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Placed Blocks</span>
<a name="line-468"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>Set.Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span> <span class='hs-comment'>--List of fused edges</span>
<a name="line-469"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span>
<a name="line-470"></a>                 <span class='hs-layout'>)</span>
<a name="line-471"></a>    <span class='hs-varid'>buildNext</span> <span class='hs-sel'>_placed</span> <span class='hs-varid'>chains</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>linked</span> <span class='hs-keyglyph'>=</span>
<a name="line-472"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>linked</span><span class='hs-layout'>,</span> <span class='hs-varid'>chains</span><span class='hs-layout'>)</span>
<a name="line-473"></a>    <span class='hs-varid'>buildNext</span> <span class='hs-varid'>placed</span> <span class='hs-varid'>chains</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-conop'>:</span><span class='hs-varid'>todo</span><span class='hs-layout'>)</span> <span class='hs-varid'>linked</span>
<a name="line-474"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>setMember</span> <span class='hs-varid'>block</span> <span class='hs-varid'>placed</span>
<a name="line-475"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildNext</span> <span class='hs-varid'>placed</span> <span class='hs-varid'>chains</span> <span class='hs-varid'>todo</span> <span class='hs-varid'>linked</span>
<a name="line-476"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-477"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildNext</span> <span class='hs-varid'>placed'</span> <span class='hs-varid'>chains'</span> <span class='hs-varid'>todo</span> <span class='hs-varid'>linked'</span>
<a name="line-478"></a>      <span class='hs-keyword'>where</span>
<a name="line-479"></a>        <span class='hs-varid'>placed'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>setInsert</span><span class='hs-layout'>)</span> <span class='hs-varid'>placed</span> <span class='hs-varid'>placedBlocks</span><span class='hs-layout'>)</span>
<a name="line-480"></a>        <span class='hs-varid'>linked'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Set.union</span> <span class='hs-varid'>linked</span> <span class='hs-varid'>linkedEdges</span>
<a name="line-481"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>placedBlocks</span><span class='hs-layout'>,</span> <span class='hs-varid'>chains'</span><span class='hs-layout'>,</span> <span class='hs-varid'>linkedEdges</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findChain</span> <span class='hs-varid'>block</span>
<a name="line-482"></a>
<a name="line-483"></a>        <span class='hs-comment'>--Add the block to a existing or new chain</span>
<a name="line-484"></a>        <span class='hs-comment'>--Returns placed blocks, list of resulting chains</span>
<a name="line-485"></a>        <span class='hs-comment'>--and fused edges</span>
<a name="line-486"></a>        <span class='hs-varid'>findChain</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span>
<a name="line-487"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>LabelMap</span> <span class='hs-conid'>BlockChain</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set.Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-488"></a>        <span class='hs-varid'>findChain</span> <span class='hs-varid'>block</span>
<a name="line-489"></a>        <span class='hs-comment'>-- B) place block at end of existing chain if</span>
<a name="line-490"></a>        <span class='hs-comment'>-- there is no better block to append.</span>
<a name="line-491"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>preds</span>
<a name="line-492"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>alreadyPlaced</span> <span class='hs-varid'>pred</span>
<a name="line-493"></a>          <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>predChain</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>chains</span>
<a name="line-494"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>best</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>alreadyPlaced</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getSuccs</span> <span class='hs-varid'>pred</span>
<a name="line-495"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>best</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lbl</span>
<a name="line-496"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>--pprTrace "B.2)" (ppr (pred,lbl)) $</span>
<a name="line-497"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>newChain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chainSnoc</span> <span class='hs-varid'>predChain</span> <span class='hs-varid'>block</span>
<a name="line-498"></a>                <span class='hs-varid'>chainMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>newChain</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapDelete</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>chains</span>
<a name="line-499"></a>            <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lbl</span><span class='hs-keyglyph'>]</span>
<a name="line-500"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>chainMap</span>
<a name="line-501"></a>                <span class='hs-layout'>,</span> <span class='hs-conid'>Set.singleton</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span><span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-502"></a>
<a name="line-503"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-504"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-comment'>--pprTrace "single" (ppr lbl)</span>
<a name="line-505"></a>            <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lbl</span><span class='hs-keyglyph'>]</span>
<a name="line-506"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>lbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>chainSingleton</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-varid'>chains</span>
<a name="line-507"></a>            <span class='hs-layout'>,</span> <span class='hs-conid'>Set.empty</span><span class='hs-layout'>)</span>
<a name="line-508"></a>            <span class='hs-keyword'>where</span>
<a name="line-509"></a>              <span class='hs-varid'>alreadyPlaced</span> <span class='hs-varid'>blkId</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>setMember</span> <span class='hs-varid'>blkId</span> <span class='hs-varid'>placed</span><span class='hs-layout'>)</span>
<a name="line-510"></a>              <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span>
<a name="line-511"></a>              <span class='hs-varid'>getSuccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getSuccEdgesSorted</span> <span class='hs-varid'>succWeights</span>
<a name="line-512"></a>              <span class='hs-varid'>preds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getSuccEdgesSorted</span> <span class='hs-varid'>predWeights</span> <span class='hs-varid'>lbl</span>
<a name="line-513"></a>    <span class='hs-comment'>--For efficiency we also create the map to look up predecessors here</span>
<a name="line-514"></a>    <span class='hs-varid'>predWeights</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverseEdges</span> <span class='hs-varid'>succWeights</span>
<a name="line-515"></a>
<a name="line-516"></a>
<a name="line-517"></a>
<a name="line-518"></a><a name="BlockNode"></a><span class='hs-comment'>-- We make the CFG a Hoopl Graph, so we can reuse revPostOrder.</span>
<a name="line-519"></a><a name="BlockNode"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>BlockNode</span> <span class='hs-varid'>e</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BN</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-520"></a><a name="instance%20NonLocal%20(BlockNode)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NonLocal</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockNode</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-521"></a>  <span class='hs-varid'>entryLabel</span> <span class='hs-layout'>(</span><span class='hs-conid'>BN</span> <span class='hs-layout'>(</span><span class='hs-varid'>lbl</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lbl</span>
<a name="line-522"></a>  <span class='hs-varid'>successors</span> <span class='hs-layout'>(</span><span class='hs-conid'>BN</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>succs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>succs</span>
<a name="line-523"></a>
<a name="line-524"></a><a name="fromNode"></a><span class='hs-definition'>fromNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockNode</span> <span class='hs-conid'>C</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>
<a name="line-525"></a><span class='hs-definition'>fromNode</span> <span class='hs-layout'>(</span><span class='hs-conid'>BN</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>x</span>
<a name="line-526"></a>
<a name="line-527"></a><a name="sequenceChain"></a><span class='hs-definition'>sequenceChain</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span> <span class='hs-varid'>i</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Instruction</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CFG</span>
<a name="line-528"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span>
<a name="line-529"></a><span class='hs-definition'>sequenceChain</span> <span class='hs-sel'>_info</span> <span class='hs-sel'>_weights</span>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-530"></a><span class='hs-definition'>sequenceChain</span> <span class='hs-sel'>_info</span> <span class='hs-sel'>_weights</span>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-531"></a><span class='hs-definition'>sequenceChain</span>  <span class='hs-varid'>info</span> <span class='hs-varid'>weights'</span>     <span class='hs-varid'>blocks</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>entry</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-532"></a>    <span class='hs-comment'>--Optimization, delete edges of weight &lt;= 0.</span>
<a name="line-533"></a>    <span class='hs-comment'>--This significantly improves performance whenever</span>
<a name="line-534"></a>    <span class='hs-comment'>--we iterate over all edges, which is a few times!</span>
<a name="line-535"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>weights</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CFG</span>
<a name="line-536"></a>        <span class='hs-varid'>weights</span>
<a name="line-537"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterEdges</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_f</span> <span class='hs-sel'>_t</span> <span class='hs-varid'>edgeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>edgeWeight</span> <span class='hs-varid'>edgeInfo</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varid'>weights'</span>
<a name="line-538"></a>        <span class='hs-varid'>blockMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-539"></a>        <span class='hs-varid'>blockMap</span>
<a name="line-540"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-varid'>blk</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>lbl</span> <span class='hs-sel'>_ins</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-541"></a>                        <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>blk</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-542"></a>                     <span class='hs-varid'>mapEmpty</span> <span class='hs-varid'>blocks</span>
<a name="line-543"></a>
<a name="line-544"></a>        <span class='hs-varid'>toNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockNode</span> <span class='hs-conid'>C</span> <span class='hs-conid'>C</span>
<a name="line-545"></a>        <span class='hs-varid'>toNode</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span>
<a name="line-546"></a>            <span class='hs-comment'>-- sorted such that heavier successors come first.</span>
<a name="line-547"></a>            <span class='hs-conid'>BN</span> <span class='hs-layout'>(</span><span class='hs-varid'>bid</span><span class='hs-layout'>,</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getSuccEdgesSorted</span> <span class='hs-varid'>weights'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span>
<a name="line-548"></a>
<a name="line-549"></a>        <span class='hs-varid'>orderedBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-550"></a>        <span class='hs-varid'>orderedBlocks</span>
<a name="line-551"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromNode</span> <span class='hs-varop'>$</span>
<a name="line-552"></a>              <span class='hs-varid'>revPostorderFrom</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>toNode</span> <span class='hs-varop'>.</span> <span class='hs-varid'>blockId</span><span class='hs-layout'>)</span> <span class='hs-varid'>blockMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>entry</span>
<a name="line-553"></a>
<a name="line-554"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>builtChains</span><span class='hs-layout'>,</span> <span class='hs-varid'>builtEdges</span><span class='hs-layout'>)</span>
<a name="line-555"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "buildChains" #-}</span>
<a name="line-556"></a>              <span class='hs-comment'>--pprTraceIt "generatedChains" $</span>
<a name="line-557"></a>              <span class='hs-comment'>--pprTrace "orderedBlocks" (ppr orderedBlocks) $</span>
<a name="line-558"></a>              <span class='hs-varid'>buildChains</span> <span class='hs-varid'>weights</span> <span class='hs-varid'>orderedBlocks</span>
<a name="line-559"></a>
<a name="line-560"></a>        <span class='hs-varid'>rankedEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WeightedEdgeList</span>
<a name="line-561"></a>        <span class='hs-comment'>-- Sort edges descending, remove fused eges</span>
<a name="line-562"></a>        <span class='hs-varid'>rankedEdges</span> <span class='hs-keyglyph'>=</span>
<a name="line-563"></a>            <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-layout'>,</span> <span class='hs-varid'>weight</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WeightedEdge</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-varid'>weight</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span>
<a name="line-564"></a>            <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-565"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set.member</span> <span class='hs-layout'>(</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span><span class='hs-varid'>to</span><span class='hs-layout'>)</span> <span class='hs-varid'>builtEdges</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span>
<a name="line-566"></a>            <span class='hs-varid'>sortWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>weightedEdgeList</span> <span class='hs-varid'>weights</span>
<a name="line-567"></a>
<a name="line-568"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>fusedChains</span><span class='hs-layout'>,</span> <span class='hs-varid'>fusedEdges</span><span class='hs-layout'>)</span>
<a name="line-569"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>noDups</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapElems</span> <span class='hs-varid'>builtChains</span><span class='hs-layout'>)</span>
<a name="line-570"></a>              <span class='hs-comment'>{-# SCC "fuseChains" #-}</span>
<a name="line-571"></a>              <span class='hs-comment'>--(pprTrace "RankedEdges" $ ppr rankedEdges) $</span>
<a name="line-572"></a>              <span class='hs-comment'>--pprTraceIt "FusedChains" $</span>
<a name="line-573"></a>              <span class='hs-varid'>fuseChains</span> <span class='hs-varid'>rankedEdges</span> <span class='hs-varid'>builtChains</span>
<a name="line-574"></a>
<a name="line-575"></a>        <span class='hs-varid'>rankedEdges'</span> <span class='hs-keyglyph'>=</span>
<a name="line-576"></a>            <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>edge</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Set.member</span> <span class='hs-varid'>edge</span> <span class='hs-varid'>fusedEdges</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rankedEdges</span>
<a name="line-577"></a>
<a name="line-578"></a>        <span class='hs-varid'>neighbourChains</span>
<a name="line-579"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>noDups</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapElems</span> <span class='hs-varid'>fusedChains</span><span class='hs-layout'>)</span>
<a name="line-580"></a>              <span class='hs-comment'>{-# SCC "groupNeighbourChains" #-}</span>
<a name="line-581"></a>              <span class='hs-comment'>--pprTraceIt "ResultChains" $</span>
<a name="line-582"></a>              <span class='hs-varid'>combineNeighbourhood</span> <span class='hs-varid'>rankedEdges'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapElems</span> <span class='hs-varid'>fusedChains</span><span class='hs-layout'>)</span>
<a name="line-583"></a>
<a name="line-584"></a>        <span class='hs-comment'>--Make sure the first block stays first</span>
<a name="line-585"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>entryChain</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-varid'>chains'</span><span class='hs-layout'>)</span>
<a name="line-586"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>noDups</span> <span class='hs-varop'>$</span> <span class='hs-varid'>neighbourChains</span><span class='hs-layout'>)</span>
<a name="line-587"></a>              <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>chainMember</span> <span class='hs-varid'>entry</span><span class='hs-layout'>)</span> <span class='hs-varid'>neighbourChains</span>
<a name="line-588"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>entryChain'</span><span class='hs-conop'>:</span><span class='hs-varid'>entryRest</span><span class='hs-layout'>)</span>
<a name="line-589"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inFront</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>entryChain</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>entryChain</span><span class='hs-keyglyph'>]</span>
<a name="line-590"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>rest</span><span class='hs-layout'>,</span><span class='hs-varid'>entry</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>breakChainAt</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>entryChain</span>
<a name="line-591"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>entry</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-keyglyph'>]</span>
<a name="line-592"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Entry point eliminated"</span> <span class='hs-varop'>$</span>
<a name="line-593"></a>                            <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>entryChain</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-varid'>chains'</span><span class='hs-layout'>)</span>
<a name="line-594"></a>
<a name="line-595"></a>        <span class='hs-varid'>prepedChains</span>
<a name="line-596"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryChain'</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-varid'>entryRest</span><span class='hs-varop'>++</span><span class='hs-varid'>chains'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockChain</span><span class='hs-keyglyph'>]</span>
<a name="line-597"></a>        <span class='hs-varid'>blockList</span>
<a name="line-598"></a>            <span class='hs-comment'>-- = (concatMap chainToBlocks prepedChains)</span>
<a name="line-599"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>seqToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>chainBlocks</span> <span class='hs-varid'>prepedChains</span><span class='hs-layout'>)</span>
<a name="line-600"></a>
<a name="line-601"></a>        <span class='hs-comment'>--chainPlaced = setFromList $ map blockId blockList :: LabelSet</span>
<a name="line-602"></a>        <span class='hs-varid'>chainPlaced</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setFromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>blockList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelSet</span>
<a name="line-603"></a>        <span class='hs-varid'>unplaced</span> <span class='hs-keyglyph'>=</span>
<a name="line-604"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapKeys</span> <span class='hs-varid'>blockMap</span>
<a name="line-605"></a>                <span class='hs-varid'>isPlaced</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setMember</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>chainPlaced</span>
<a name="line-606"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>block</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPlaced</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>blocks</span>
<a name="line-607"></a>
<a name="line-608"></a>        <span class='hs-varid'>placedBlocks</span> <span class='hs-keyglyph'>=</span>
<a name="line-609"></a>            <span class='hs-comment'>--pprTraceIt "placedBlocks" $</span>
<a name="line-610"></a>            <span class='hs-varid'>blockList</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unplaced</span>
<a name="line-611"></a>        <span class='hs-varid'>getBlock</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"Block placment"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>blockMap</span>
<a name="line-612"></a>    <span class='hs-keyword'>in</span>
<a name="line-613"></a>        <span class='hs-comment'>--Assert we placed all blocks given as input</span>
<a name="line-614"></a>        <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>bid</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapMember</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>blockMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>placedBlocks</span><span class='hs-layout'>)</span>
<a name="line-615"></a>        <span class='hs-varid'>dropJumps</span> <span class='hs-varid'>info</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getBlock</span> <span class='hs-varid'>placedBlocks</span>
<a name="line-616"></a>
<a name="line-617"></a><a name="dropJumps"></a><span class='hs-definition'>dropJumps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span> <span class='hs-varid'>i</span><span class='hs-varop'>.</span> <span class='hs-conid'>Instruction</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span>
<a name="line-618"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span>
<a name="line-619"></a><span class='hs-definition'>dropJumps</span> <span class='hs-keyword'>_</span>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-620"></a><span class='hs-definition'>dropJumps</span> <span class='hs-varid'>info</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>todo</span><span class='hs-layout'>)</span>
<a name="line-621"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ins</span> <span class='hs-comment'>--This can happen because of shortcutting</span>
<a name="line-622"></a>    <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dest</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>jumpDestsOfInstr</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span>
<a name="line-623"></a>    <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>nextLbl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>todo</span>
<a name="line-624"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapMember</span> <span class='hs-varid'>dest</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-625"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>nextLbl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dest</span>
<a name="line-626"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>lbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>init</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dropJumps</span> <span class='hs-varid'>info</span> <span class='hs-varid'>todo</span>
<a name="line-627"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-628"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>ins</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dropJumps</span> <span class='hs-varid'>info</span> <span class='hs-varid'>todo</span>
<a name="line-629"></a>
<a name="line-630"></a>
<a name="line-631"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-632"></a><span class='hs-comment'>-- Sequencing the basic blocks</span>
<a name="line-633"></a>
<a name="line-634"></a><span class='hs-comment'>-- Cmm BasicBlocks are self-contained entities: they always end in a</span>
<a name="line-635"></a><span class='hs-comment'>-- jump, either non-local or to another basic block in the same proc.</span>
<a name="line-636"></a><span class='hs-comment'>-- In this phase, we attempt to place the basic blocks in a sequence</span>
<a name="line-637"></a><span class='hs-comment'>-- such that as many of the local jumps as possible turn into</span>
<a name="line-638"></a><span class='hs-comment'>-- fallthroughs.</span>
<a name="line-639"></a>
<a name="line-640"></a><a name="sequenceTop"></a><span class='hs-definition'>sequenceTop</span>
<a name="line-641"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Instruction</span> <span class='hs-varid'>instr</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>instr</span><span class='hs-layout'>)</span>
<a name="line-642"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-comment'>-- Determine which layout algo to use</span>
<a name="line-643"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NcgImpl</span> <span class='hs-varid'>statics</span> <span class='hs-varid'>instr</span> <span class='hs-varid'>jumpDest</span>
<a name="line-644"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CFG</span> <span class='hs-comment'>-- ^ CFG if we have one.</span>
<a name="line-645"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatCmmDecl</span> <span class='hs-varid'>statics</span> <span class='hs-varid'>instr</span> <span class='hs-comment'>-- ^ Function to serialize</span>
<a name="line-646"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatCmmDecl</span> <span class='hs-varid'>statics</span> <span class='hs-varid'>instr</span>
<a name="line-647"></a>
<a name="line-648"></a><span class='hs-definition'>sequenceTop</span> <span class='hs-keyword'>_</span>     <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>           <span class='hs-varid'>top</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>top</span>
<a name="line-649"></a><span class='hs-definition'>sequenceTop</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ncgImpl</span> <span class='hs-varid'>edgeWeights</span>
<a name="line-650"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-651"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_CfgBlocklayout</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>backendMaintainsCfg</span> <span class='hs-varid'>dflags</span>
<a name="line-652"></a>  <span class='hs-comment'>--Use chain based algorithm</span>
<a name="line-653"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>edgeWeights</span>
<a name="line-654"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ListGraph</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ncgMakeFarBranches</span> <span class='hs-varid'>ncgImpl</span> <span class='hs-varid'>info</span> <span class='hs-varop'>$</span>
<a name="line-655"></a>                            <span class='hs-comment'>{-# SCC layoutBlocks #-}</span>
<a name="line-656"></a>                            <span class='hs-varid'>sequenceChain</span> <span class='hs-varid'>info</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>blocks</span> <span class='hs-layout'>)</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-658"></a>  <span class='hs-comment'>--Use old algorithm</span>
<a name="line-659"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dontUseCfg</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>edgeWeights</span>
<a name="line-660"></a>    <span class='hs-keyword'>in</span>  <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ListGraph</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ncgMakeFarBranches</span> <span class='hs-varid'>ncgImpl</span> <span class='hs-varid'>info</span> <span class='hs-varop'>$</span>
<a name="line-661"></a>                                <span class='hs-comment'>{-# SCC layoutBlocks #-}</span>
<a name="line-662"></a>                                <span class='hs-varid'>sequenceBlocks</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>info</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-663"></a>  <span class='hs-keyword'>where</span>
<a name="line-664"></a>    <span class='hs-varid'>dontUseCfg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WeightlessBlocklayout</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-665"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>backendMaintainsCfg</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-666"></a>
<a name="line-667"></a>
<a name="line-668"></a><span class='hs-comment'>-- The old algorithm:</span>
<a name="line-669"></a><span class='hs-comment'>-- It is very simple (and stupid): We make a graph out of</span>
<a name="line-670"></a><span class='hs-comment'>-- the blocks where there is an edge from one block to another iff the</span>
<a name="line-671"></a><span class='hs-comment'>-- first block ends by jumping to the second.  Then we topologically</span>
<a name="line-672"></a><span class='hs-comment'>-- sort this graph.  Then traverse the list: for each block, we first</span>
<a name="line-673"></a><span class='hs-comment'>-- output the block, then if it has an out edge, we move the</span>
<a name="line-674"></a><span class='hs-comment'>-- destination of the out edge to the front of the list, and continue.</span>
<a name="line-675"></a>
<a name="line-676"></a><span class='hs-comment'>-- FYI, the classic layout for basic blocks uses postorder DFS; this</span>
<a name="line-677"></a><span class='hs-comment'>-- algorithm is implemented in Hoopl.</span>
<a name="line-678"></a>
<a name="line-679"></a><a name="sequenceBlocks"></a><span class='hs-definition'>sequenceBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instruction</span> <span class='hs-varid'>inst</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CFG</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LabelMap</span> <span class='hs-varid'>a</span>
<a name="line-680"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>inst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>inst</span><span class='hs-keyglyph'>]</span>
<a name="line-681"></a><span class='hs-definition'>sequenceBlocks</span> <span class='hs-sel'>_edgeWeight</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-682"></a><span class='hs-definition'>sequenceBlocks</span> <span class='hs-varid'>edgeWeights</span> <span class='hs-varid'>infos</span> <span class='hs-layout'>(</span><span class='hs-varid'>entry</span><span class='hs-conop'>:</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-683"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>entryNode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNode</span> <span class='hs-varid'>edgeWeights</span> <span class='hs-varid'>entry</span>
<a name="line-684"></a>        <span class='hs-varid'>bodyNodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span>
<a name="line-685"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>flattenSCCs</span> <span class='hs-layout'>(</span><span class='hs-varid'>sccBlocks</span> <span class='hs-varid'>edgeWeights</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-686"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>dropJumps</span> <span class='hs-varid'>infos</span> <span class='hs-varop'>.</span> <span class='hs-varid'>seqBlocks</span> <span class='hs-varid'>infos</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span> <span class='hs-varid'>entryNode</span> <span class='hs-conop'>:</span> <span class='hs-varid'>bodyNodes</span><span class='hs-layout'>)</span>
<a name="line-687"></a>  <span class='hs-comment'>-- the first block is the entry point ==&gt; it must remain at the start.</span>
<a name="line-688"></a>
<a name="line-689"></a><a name="sccBlocks"></a><span class='hs-definition'>sccBlocks</span>
<a name="line-690"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instruction</span> <span class='hs-varid'>instr</span>
<a name="line-691"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CFG</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NatBasicBlock</span> <span class='hs-varid'>instr</span><span class='hs-keyglyph'>]</span>
<a name="line-692"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span> <span class='hs-conid'>BlockId</span> <span class='hs-layout'>(</span><span class='hs-conid'>NatBasicBlock</span> <span class='hs-varid'>instr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-693"></a><span class='hs-definition'>sccBlocks</span> <span class='hs-varid'>edgeWeights</span> <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>=</span>
<a name="line-694"></a>    <span class='hs-varid'>stronglyConnCompFromEdgedVerticesUniqR</span>
<a name="line-695"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNode</span> <span class='hs-varid'>edgeWeights</span><span class='hs-layout'>)</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-696"></a>
<a name="line-697"></a><a name="mkNode"></a><span class='hs-definition'>mkNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Instruction</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-698"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CFG</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>t</span>
<a name="line-699"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>BlockId</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-700"></a><span class='hs-definition'>mkNode</span> <span class='hs-varid'>edgeWeights</span> <span class='hs-varid'>block</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>instrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-701"></a>    <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>block</span> <span class='hs-varid'>id</span> <span class='hs-varid'>outEdges</span>
<a name="line-702"></a>  <span class='hs-keyword'>where</span>
<a name="line-703"></a>    <span class='hs-varid'>outEdges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-704"></a>    <span class='hs-varid'>outEdges</span>
<a name="line-705"></a>      <span class='hs-comment'>--Select the heaviest successor, ignore weights &lt;= zero</span>
<a name="line-706"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>successor</span>
<a name="line-707"></a>      <span class='hs-keyword'>where</span>
<a name="line-708"></a>        <span class='hs-varid'>successor</span>
<a name="line-709"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>successors</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varop'>`getSuccEdgesSorted`</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-710"></a>                                    <span class='hs-varid'>edgeWeights</span> <span class='hs-comment'>-- :: Maybe [(Label, EdgeInfo)]</span>
<a name="line-711"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>successors</span> <span class='hs-keyword'>of</span>
<a name="line-712"></a>            <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-713"></a>            <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>target</span><span class='hs-layout'>,</span><span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-714"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>successors</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>edgeWeight</span> <span class='hs-varid'>info</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-715"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>target</span><span class='hs-keyglyph'>]</span>
<a name="line-716"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-717"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>jumpDestsOfInstr</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>instrs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-718"></a>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>one</span><span class='hs-keyglyph'>]</span>
<a name="line-719"></a>                <span class='hs-sel'>_many</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-720"></a>
<a name="line-721"></a>
<a name="line-722"></a><a name="seqBlocks"></a><span class='hs-definition'>seqBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LabelMap</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span> <span class='hs-conid'>BlockId</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-723"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GenBasicBlock</span> <span class='hs-varid'>t1</span><span class='hs-keyglyph'>]</span>
<a name="line-724"></a><span class='hs-definition'>seqBlocks</span> <span class='hs-varid'>infos</span> <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable0</span> <span class='hs-varid'>todo0</span>
<a name="line-725"></a>  <span class='hs-keyword'>where</span>
<a name="line-726"></a>    <span class='hs-comment'>-- pullable: Blocks that are not yet placed</span>
<a name="line-727"></a>    <span class='hs-comment'>-- todo:     Original order of blocks, to be followed if we have no good</span>
<a name="line-728"></a>    <span class='hs-comment'>--           reason not to;</span>
<a name="line-729"></a>    <span class='hs-comment'>--           may include blocks that have already been placed, but then</span>
<a name="line-730"></a>    <span class='hs-comment'>--           these are not in pullable</span>
<a name="line-731"></a>    <span class='hs-varid'>pullable0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToUFM</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>b</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>blocks</span> <span class='hs-keyglyph'>]</span>
<a name="line-732"></a>    <span class='hs-varid'>todo0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>node_key</span> <span class='hs-varid'>blocks</span>
<a name="line-733"></a>
<a name="line-734"></a>    <span class='hs-varid'>placeNext</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-735"></a>    <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-736"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span> <span class='hs-varid'>pullable'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDeleteUFM</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>i</span>
<a name="line-737"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>place</span> <span class='hs-varid'>pullable'</span> <span class='hs-varid'>rest</span> <span class='hs-varid'>block</span>
<a name="line-738"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-739"></a>        <span class='hs-comment'>-- We already placed this block, so ignore</span>
<a name="line-740"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>rest</span>
<a name="line-741"></a>
<a name="line-742"></a>    <span class='hs-varid'>place</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>todo</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-743"></a>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>todo</span>
<a name="line-744"></a>    <span class='hs-varid'>place</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>todo</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>instrs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>next</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-745"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mapMember</span> <span class='hs-varid'>next</span> <span class='hs-varid'>infos</span>
<a name="line-746"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>todo</span>
<a name="line-747"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>nextBlock</span><span class='hs-layout'>,</span> <span class='hs-varid'>pullable'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDeleteUFM</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>next</span>
<a name="line-748"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>instrs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>place</span> <span class='hs-varid'>pullable'</span> <span class='hs-varid'>todo</span> <span class='hs-varid'>nextBlock</span>
<a name="line-749"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-750"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>placeNext</span> <span class='hs-varid'>pullable</span> <span class='hs-varid'>todo</span>
<a name="line-751"></a>    <span class='hs-varid'>place</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tooManyNextNodes</span><span class='hs-layout'>)</span>
<a name="line-752"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"seqBlocks"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tooManyNextNodes</span><span class='hs-layout'>)</span>
<a name="line-753"></a>
<a name="line-754"></a>
<a name="line-755"></a><a name="lookupDeleteUFM"></a><span class='hs-definition'>lookupDeleteUFM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UniqFM</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>key</span>
<a name="line-756"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>elt</span><span class='hs-layout'>,</span> <span class='hs-conid'>UniqFM</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span>
<a name="line-757"></a><span class='hs-definition'>lookupDeleteUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Maybe monad</span>
<a name="line-758"></a>    <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>k</span>
<a name="line-759"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-760"></a>
<a name="line-761"></a><span class='hs-comment'>-- -------------------------------------------------------------------</span>
<a name="line-762"></a><span class='hs-comment'>-- Some specialized data structures to speed things up:</span>
<a name="line-763"></a><span class='hs-comment'>--  * BlockSequence: A specialized version of Data.Sequence.</span>
<a name="line-764"></a><span class='hs-comment'>--    Better at indexing at the front/end but lacks ability</span>
<a name="line-765"></a><span class='hs-comment'>--    to do lookup by position.</span>
<a name="line-766"></a>
<a name="line-767"></a><a name="FrontierMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FrontierMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LabelMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>BlockChain</span><span class='hs-layout'>)</span>
<a name="line-768"></a>
<a name="line-769"></a><a name="BlockSequence"></a><span class='hs-comment'>-- | A "reverse zipper" of sorts.</span>
<a name="line-770"></a><a name="BlockSequence"></a><span class='hs-comment'>-- We store a list of blocks in two parts, the initial part from left to right</span>
<a name="line-771"></a><a name="BlockSequence"></a><span class='hs-comment'>-- and the remaining part stored in reverse order. This makes it easy to look</span>
<a name="line-772"></a><a name="BlockSequence"></a><span class='hs-comment'>-- the last/first element and append on both sides.</span>
<a name="line-773"></a><a name="BlockSequence"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>BlockSequence</span>
<a name="line-774"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Singleton</span> <span class='hs-varop'>!</span><span class='hs-conid'>BlockId</span>
<a name="line-775"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrdList</span> <span class='hs-conid'>BlockId</span><span class='hs-layout'>)</span>
<a name="line-776"></a>    <span class='hs-comment'>-- ^ For a non empty pair there is at least one element in the left part.</span>
<a name="line-777"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Empty</span>
<a name="line-778"></a>
<a name="line-779"></a><a name="seqFront"></a><span class='hs-definition'>seqFront</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span>
<a name="line-780"></a><span class='hs-definition'>seqFront</span> <span class='hs-conid'>Empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Empty sequence"</span>
<a name="line-781"></a><span class='hs-definition'>seqFront</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bid</span>
<a name="line-782"></a><span class='hs-definition'>seqFront</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"Seq invariant"</span> <span class='hs-varop'>$</span>
<a name="line-783"></a>    <span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>lefts</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reverseOL</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span>
<a name="line-784"></a>
<a name="line-785"></a><span class='hs-comment'>-- seqEnd :: BlockSequence -&gt; BlockId</span>
<a name="line-786"></a><span class='hs-comment'>-- seqEnd Empty = panic "Empty sequence"</span>
<a name="line-787"></a><span class='hs-comment'>-- seqEnd (Singleton bid) = bid</span>
<a name="line-788"></a><span class='hs-comment'>-- seqEnd (Pair lefts rights) = expectJust "Seq invariant" $</span>
<a name="line-789"></a><span class='hs-comment'>--     listToMaybe (fromOL rights) &lt;|&gt; listToMaybe (fromOL $ reverseOL lefts)</span>
<a name="line-790"></a>
<a name="line-791"></a><a name="seqToList"></a><span class='hs-definition'>seqToList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-792"></a><span class='hs-definition'>seqToList</span> <span class='hs-conid'>Empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-793"></a><span class='hs-definition'>seqToList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bid</span><span class='hs-keyglyph'>]</span>
<a name="line-794"></a><span class='hs-definition'>seqToList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromOL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lefts</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>reverseOL</span> <span class='hs-varid'>rights</span>
<a name="line-795"></a>
<a name="line-796"></a>
<a name="line-797"></a><a name="seqToRList"></a><span class='hs-definition'>seqToRList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span>
<a name="line-798"></a><span class='hs-definition'>seqToRList</span> <span class='hs-conid'>Empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-799"></a><span class='hs-definition'>seqToRList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bid</span><span class='hs-keyglyph'>]</span>
<a name="line-800"></a><span class='hs-definition'>seqToRList</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromOL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rights</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>reverseOL</span> <span class='hs-varid'>lefts</span>
<a name="line-801"></a>
<a name="line-802"></a><a name="seqSnoc"></a><span class='hs-definition'>seqSnoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockSequence</span>
<a name="line-803"></a><span class='hs-definition'>seqSnoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Empty</span><span class='hs-layout'>)</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Singleton</span> <span class='hs-varid'>bid</span>
<a name="line-804"></a><span class='hs-definition'>seqSnoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>bid</span><span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span>
<a name="line-805"></a><span class='hs-definition'>seqSnoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-layout'>(</span><span class='hs-varid'>bid</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span>
<a name="line-806"></a>
<a name="line-807"></a><a name="seqConcat"></a><span class='hs-definition'>seqConcat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockSequence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockSequence</span>
<a name="line-808"></a><span class='hs-definition'>seqConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Empty</span><span class='hs-layout'>)</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x2</span>
<a name="line-809"></a><span class='hs-definition'>seqConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-810"></a><span class='hs-definition'>seqConcat</span> <span class='hs-varid'>x1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Empty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x1</span>
<a name="line-811"></a><span class='hs-definition'>seqConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>lefts</span><span class='hs-layout'>)</span> <span class='hs-varid'>rights</span>
<a name="line-812"></a><span class='hs-definition'>seqConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Singleton</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts</span> <span class='hs-layout'>(</span><span class='hs-varid'>b2</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>rights</span><span class='hs-layout'>)</span>
<a name="line-813"></a><span class='hs-definition'>seqConcat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts1</span> <span class='hs-varid'>rights1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lefts2</span> <span class='hs-varid'>rights2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-814"></a>    <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>lefts1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverseOL</span> <span class='hs-varid'>rights1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>lefts2</span><span class='hs-layout'>)</span> <span class='hs-varid'>rights2</span>
<a name="line-815"></a>
<a name="line-816"></a><a name="seqFromBids"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockSequence</span>
<a name="line-817"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Empty</span>
<a name="line-818"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Singleton</span> <span class='hs-varid'>b1</span>
<a name="line-819"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b1</span><span class='hs-layout'>,</span><span class='hs-varid'>b2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>b1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span>
<a name="line-820"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b1</span><span class='hs-layout'>,</span><span class='hs-varid'>b2</span><span class='hs-layout'>,</span><span class='hs-varid'>b3</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>consOL</span> <span class='hs-varid'>b1</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitOL</span> <span class='hs-varid'>b2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-varid'>b3</span><span class='hs-layout'>)</span>
<a name="line-821"></a><span class='hs-definition'>seqFromBids</span> <span class='hs-layout'>(</span><span class='hs-varid'>b1</span><span class='hs-conop'>:</span><span class='hs-varid'>b2</span><span class='hs-conop'>:</span><span class='hs-varid'>b3</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b1</span><span class='hs-layout'>,</span><span class='hs-varid'>b2</span><span class='hs-layout'>,</span><span class='hs-varid'>b3</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
</pre></body>
</html>
