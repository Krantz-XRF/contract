<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcHsType.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>\section[TcMonoType]{Typechecking user-specified @MonoTypes@}
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE CPP, TupleSections, MultiWayIf, RankNTypes #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsType</span> <span class='hs-layout'>(</span>
<a name="line-13"></a>        <span class='hs-comment'>-- Type signatures</span>
<a name="line-14"></a>        <span class='hs-varid'>kcClassSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcClassSigType</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigWcType</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>tcHsPartialSigType</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>funsSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigCtxt</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>        <span class='hs-varid'>tcHsClsInstType</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDerivStrategy</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>tcHsTypeApp</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>bindImplicitTKBndrs_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Skol</span><span class='hs-layout'>,</span>
<a name="line-24"></a>            <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>bindExplicitTKBndrs_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Skol</span><span class='hs-layout'>,</span>
<a name="line-26"></a>            <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-conid'>ContextKind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>                <span class='hs-comment'>-- Type checking type and class decls</span>
<a name="line-30"></a>        <span class='hs-varid'>kcLookupTcTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindTyClTyVars</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>etaExpandAlgTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcbVisibilities</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>          <span class='hs-comment'>-- tyvars</span>
<a name="line-34"></a>        <span class='hs-varid'>zonkAndScopedSort</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-comment'>-- Kind-checking types</span>
<a name="line-37"></a>        <span class='hs-comment'>-- No kind generalisation, no checkValidType</span>
<a name="line-38"></a>        <span class='hs-varid'>kcLHsQTyVars</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>tcWildCardBinders</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>   <span class='hs-varid'>tcHsOpenType</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>tcHsLiftedTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>tcLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLHsTypeUnsaturated</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckLHsType</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>tcHsMbContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLHsPredType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferApps</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>failIfEmitsConstraints</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>solveEqualities</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- useful re-export</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-varid'>typeLevelMode</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindLevelMode</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-varid'>kindGeneralize</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkExpectedKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>RequireSaturation</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>reportFloatingKvs</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>        <span class='hs-comment'>-- Sort-checking kinds</span>
<a name="line-53"></a>        <span class='hs-varid'>tcLHsKindSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>badKindSig</span><span class='hs-layout'>,</span>
<a name="line-54"></a>
<a name="line-55"></a>        <span class='hs-comment'>-- Zonking and promoting</span>
<a name="line-56"></a>        <span class='hs-varid'>zonkPromoteType</span><span class='hs-layout'>,</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-59"></a>        <span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPatSig</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- Error messages</span>
<a name="line-62"></a>        <span class='hs-varid'>funAppCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTyConFlavCtxt</span>
<a name="line-63"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcPrelude</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span> <span class='hs-layout'>(</span> <span class='hs-varid'>reportAllUnsolved</span> <span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>tcInstTyBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstTyBinder</span> <span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCoRep</span><span class='hs-layout'>(</span> <span class='hs-conid'>TyCoBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoBinderArgFlag</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- Used in etaExpandAlgTyCon</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>(</span> <span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span> <span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span><span class='hs-layout'>(</span> <span class='hs-conid'>MsgDoc</span> <span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>wildCardName</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>WarningFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Opt_WarnPartialTypeSignatures</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-comment'>{-
<a name="line-116"></a>        ----------------------------
<a name="line-117"></a>                General notes
<a name="line-118"></a>        ----------------------------
<a name="line-119"></a>
<a name="line-120"></a>Unlike with expressions, type-checking types both does some checking and
<a name="line-121"></a>desugars at the same time. This is necessary because we often want to perform
<a name="line-122"></a>equality checks on the types right away, and it would be incredibly painful
<a name="line-123"></a>to do this on un-desugared types. Luckily, desugared types are close enough
<a name="line-124"></a>to HsTypes to make the error messages sane.
<a name="line-125"></a>
<a name="line-126"></a>During type-checking, we perform as little validity checking as possible.
<a name="line-127"></a>Generally, after type-checking, you will want to do validity checking, say
<a name="line-128"></a>with TcValidity.checkValidType.
<a name="line-129"></a>
<a name="line-130"></a>Validity checking
<a name="line-131"></a>~~~~~~~~~~~~~~~~~
<a name="line-132"></a>Some of the validity check could in principle be done by the kind checker,
<a name="line-133"></a>but not all:
<a name="line-134"></a>
<a name="line-135"></a>- During desugaring, we normalise by expanding type synonyms.  Only
<a name="line-136"></a>  after this step can we check things like type-synonym saturation
<a name="line-137"></a>  e.g.  type T k = k Int
<a name="line-138"></a>        type S a = a
<a name="line-139"></a>  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
<a name="line-140"></a>  and then S is saturated.  This is a GHC extension.
<a name="line-141"></a>
<a name="line-142"></a>- Similarly, also a GHC extension, we look through synonyms before complaining
<a name="line-143"></a>  about the form of a class or instance declaration
<a name="line-144"></a>
<a name="line-145"></a>- Ambiguity checks involve functional dependencies
<a name="line-146"></a>
<a name="line-147"></a>Also, in a mutually recursive group of types, we can't look at the TyCon until we've
<a name="line-148"></a>finished building the loop.  So to keep things simple, we postpone most validity
<a name="line-149"></a>checking until step (3).
<a name="line-150"></a>
<a name="line-151"></a>%************************************************************************
<a name="line-152"></a>%*                                                                      *
<a name="line-153"></a>              Check types AND do validity checking
<a name="line-154"></a>*                                                                      *
<a name="line-155"></a>************************************************************************
<a name="line-156"></a>-}</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="funsSigCtxt"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-159"></a><span class='hs-comment'>-- Returns FunSigCtxt, with no redundant-context-reporting,</span>
<a name="line-160"></a><span class='hs-comment'>-- form a list of located names</span>
<a name="line-161"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name1</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name1</span> <span class='hs-conid'>False</span>
<a name="line-162"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-conid'>[]</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"funSigCtxt"</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="addSigCtxt"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-165"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-167"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-168"></a>    <span class='hs-varid'>thing_inside</span>
<a name="line-169"></a>
<a name="line-170"></a><a name="pprSigCtxt"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-171"></a><span class='hs-comment'>-- (pprSigCtxt ctxt &lt;extra&gt; &lt;type&gt;)</span>
<a name="line-172"></a><span class='hs-comment'>-- prints    In the type signature for 'f':</span>
<a name="line-173"></a><span class='hs-comment'>--              f :: &lt;type&gt;</span>
<a name="line-174"></a><span class='hs-comment'>-- The &lt;extra&gt; is either empty or "the ambiguity check for"</span>
<a name="line-175"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isSigMaybe</span> <span class='hs-varid'>ctxt</span>
<a name="line-177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the type signature:"</span><span class='hs-layout'>)</span>
<a name="line-178"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-179"></a>
<a name="line-180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-182"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="tcHsSigWcType"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-185"></a><span class='hs-comment'>-- This one is used when we have a LHsSigWcType, but in</span>
<a name="line-186"></a><span class='hs-comment'>-- a place where wildcards aren't allowed. The renamer has</span>
<a name="line-187"></a><span class='hs-comment'>-- already checked this, so we can simply ignore it.</span>
<a name="line-188"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropWildCards</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="kcClassSigType"></a><span class='hs-definition'>kcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-191"></a><span class='hs-definition'>kcClassSigType</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span>
<a name="line-193"></a>    <span class='hs-varid'>tcClassSigType</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span>
<a name="line-194"></a>  <span class='hs-comment'>-- tcClassSigType does a fair amount of extra work that we don't need,</span>
<a name="line-195"></a>  <span class='hs-comment'>-- such as ordering quantified variables. But we absolutely do need</span>
<a name="line-196"></a>  <span class='hs-comment'>-- to push the level when checking method types and solve local equalities,</span>
<a name="line-197"></a>  <span class='hs-comment'>-- and so it seems easier just to call tcClassSigType than selectively</span>
<a name="line-198"></a>  <span class='hs-comment'>-- extract the lines of code from tc_hs_sig_type that we really need.</span>
<a name="line-199"></a>  <span class='hs-comment'>-- If we don't push the level, we get #16517, where GHC accepts</span>
<a name="line-200"></a>  <span class='hs-comment'>--   class C a where</span>
<a name="line-201"></a>  <span class='hs-comment'>--     meth :: forall k. Proxy (a :: k) -&gt; ()</span>
<a name="line-202"></a>  <span class='hs-comment'>-- Note that k is local to meth -- this is hogwash.</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="tcClassSigType"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-205"></a><span class='hs-comment'>-- Does not do validity checking</span>
<a name="line-206"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span>
<a name="line-207"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funsSigCtxt</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-208"></a>    <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tc_hs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>sig_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-209"></a>       <span class='hs-comment'>-- Do not zonk-to-Type, nor perform a validity check</span>
<a name="line-210"></a>       <span class='hs-comment'>-- We are in a knot with the class and associated types</span>
<a name="line-211"></a>       <span class='hs-comment'>-- Zonking and validity checking is done by tcClassDecl</span>
<a name="line-212"></a>       <span class='hs-comment'>-- No need to fail here if the type has an error:</span>
<a name="line-213"></a>       <span class='hs-comment'>--   If we're in the kind-checking phase, the solveEqualities</span>
<a name="line-214"></a>       <span class='hs-comment'>--     in kcTyClGroup catches the error</span>
<a name="line-215"></a>       <span class='hs-comment'>--   If we're in the type-checking phase, the solveEqualities</span>
<a name="line-216"></a>       <span class='hs-comment'>--     in tcClassDecl1 gets it</span>
<a name="line-217"></a>       <span class='hs-comment'>-- Failing fast here degrades the error message in, e.g., tcfail135:</span>
<a name="line-218"></a>       <span class='hs-comment'>--   class Foo f where</span>
<a name="line-219"></a>       <span class='hs-comment'>--     baa :: f a -&gt; f</span>
<a name="line-220"></a>       <span class='hs-comment'>-- If we fail fast, we're told that f has kind `k1` when we wanted `*`.</span>
<a name="line-221"></a>       <span class='hs-comment'>-- It should be that f has kind `k2 -&gt; *`, but we never get a chance</span>
<a name="line-222"></a>       <span class='hs-comment'>-- to run the solver where the kind of f is touchable. This is</span>
<a name="line-223"></a>       <span class='hs-comment'>-- painfully delicate.</span>
<a name="line-224"></a>
<a name="line-225"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-226"></a><span class='hs-comment'>-- Does validity checking</span>
<a name="line-227"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature]</span>
<a name="line-228"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-230"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsSigType {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-231"></a>
<a name="line-232"></a>          <span class='hs-comment'>-- Generalise here: see Note [Kind generalisation]</span>
<a name="line-233"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>insol</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>sig_ty</span>
<a name="line-234"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-235"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-236"></a>
<a name="line-237"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>insol</span> <span class='hs-varid'>failM</span>
<a name="line-238"></a>       <span class='hs-comment'>-- See Note [Fail fast if there are insoluble kind equalities] in TcSimplify</span>
<a name="line-239"></a>
<a name="line-240"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-241"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"end tcHsSigType }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-242"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-243"></a>  <span class='hs-keyword'>where</span>
<a name="line-244"></a>    <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTypeSkol</span> <span class='hs-varid'>ctxt</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="tc_hs_sig_type"></a><span class='hs-definition'>tc_hs_sig_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-247"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-248"></a><span class='hs-comment'>-- Kind-checks/desugars an 'LHsSigType',</span>
<a name="line-249"></a><span class='hs-comment'>--   solve equalities,</span>
<a name="line-250"></a><span class='hs-comment'>--   and then kind-generalizes.</span>
<a name="line-251"></a><span class='hs-comment'>-- This will never emit constraints, as it uses solveEqualities interally.</span>
<a name="line-252"></a><span class='hs-comment'>-- No validity checking or zonking</span>
<a name="line-253"></a><span class='hs-comment'>-- Returns also a Bool indicating whether the type induced an insoluble constraint;</span>
<a name="line-254"></a><span class='hs-comment'>-- True &lt;=&gt; constraint is insoluble</span>
<a name="line-255"></a><span class='hs-definition'>tc_hs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>hs_sig_type</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hs_sig_type</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lvl</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_tkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-258"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushTcLevelM</span>                           <span class='hs-varop'>$</span>
<a name="line-259"></a>                 <span class='hs-varid'>solveLocalEqualitiesX</span> <span class='hs-str'>"tc_hs_sig_type"</span> <span class='hs-varop'>$</span>
<a name="line-260"></a>                 <span class='hs-varid'>bindImplicitTKBndrs_Skol</span> <span class='hs-varid'>sig_vars</span>      <span class='hs-varop'>$</span>
<a name="line-261"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-262"></a>
<a name="line-263"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-264"></a>       <span class='hs-comment'>-- Any remaining variables (unsolved in the solveLocalEqualities)</span>
<a name="line-265"></a>       <span class='hs-comment'>-- should be in the global tyvars, and therefore won't be quantified</span>
<a name="line-266"></a>
<a name="line-267"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-268"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-varid'>ty</span>
<a name="line-269"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeLocal</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>ty1</span>
<a name="line-270"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>spec_tkvs</span><span class='hs-layout'>)</span>
<a name="line-271"></a>                                  <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>wanted</span>
<a name="line-272"></a>
<a name="line-273"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInvForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-274"></a>
<a name="line-275"></a><span class='hs-definition'>tc_hs_sig_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsImplicitBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_sig_type"</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="tcTopLHsType"></a><span class='hs-definition'>tcTopLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-278"></a><span class='hs-comment'>-- tcTopLHsType is used for kind-checking top-level HsType where</span>
<a name="line-279"></a><span class='hs-comment'>--   we want to fully solve /all/ equalities, and report errors</span>
<a name="line-280"></a><span class='hs-comment'>-- Does zonking, but not validity checking because it's used</span>
<a name="line-281"></a><span class='hs-comment'>--   for things (like deriving and instances) that aren't</span>
<a name="line-282"></a><span class='hs-comment'>--   ordinary types</span>
<a name="line-283"></a><span class='hs-definition'>tcTopLHsType</span> <span class='hs-varid'>hs_sig_type</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-284"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hs_sig_type</span>
<a name="line-285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTopLHsType {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-286"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_tkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-287"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushTcLevelM_</span>                     <span class='hs-varop'>$</span>
<a name="line-288"></a>                 <span class='hs-varid'>solveEqualities</span>                   <span class='hs-varop'>$</span>
<a name="line-289"></a>                 <span class='hs-varid'>bindImplicitTKBndrs_Skol</span> <span class='hs-varid'>sig_vars</span> <span class='hs-varop'>$</span>
<a name="line-290"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-291"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-292"></a>
<a name="line-293"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-294"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-varid'>ty</span>
<a name="line-295"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>ty1</span>
<a name="line-296"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInvForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-297"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End tcTopLHsType }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-298"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>final_ty</span><span class='hs-layout'>}</span>
<a name="line-299"></a>
<a name="line-300"></a><span class='hs-definition'>tcTopLHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsImplicitBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcTopLHsType"</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-----------------</span>
<a name="line-303"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-304"></a><span class='hs-comment'>-- Like tcHsSigType, but for the ...deriving( C t1 ty2 ) clause</span>
<a name="line-305"></a><span class='hs-comment'>-- Returns the C, [ty1, ty2, and the kinds of C's remaining arguments</span>
<a name="line-306"></a><span class='hs-comment'>-- E.g.    class C (a::*) (b::k-&gt;k)</span>
<a name="line-307"></a><span class='hs-comment'>--         data T a b = ... deriving( C Int )</span>
<a name="line-308"></a><span class='hs-comment'>--    returns ([k], C, [k, Int], [k-&gt;k])</span>
<a name="line-309"></a><span class='hs-comment'>-- Return values are fully zonked</span>
<a name="line-310"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-varid'>hs_ty</span>
<a name="line-311"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Avoid redundant error report</span>
<a name="line-312"></a>                              <span class='hs-comment'>-- with "illegal deriving", below</span>
<a name="line-313"></a>               <span class='hs-varid'>tcTopLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-conid'>AnyKind</span>
<a name="line-314"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-315"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>kind_args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-316"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-317"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-318"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal deriving item"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-319"></a>
<a name="line-320"></a><a name="tcDerivStrategy"></a><span class='hs-comment'>-- | Typecheck something within the context of a deriving strategy.</span>
<a name="line-321"></a><span class='hs-comment'>-- This is of particular importance when the deriving strategy is @via@.</span>
<a name="line-322"></a><span class='hs-comment'>-- For instance:</span>
<a name="line-323"></a><span class='hs-comment'>--</span>
<a name="line-324"></a><span class='hs-comment'>-- @</span>
<a name="line-325"></a><span class='hs-comment'>-- deriving via (S a) instance C (T a)</span>
<a name="line-326"></a><span class='hs-comment'>-- @</span>
<a name="line-327"></a><span class='hs-comment'>--</span>
<a name="line-328"></a><span class='hs-comment'>-- We need to typecheck @S a@, and moreover, we need to extend the tyvar</span>
<a name="line-329"></a><span class='hs-comment'>-- environment with @a@ before typechecking @C (T a)@, since @S a@ quantified</span>
<a name="line-330"></a><span class='hs-comment'>-- the type variable @a@.</span>
<a name="line-331"></a><span class='hs-definition'>tcDerivStrategy</span>
<a name="line-332"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span>
<a name="line-333"></a>     <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ The deriving strategy</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ The thing to typecheck within the context of the</span>
<a name="line-335"></a>                      <span class='hs-comment'>-- deriving strategy, which might quantify some type</span>
<a name="line-336"></a>                      <span class='hs-comment'>-- variables of its own.</span>
<a name="line-337"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-338"></a>     <span class='hs-comment'>-- ^ The typechecked deriving strategy, all quantified tyvars, and</span>
<a name="line-339"></a>     <span class='hs-comment'>-- the payload of the typechecked thing.</span>
<a name="line-340"></a><span class='hs-definition'>tcDerivStrategy</span> <span class='hs-varid'>mds</span> <span class='hs-varid'>thing_inside</span>
<a name="line-341"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mds</span> <span class='hs-keyword'>of</span>
<a name="line-342"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>boring_case</span> <span class='hs-conid'>Nothing</span>
<a name="line-343"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-varid'>ds</span>
<a name="line-344"></a>                    <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-345"></a>  <span class='hs-keyword'>where</span>
<a name="line-346"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcRn</span>
<a name="line-347"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-348"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-conid'>StockStrategy</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-conid'>StockStrategy</span>
<a name="line-349"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-conid'>AnyclassStrategy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-conid'>AnyclassStrategy</span>
<a name="line-350"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-conid'>NewtypeStrategy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-conid'>NewtypeStrategy</span>
<a name="line-351"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViaStrategy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-352"></a>      <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-353"></a>             <span class='hs-varid'>tcTopLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>AnyKind</span>
<a name="line-354"></a>      <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>via_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>via_pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty'</span>
<a name="line-355"></a>      <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>via_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-356"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>thing_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-357"></a>        <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViaStrategy</span> <span class='hs-varid'>via_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>via_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>thing_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-358"></a>
<a name="line-359"></a>    <span class='hs-varid'>boring_case</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>mds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mds</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-360"></a>    <span class='hs-varid'>boring_case</span> <span class='hs-varid'>mds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-361"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>thing_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-362"></a>      <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>mds</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-363"></a>
<a name="line-364"></a><a name="tcHsClsInstType"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>    <span class='hs-comment'>-- InstDeclCtxt or SpecInstCtxt</span>
<a name="line-365"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-366"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-367"></a><span class='hs-comment'>-- Like tcHsSigType, but for a class instance declaration</span>
<a name="line-368"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span>
<a name="line-369"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSigType</span> <span class='hs-varid'>hs_inst_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-370"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Fail eagerly if tcTopLHsType fails.  We are at top level so</span>
<a name="line-371"></a>         <span class='hs-comment'>-- these constraints will never be solved later. And failing</span>
<a name="line-372"></a>         <span class='hs-comment'>-- eagerly avoids follow-on errors when checkValidInstance</span>
<a name="line-373"></a>         <span class='hs-comment'>-- sees an unsolved coercion hole</span>
<a name="line-374"></a>         <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-375"></a>                    <span class='hs-varid'>tcTopLHsType</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>TheKind</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-376"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-varid'>inst_ty</span>
<a name="line-377"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>inst_ty</span> <span class='hs-layout'>}</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="tcHsTypeApp"></a><span class='hs-comment'>----------------------------------------------</span>
<a name="line-380"></a><span class='hs-comment'>-- | Type-check a visible type application</span>
<a name="line-381"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-382"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature] in TcHsType</span>
<a name="line-383"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-varid'>wc_ty</span> <span class='hs-varid'>kind</span>
<a name="line-384"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wc_ty</span>
<a name="line-385"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveLocalEqualities</span> <span class='hs-str'>"tcHsTypeApp"</span> <span class='hs-varop'>$</span>
<a name="line-386"></a>               <span class='hs-comment'>-- We are looking at a user-written type, very like a</span>
<a name="line-387"></a>               <span class='hs-comment'>-- signature so we want to solve its equalities right now</span>
<a name="line-388"></a>               <span class='hs-varid'>unsetWOptM</span> <span class='hs-conid'>Opt_WarnPartialTypeSignatures</span> <span class='hs-varop'>$</span>
<a name="line-389"></a>               <span class='hs-varid'>setXOptM</span> <span class='hs-conid'>LangExt.PartialTypeSignatures</span> <span class='hs-varop'>$</span>
<a name="line-390"></a>               <span class='hs-comment'>-- See Note [Wildcards in visible type application]</span>
<a name="line-391"></a>               <span class='hs-varid'>tcWildCardBinders</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-392"></a>               <span class='hs-varid'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-393"></a>       <span class='hs-comment'>-- We must promote here. Ex:</span>
<a name="line-394"></a>       <span class='hs-comment'>--   f :: forall a. a</span>
<a name="line-395"></a>       <span class='hs-comment'>--   g = f @(forall b. Proxy b -&gt; ()) @Int ...</span>
<a name="line-396"></a>       <span class='hs-comment'>-- After when processing the @Int, we'll have to check its kind</span>
<a name="line-397"></a>       <span class='hs-comment'>-- against the as-yet-unknown kind of b. This check causes an assertion</span>
<a name="line-398"></a>       <span class='hs-comment'>-- failure if we don't promote.</span>
<a name="line-399"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPromoteType</span> <span class='hs-varid'>ty</span>
<a name="line-400"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-conid'>TypeAppCtxt</span> <span class='hs-varid'>ty</span>
<a name="line-401"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-402"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsWildCardBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsTypeApp"</span>
<a name="line-403"></a>
<a name="line-404"></a><span class='hs-comment'>{- Note [Wildcards in visible type application]
<a name="line-405"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-406"></a>
<a name="line-407"></a>A HsWildCardBndrs's hswc_ext now only includes named wildcards, so any unnamed
<a name="line-408"></a>wildcards stay unchanged in hswc_body and when called in tcHsTypeApp, tcCheckLHsType
<a name="line-409"></a>will call emitWildCardHoleConstraints on them. However, this would trigger
<a name="line-410"></a>error/warning when an unnamed wildcard is passed in as a visible type argument,
<a name="line-411"></a>which we do not want because users should be able to write @_ to skip a instantiating
<a name="line-412"></a>a type variable variable without fuss. The solution is to switch the
<a name="line-413"></a>PartialTypeSignatures flags here to let the typechecker know that it's checking
<a name="line-414"></a>a '@_' and do not emit hole constraints on it.
<a name="line-415"></a>See related Note [Wildcards in visible kind application]
<a name="line-416"></a>and Note [The wildcard story for types] in HsTypes.hs
<a name="line-417"></a>
<a name="line-418"></a>-}</span>
<a name="line-419"></a>
<a name="line-420"></a><span class='hs-comment'>{-
<a name="line-421"></a>************************************************************************
<a name="line-422"></a>*                                                                      *
<a name="line-423"></a>            The main kind checker: no validity checks here
<a name="line-424"></a>*                                                                      *
<a name="line-425"></a>************************************************************************
<a name="line-426"></a>
<a name="line-427"></a>        First a couple of simple wrappers for kcHsType
<a name="line-428"></a>-}</span>
<a name="line-429"></a>
<a name="line-430"></a><a name="tcHsOpenType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-431"></a><span class='hs-definition'>tcHsOpenType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>
<a name="line-432"></a>  <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-433"></a><span class='hs-comment'>-- Used for type signatures</span>
<a name="line-434"></a><span class='hs-comment'>-- Do not do validity checking</span>
<a name="line-435"></a><span class='hs-definition'>tcHsOpenType</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsOpenTypeNC</span> <span class='hs-varid'>ty</span>
<a name="line-436"></a><a name="tcHsLiftedType"></a><span class='hs-definition'>tcHsLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-varid'>ty</span>
<a name="line-437"></a>
<a name="line-438"></a><a name="tcHsOpenTypeNC"></a><span class='hs-definition'>tcHsOpenTypeNC</span>   <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-439"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-440"></a><a name="tcHsLiftedTypeNC"></a><span class='hs-definition'>tcHsLiftedTypeNC</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="tcCheckLHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-443"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-444"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-445"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-446"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-447"></a>
<a name="line-448"></a><a name="tcLHsType"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-449"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-450"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="tcLHsTypeUnsaturated"></a><span class='hs-comment'>-- Like tcLHsType, but use it in a context where type synonyms and type families</span>
<a name="line-453"></a><span class='hs-comment'>-- do not need to be saturated, like in a GHCi :kind call</span>
<a name="line-454"></a><span class='hs-definition'>tcLHsTypeUnsaturated</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-455"></a><span class='hs-definition'>tcLHsTypeUnsaturated</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-456"></a>  <span class='hs-keyword'>where</span>
<a name="line-457"></a>    <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allowUnsaturated</span> <span class='hs-varid'>typeLevelMode</span>
<a name="line-458"></a>
<a name="line-459"></a><span class='hs-comment'>{-
<a name="line-460"></a>************************************************************************
<a name="line-461"></a>*                                                                      *
<a name="line-462"></a>      Type-checking modes
<a name="line-463"></a>*                                                                      *
<a name="line-464"></a>************************************************************************
<a name="line-465"></a>
<a name="line-466"></a>The kind-checker is parameterised by a TcTyMode, which contains some
<a name="line-467"></a>information about where we're checking a type.
<a name="line-468"></a>
<a name="line-469"></a>The renamer issues errors about what it can. All errors issued here must
<a name="line-470"></a>concern things that the renamer can't handle.
<a name="line-471"></a>
<a name="line-472"></a>-}</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="RequireSaturation"></a><span class='hs-comment'>-- | Do we require type families to be saturated?</span>
<a name="line-475"></a><a name="RequireSaturation"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RequireSaturation</span>
<a name="line-476"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>YesSaturation</span>
<a name="line-477"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoSaturation</span>   <span class='hs-comment'>-- e.g. during a call to GHCi's :kind</span>
<a name="line-478"></a>
<a name="line-479"></a><a name="TcTyMode"></a><span class='hs-comment'>-- | Info about the context in which we're checking a type. Currently,</span>
<a name="line-480"></a><a name="TcTyMode"></a><span class='hs-comment'>-- differentiates only between types and kinds, but this will likely</span>
<a name="line-481"></a><a name="TcTyMode"></a><span class='hs-comment'>-- grow, at least to include the distinction between patterns and</span>
<a name="line-482"></a><a name="TcTyMode"></a><span class='hs-comment'>-- not-patterns.</span>
<a name="line-483"></a><a name="TcTyMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-484"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-485"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>mode_sat</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RequireSaturation</span>
<a name="line-486"></a>             <span class='hs-layout'>}</span>
<a name="line-487"></a> <span class='hs-comment'>-- The mode_unsat field is solely so that type families/synonyms can be unsaturated</span>
<a name="line-488"></a> <span class='hs-comment'>-- in GHCi :kind calls</span>
<a name="line-489"></a>
<a name="line-490"></a><a name="typeLevelMode"></a><span class='hs-definition'>typeLevelMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-491"></a><span class='hs-definition'>typeLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>YesSaturation</span> <span class='hs-layout'>}</span>
<a name="line-492"></a>
<a name="line-493"></a><a name="kindLevelMode"></a><span class='hs-definition'>kindLevelMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-494"></a><span class='hs-definition'>kindLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>YesSaturation</span> <span class='hs-layout'>}</span>
<a name="line-495"></a>
<a name="line-496"></a><a name="allowUnsaturated"></a><span class='hs-definition'>allowUnsaturated</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-497"></a><span class='hs-definition'>allowUnsaturated</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoSaturation</span> <span class='hs-layout'>}</span>
<a name="line-498"></a>
<a name="line-499"></a><a name="kindLevel"></a><span class='hs-comment'>-- switch to kind level</span>
<a name="line-500"></a><span class='hs-definition'>kindLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-501"></a><span class='hs-definition'>kindLevel</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_level</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>}</span>
<a name="line-502"></a>
<a name="line-503"></a><a name="instance%20Outputable%20RequireSaturation"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>RequireSaturation</span> <span class='hs-keyword'>where</span>
<a name="line-504"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>YesSaturation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"YesSaturation"</span>
<a name="line-505"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoSaturation</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoSaturation"</span>
<a name="line-506"></a>
<a name="line-507"></a><a name="instance%20Outputable%20TcTyMode"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyword'>where</span>
<a name="line-508"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mode_level</span>
<a name="line-509"></a>
<a name="line-510"></a><span class='hs-comment'>{-
<a name="line-511"></a>Note [Bidirectional type checking]
<a name="line-512"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-513"></a>In expressions, whenever we see a polymorphic identifier, say `id`, we are
<a name="line-514"></a>free to instantiate it with metavariables, knowing that we can always
<a name="line-515"></a>re-generalize with type-lambdas when necessary. For example:
<a name="line-516"></a>
<a name="line-517"></a>  rank2 :: (forall a. a -&gt; a) -&gt; ()
<a name="line-518"></a>  x = rank2 id
<a name="line-519"></a>
<a name="line-520"></a>When checking the body of `x`, we can instantiate `id` with a metavariable.
<a name="line-521"></a>Then, when we're checking the application of `rank2`, we notice that we really
<a name="line-522"></a>need a polymorphic `id`, and then re-generalize over the unconstrained
<a name="line-523"></a>metavariable.
<a name="line-524"></a>
<a name="line-525"></a>In types, however, we're not so lucky, because *we cannot re-generalize*!
<a name="line-526"></a>There is no lambda. So, we must be careful only to instantiate at the last
<a name="line-527"></a>possible moment, when we're sure we're never going to want the lost polymorphism
<a name="line-528"></a>again. This is done in calls to tcInstTyBinders.
<a name="line-529"></a>
<a name="line-530"></a>To implement this behavior, we use bidirectional type checking, where we
<a name="line-531"></a>explicitly think about whether we know the kind of the type we're checking
<a name="line-532"></a>or not. Note that there is a difference between not knowing a kind and
<a name="line-533"></a>knowing a metavariable kind: the metavariables are TauTvs, and cannot become
<a name="line-534"></a>forall-quantified kinds. Previously (before dependent types), there were
<a name="line-535"></a>no higher-rank kinds, and so we could instantiate early and be sure that
<a name="line-536"></a>no types would have polymorphic kinds, and so we could always assume that
<a name="line-537"></a>the kind of a type was a fresh metavariable. Not so anymore, thus the
<a name="line-538"></a>need for two algorithms.
<a name="line-539"></a>
<a name="line-540"></a>For HsType forms that can never be kind-polymorphic, we implement only the
<a name="line-541"></a>"down" direction, where we safely assume a metavariable kind. For HsType forms
<a name="line-542"></a>that *can* be kind-polymorphic, we implement just the "up" (functions with
<a name="line-543"></a>"infer" in their name) version, as we gain nothing by also implementing the
<a name="line-544"></a>"down" version.
<a name="line-545"></a>
<a name="line-546"></a>Note [Future-proofing the type checker]
<a name="line-547"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-548"></a>As discussed in Note [Bidirectional type checking], each HsType form is
<a name="line-549"></a>handled in *either* tc_infer_hs_type *or* tc_hs_type. These functions
<a name="line-550"></a>are mutually recursive, so that either one can work for any type former.
<a name="line-551"></a>But, we want to make sure that our pattern-matches are complete. So,
<a name="line-552"></a>we have a bunch of repetitive code just so that we get warnings if we're
<a name="line-553"></a>missing any patterns.
<a name="line-554"></a>
<a name="line-555"></a>Note [The tcType invariant]
<a name="line-556"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-557"></a>(IT1) If    tc_ty = tc_hs_type hs_ty exp_kind
<a name="line-558"></a>      then  tcTypeKind tc_ty = exp_kind
<a name="line-559"></a>without any zonking needed.  The reason for this is that in
<a name="line-560"></a>tcInferApps we see (F ty), and we kind-check 'ty' with an
<a name="line-561"></a>expected-kind coming from F.  Then, to make the resulting application
<a name="line-562"></a>well kinded --- see Note [The well-kinded type invariant] in TcType ---
<a name="line-563"></a>we need the kind-checked 'ty' to have exactly the kind that F expects,
<a name="line-564"></a>with no funny zonking nonsense in between.
<a name="line-565"></a>
<a name="line-566"></a>The tcType invariant also applies to checkExpectedKind:
<a name="line-567"></a>
<a name="line-568"></a>(IT2) if
<a name="line-569"></a>        (tc_ty, _, _) = checkExpectedKind ty act_ki exp_ki
<a name="line-570"></a>      then
<a name="line-571"></a>        tcTypeKind tc_ty = exp_ki
<a name="line-572"></a>
<a name="line-573"></a>These other invariants are all necessary, too, as these functions
<a name="line-574"></a>are used within tc_hs_type:
<a name="line-575"></a>
<a name="line-576"></a>(IT3) If (ty, ki) &lt;- tc_infer_hs_type ..., then tcTypeKind ty == ki.
<a name="line-577"></a>
<a name="line-578"></a>(IT4) If (ty, ki) &lt;- tc_infer_hs_type ..., then zonk ki == ki.
<a name="line-579"></a>      (In other words, the result kind of tc_infer_hs_type is zonked.)
<a name="line-580"></a>
<a name="line-581"></a>(IT5) If (ty, ki) &lt;- tcTyVar ..., then tcTypeKind ty == ki.
<a name="line-582"></a>
<a name="line-583"></a>(IT6) If (ty, ki) &lt;- tcTyVar ..., then zonk ki == ki.
<a name="line-584"></a>      (In other words, the result kind of tcTyVar is zonked.)
<a name="line-585"></a>
<a name="line-586"></a>-}</span>
<a name="line-587"></a>
<a name="line-588"></a><a name="tc_infer_lhs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-589"></a><span class='hs-comment'>-- | Check and desugar a type, returning the core type and its</span>
<a name="line-590"></a><span class='hs-comment'>-- possibly-polymorphic kind. Much like 'tcInferRho' at the expression</span>
<a name="line-591"></a><span class='hs-comment'>-- level.</span>
<a name="line-592"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-593"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-594"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-595"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-596"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-597"></a>
<a name="line-598"></a><a name="tc_infer_hs_type"></a><span class='hs-comment'>-- | Infer the kind of a type and desugar. This is the "up" type-checker,</span>
<a name="line-599"></a><span class='hs-comment'>-- as described in Note [Bidirectional type checking]</span>
<a name="line-600"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-601"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span>
<a name="line-602"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tv</span>
<a name="line-603"></a>
<a name="line-604"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyApp</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>e</span>
<a name="line-605"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppKindTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyApp</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>e</span>
<a name="line-606"></a>
<a name="line-607"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>lhs_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-608"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>)</span>
<a name="line-609"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_op</span>
<a name="line-610"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>noExt</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-varid'>lhs_op</span><span class='hs-layout'>)</span> <span class='hs-varid'>op</span> <span class='hs-varid'>op_kind</span>
<a name="line-611"></a>                       <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsValArg</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValArg</span> <span class='hs-varid'>rhs</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-612"></a>
<a name="line-613"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-614"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-conid'>KindSigCtxt</span> <span class='hs-varid'>sig</span>
<a name="line-615"></a>                 <span class='hs-comment'>-- We must typecheck the kind signature, and solve all</span>
<a name="line-616"></a>                 <span class='hs-comment'>-- its equalities etc; from this point on we may do</span>
<a name="line-617"></a>                 <span class='hs-comment'>-- things like instantiate its foralls, so it needs</span>
<a name="line-618"></a>                 <span class='hs-comment'>-- to be fully determined (Trac #14904)</span>
<a name="line-619"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_infer_hs_type:sig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig'</span><span class='hs-layout'>)</span>
<a name="line-620"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig'</span>
<a name="line-621"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-622"></a>
<a name="line-623"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType' to communicate</span>
<a name="line-624"></a><span class='hs-comment'>-- the splice location to the typechecker. Here we skip over it in order to have</span>
<a name="line-625"></a><span class='hs-comment'>-- the same kind inferred for a given expression whether it was produced from</span>
<a name="line-626"></a><span class='hs-comment'>-- splices or not.</span>
<a name="line-627"></a><span class='hs-comment'>--</span>
<a name="line-628"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-629"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-631"></a>
<a name="line-632"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-633"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyword'>_</span>    <span class='hs-layout'>(</span><span class='hs-conid'>XHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>NHsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- (IT3) and (IT4) of Note [The tcType invariant]</span>
<a name="line-635"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-638"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>  <span class='hs-comment'>-- this is so that we can use visible kind application with '[]</span>
<a name="line-639"></a>              <span class='hs-comment'>-- e.g ... '[] @Bool</span>
<a name="line-640"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>promotedNilDataCon</span><span class='hs-layout'>,</span>
<a name="line-641"></a>            <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-642"></a>
<a name="line-643"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span>
<a name="line-644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-645"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span> <span class='hs-varid'>kv</span>
<a name="line-646"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-647"></a>
<a name="line-648"></a><a name="tc_lhs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-649"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-650"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-651"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-652"></a>    <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-653"></a>
<a name="line-654"></a><a name="tc_fun_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-655"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>
<a name="line-656"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-657"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-658"></a>  <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-659"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-660"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-661"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>arg_k</span>
<a name="line-662"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>res_k</span>
<a name="line-663"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>noExt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-664"></a>                           <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-665"></a>  <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- no representation polymorphism in kinds. yet.</span>
<a name="line-666"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-667"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-668"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>noExt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-669"></a>                           <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-670"></a>
<a name="line-671"></a><a name="tc_hs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-672"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-673"></a><span class='hs-comment'>-- See Note [The tcType invariant]</span>
<a name="line-674"></a><span class='hs-comment'>-- See Note [Bidirectional type checking]</span>
<a name="line-675"></a>
<a name="line-676"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-677"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-678"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bang</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-679"></a>    <span class='hs-comment'>-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span>
<a name="line-680"></a>    <span class='hs-comment'>-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span>
<a name="line-681"></a>    <span class='hs-comment'>-- bangs are invalid, so fail. (#7210, #14761)</span>
<a name="line-682"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bangError</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span>
<a name="line-683"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"annotation:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span>
<a name="line-684"></a>                 <span class='hs-varid'>text</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"annotation cannot appear nested inside a type"</span>
<a name="line-685"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bang</span> <span class='hs-keyword'>of</span>
<a name="line-686"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>SrcUnpack</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"UNPACK"</span>
<a name="line-687"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"NOUNPACK"</span>
<a name="line-688"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-conid'>SrcLazy</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"laziness"</span>
<a name="line-689"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"strictness"</span> <span class='hs-layout'>}</span>
<a name="line-690"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>
<a name="line-691"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor</span>
<a name="line-692"></a>      <span class='hs-comment'>-- signatures) should have been removed by now</span>
<a name="line-693"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Record syntax is illegal here:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-694"></a>
<a name="line-695"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType'.</span>
<a name="line-696"></a><span class='hs-comment'>-- Here we get rid of it and add the finalizers to the global environment</span>
<a name="line-697"></a><span class='hs-comment'>-- while capturing the local environment.</span>
<a name="line-698"></a><span class='hs-comment'>--</span>
<a name="line-699"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-700"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod_finalizers</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-701"></a>           <span class='hs-varid'>exp_kind</span>
<a name="line-702"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>addModFinalizersWithLclEnv</span> <span class='hs-varid'>mod_finalizers</span>
<a name="line-703"></a>       <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-704"></a>
<a name="line-705"></a><span class='hs-comment'>-- This should never happen; type splices are expanded by the renamer</span>
<a name="line-706"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-707"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected type splice:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-708"></a>
<a name="line-709"></a><span class='hs-comment'>---------- Functions and applications</span>
<a name="line-710"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-711"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-712"></a>
<a name="line-713"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-714"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-716"></a>
<a name="line-717"></a><span class='hs-comment'>--------- Foralls</span>
<a name="line-718"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>forall</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-719"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-720"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-721"></a>               <span class='hs-varid'>bindExplicitTKBndrs_Skol</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-722"></a>               <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-723"></a>    <span class='hs-comment'>-- Do not kind-generalise here!  See Note [Kind generalisation]</span>
<a name="line-724"></a>    <span class='hs-comment'>-- Why exp_kind?  See Note [Body kind of HsForAllTy]</span>
<a name="line-725"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarBinders</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>tvs'</span>
<a name="line-726"></a>             <span class='hs-varid'>skol_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllSkol</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-keyword'>forall</span><span class='hs-layout'>)</span>
<a name="line-727"></a>             <span class='hs-varid'>m_telescope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-728"></a>
<a name="line-729"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>m_telescope</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-730"></a>
<a name="line-731"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-732"></a>
<a name="line-733"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQualTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-734"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-736"></a>
<a name="line-737"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-738"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span>
<a name="line-739"></a>
<a name="line-740"></a>         <span class='hs-comment'>-- See Note [Body kind of a HsQualTy]</span>
<a name="line-741"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-742"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-743"></a>                <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-744"></a>                                <span class='hs-comment'>-- The body kind (result of the function)</span>
<a name="line-745"></a>                                <span class='hs-comment'>-- can be TYPE r, for any r, hence newOpenTypeKind</span>
<a name="line-746"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-747"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-748"></a>
<a name="line-749"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-750"></a>
<a name="line-751"></a><span class='hs-comment'>--------- Lists, arrays, and tuples</span>
<a name="line-752"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-753"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-754"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-755"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-756"></a>
<a name="line-757"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in HsTypes</span>
<a name="line-758"></a><span class='hs-comment'>-- See Note [Inferring tuple kinds]</span>
<a name="line-759"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-760"></a>     <span class='hs-comment'>-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span>
<a name="line-761"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>exp_kind</span>
<a name="line-762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-763"></a>    <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-764"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-765"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span>
<a name="line-766"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-767"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kinds</span>
<a name="line-768"></a>           <span class='hs-comment'>-- Infer each arg type separately, because errors can be</span>
<a name="line-769"></a>           <span class='hs-comment'>-- confusing if we give them a shared kind.  Eg Trac #7410</span>
<a name="line-770"></a>           <span class='hs-comment'>-- (Either Int, Int), we do not want to get an error saying</span>
<a name="line-771"></a>           <span class='hs-comment'>-- "the second argument of a tuple should have kind *-&gt;*"</span>
<a name="line-772"></a>
<a name="line-773"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_sort</span><span class='hs-layout'>)</span>
<a name="line-774"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span>
<a name="line-775"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-776"></a>                    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-777"></a>                    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>BoxedTuple</span><span class='hs-layout'>)</span>
<a name="line-778"></a>         <span class='hs-comment'>-- In the [] case, it's not clear what the kind is, so guess *</span>
<a name="line-779"></a>
<a name="line-780"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-781"></a>                            <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_kind</span>
<a name="line-782"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>]</span>
<a name="line-783"></a>
<a name="line-784"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-785"></a>
<a name="line-786"></a>
<a name="line-787"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-788"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-789"></a>  <span class='hs-keyword'>where</span>
<a name="line-790"></a>    <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- Fourth case dealt with above</span>
<a name="line-791"></a>                  <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboxedTuple</span>
<a name="line-792"></a>                  <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-793"></a>                  <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-794"></a>                  <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsTupleTy"</span>
<a name="line-795"></a>
<a name="line-796"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-797"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>hs_tys</span>
<a name="line-798"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-799"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-800"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>kindRep</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-801"></a>             <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-802"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span>
<a name="line-803"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sumTyCon</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-804"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>unboxedSumKind</span> <span class='hs-varid'>arg_reps</span><span class='hs-layout'>)</span>
<a name="line-805"></a>                           <span class='hs-varid'>exp_kind</span>
<a name="line-806"></a>       <span class='hs-layout'>}</span>
<a name="line-807"></a>
<a name="line-808"></a><span class='hs-comment'>--------- Promoted lists and tuples</span>
<a name="line-809"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-811"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>taus'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tks</span>
<a name="line-812"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_cons</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_nil</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>taus'</span><span class='hs-layout'>)</span>
<a name="line-813"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-814"></a>  <span class='hs-keyword'>where</span>
<a name="line-815"></a>    <span class='hs-varid'>mk_cons</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-816"></a>    <span class='hs-varid'>mk_nil</span>  <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-817"></a>
<a name="line-818"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-819"></a>  <span class='hs-comment'>-- using newMetaKindVar means that we force instantiations of any polykinded</span>
<a name="line-820"></a>  <span class='hs-comment'>-- types. At first, I just used tc_infer_lhs_type, but that led to #11255.</span>
<a name="line-821"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ks</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-822"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>taus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ks</span>
<a name="line-823"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kind_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span>           <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-824"></a>             <span class='hs-varid'>ty_con</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleDataCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-825"></a>             <span class='hs-varid'>tup_k</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>kind_con</span> <span class='hs-varid'>ks</span>
<a name="line-826"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ty_con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tup_k</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-827"></a>  <span class='hs-keyword'>where</span>
<a name="line-828"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-829"></a>
<a name="line-830"></a><span class='hs-comment'>--------- Constraint types</span>
<a name="line-831"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-833"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-834"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>n</span>
<a name="line-835"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-836"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-837"></a>           <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-838"></a>
<a name="line-839"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsStarTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-840"></a>  <span class='hs-comment'>-- Desugaring 'HsStarTy' to 'Data.Kind.Type' here means that we don't have to</span>
<a name="line-841"></a>  <span class='hs-comment'>-- handle it in 'coreView' and 'tcView'.</span>
<a name="line-842"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-843"></a>
<a name="line-844"></a><span class='hs-comment'>--------- Literals</span>
<a name="line-845"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeNatKindCon</span>
<a name="line-847"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNumLitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>typeNatKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-848"></a>
<a name="line-849"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-850"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeSymbolKindCon</span>
<a name="line-851"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-852"></a>
<a name="line-853"></a><span class='hs-comment'>--------- Potentially kind-polymorphic types: call the "up" checker</span>
<a name="line-854"></a><span class='hs-comment'>-- See Note [Future-proofing the type checker]</span>
<a name="line-855"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-856"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-857"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppKindTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-858"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-859"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-860"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>XHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>NHsCoreTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-861"></a>
<a name="line-862"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-863"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardOcc</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>exp_kind</span>
<a name="line-864"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedCastTy</span> <span class='hs-varid'>wc_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-865"></a>         <span class='hs-comment'>-- Take care here! Even though the coercion is Refl,</span>
<a name="line-866"></a>         <span class='hs-comment'>-- we still need it to establish Note [The tcType invariant]</span>
<a name="line-867"></a>       <span class='hs-layout'>}</span>
<a name="line-868"></a>
<a name="line-869"></a><a name="tcWildCardOcc"></a><span class='hs-definition'>tcWildCardOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-870"></a><span class='hs-definition'>tcWildCardOcc</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>exp_kind</span>
<a name="line-871"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWildTyVar</span>
<a name="line-872"></a>          <span class='hs-comment'>-- The wildcard's kind should be an un-filled-in meta tyvar</span>
<a name="line-873"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-874"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-875"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarOcc</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span>
<a name="line-876"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>part_tysig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.PartialTypeSignatures</span>
<a name="line-877"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warning</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnPartialTypeSignatures</span>
<a name="line-878"></a>       <span class='hs-comment'>-- See Note [Wildcards in visible kind application]</span>
<a name="line-879"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>part_tysig</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>warning</span><span class='hs-layout'>)</span>
<a name="line-880"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>emitWildCardHoleConstraints</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-881"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span>
<a name="line-882"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-883"></a>
<a name="line-884"></a><a name="tc_infer_hs_type_ek"></a><span class='hs-comment'>{- Note [Wildcards in visible kind application]
<a name="line-885"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-886"></a>There are cases where users might want to pass in a wildcard as a visible kind
<a name="line-887"></a>argument, for instance:
<a name="line-888"></a>
<a name="line-889"></a>data T :: forall k1 k2. k1 → k2 → Type where
<a name="line-890"></a>  MkT :: T a b
<a name="line-891"></a>x :: T @_ @Nat False n
<a name="line-892"></a>x = MkT
<a name="line-893"></a>
<a name="line-894"></a>So we should allow '@_' without emitting any hole constraints, and
<a name="line-895"></a>regardless of whether PartialTypeSignatures is enabled or not. But how would
<a name="line-896"></a>the typechecker know which '_' is being used in VKA and which is not when it
<a name="line-897"></a>calls emitWildCardHoleConstraints in tcHsPartialSigType on all HsWildCardBndrs?
<a name="line-898"></a>The solution then is to neither rename nor include unnamed wildcards in HsWildCardBndrs,
<a name="line-899"></a>but instead give every unnamed wildcard a fresh wild tyvar in tcWildCardOcc.
<a name="line-900"></a>And whenever we see a '@', we automatically turn on PartialTypeSignatures and
<a name="line-901"></a>turn off hole constraint warnings, and never call emitWildCardHoleConstraints
<a name="line-902"></a>under these conditions.
<a name="line-903"></a>See related Note [Wildcards in visible type application] here and
<a name="line-904"></a>Note [The wildcard story for types] in HsTypes.hs
<a name="line-905"></a>
<a name="line-906"></a>-}</span>
<a name="line-907"></a><span class='hs-comment'>---------------------------</span>
<a name="line-908"></a><span class='hs-comment'>-- | Call 'tc_infer_hs_type' and check its result against an expected kind.</span>
<a name="line-909"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-910"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ek</span>
<a name="line-911"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span>
<a name="line-912"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-913"></a>
<a name="line-914"></a><a name="tupKindSort_maybe"></a><span class='hs-comment'>---------------------------</span>
<a name="line-915"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TupleSort</span>
<a name="line-916"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-varid'>k</span>
<a name="line-917"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitCastTy_maybe</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-918"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-919"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-920"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsLiftedTypeKind</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-921"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-922"></a>
<a name="line-923"></a><a name="tc_tuple"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-924"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-925"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-926"></a>           <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-927"></a>           <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-928"></a>           <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-929"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-930"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-931"></a>  <span class='hs-keyword'>where</span>
<a name="line-932"></a>    <span class='hs-varid'>arity</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-933"></a>
<a name="line-934"></a><a name="finish_tuple"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-935"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-936"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span>
<a name="line-937"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ argument types</span>
<a name="line-938"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ of these kinds</span>
<a name="line-939"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- ^ expected kind of the whole tuple</span>
<a name="line-940"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-941"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varid'>exp_kind</span>
<a name="line-942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"finish_tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-943"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-944"></a>                   <span class='hs-comment'>-- See also Note [Unboxed tuple RuntimeRep vars] in TyCon</span>
<a name="line-945"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-946"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_tys</span>
<a name="line-947"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tau_tys</span>
<a name="line-948"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-949"></a>           <span class='hs-conid'>ConstraintTuple</span>
<a name="line-950"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span>
<a name="line-951"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>bigConstraintTuple</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-952"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>cTupleTyConName</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-953"></a>           <span class='hs-conid'>BoxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-954"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-955"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-956"></a>           <span class='hs-conid'>UnboxedTuple</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Unboxed</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-957"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-958"></a>  <span class='hs-keyword'>where</span>
<a name="line-959"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tau_tys</span>
<a name="line-960"></a>    <span class='hs-varid'>tau_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>kindRep</span> <span class='hs-varid'>tau_kinds</span>
<a name="line-961"></a>    <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-962"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unboxedTupleKind</span> <span class='hs-varid'>tau_reps</span>
<a name="line-963"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-964"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-965"></a>
<a name="line-966"></a><a name="bigConstraintTuple"></a><span class='hs-definition'>bigConstraintTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgDoc</span>
<a name="line-967"></a><span class='hs-definition'>bigConstraintTuple</span> <span class='hs-varid'>arity</span>
<a name="line-968"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Constraint tuple arity too large:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>arity</span>
<a name="line-969"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"max arity ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>mAX_CTUPLE_SIZE</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-970"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Instead, use a nested tuple"</span><span class='hs-layout'>)</span>
<a name="line-971"></a>
<a name="line-972"></a><a name="tcInferApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-973"></a><span class='hs-comment'>-- | Apply a type of a given kind to a list of arguments. This instantiates</span>
<a name="line-974"></a><span class='hs-comment'>-- invisible parameters as necessary. Always consumes all the arguments,</span>
<a name="line-975"></a><span class='hs-comment'>-- using matchExpectedFunKind as necessary.</span>
<a name="line-976"></a><span class='hs-comment'>-- This takes an optional @VarEnv Kind@ which maps kind variables to kinds.-</span>
<a name="line-977"></a><span class='hs-comment'>-- These kinds should be used to instantiate invisible kind variables;</span>
<a name="line-978"></a><span class='hs-comment'>-- they come from an enclosing class for an associated type/data family.</span>
<a name="line-979"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-980"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>        <span class='hs-comment'>-- ^ Function (for printing only)</span>
<a name="line-981"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- ^ Function</span>
<a name="line-982"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- ^ Function kind (zonked)</span>
<a name="line-983"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ Args</span>
<a name="line-984"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (f args, args, result kind)</span>
<a name="line-985"></a><span class='hs-comment'>-- Precondition: tcTypeKind fun_ty = fun_ki</span>
<a name="line-986"></a><span class='hs-comment'>--    Reason: we will return a type application like (fun_ty arg1 ... argn),</span>
<a name="line-987"></a><span class='hs-comment'>--            and that type must be well-kinded</span>
<a name="line-988"></a><span class='hs-comment'>--            See Note [The tcType invariant]</span>
<a name="line-989"></a><span class='hs-comment'>-- Postcondition: Result kind is zonked.</span>
<a name="line-990"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>orig_hs_args</span>
<a name="line-991"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_hs_args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ki</span><span class='hs-layout'>)</span>
<a name="line-992"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-num'>1</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>orig_ki_binders</span> <span class='hs-varid'>orig_inner_ki</span> <span class='hs-varid'>orig_hs_args</span>
<a name="line-993"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps }"</span> <span class='hs-varid'>empty</span>
<a name="line-994"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>res_k</span>  <span class='hs-comment'>-- Uphold (IT4) of Note [The tcType invariant]</span>
<a name="line-995"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-996"></a>  <span class='hs-keyword'>where</span>
<a name="line-997"></a>    <span class='hs-varid'>empty_subst</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-998"></a>                                       <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>fun_ki</span>
<a name="line-999"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>orig_ki_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPiTys</span> <span class='hs-varid'>fun_ki</span>
<a name="line-1000"></a>
<a name="line-1001"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>             <span class='hs-comment'>-- the # of the next argument</span>
<a name="line-1002"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>        <span class='hs-comment'>-- instantiating substitution</span>
<a name="line-1003"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>          <span class='hs-comment'>-- function applied to some args</span>
<a name="line-1004"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyBinder</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- binders in function kind (both vis. and invis.)</span>
<a name="line-1005"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>          <span class='hs-comment'>-- function kind body (not a Pi-type)</span>
<a name="line-1006"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- un-type-checked args</span>
<a name="line-1007"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- same as overall return type</span>
<a name="line-1008"></a>
<a name="line-1009"></a>      <span class='hs-comment'>-- no user-written args left. We're done!</span>
<a name="line-1010"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-conid'>[]</span>
<a name="line-1011"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>fun</span>
<a name="line-1012"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>nakedSubstTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span><span class='hs-layout'>)</span>
<a name="line-1013"></a>                 <span class='hs-comment'>-- nakedSubstTy: see Note [The well-kinded type invariant]</span>
<a name="line-1014"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>all_kindbinder</span> <span class='hs-varid'>inner_ki</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1015"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>all_kindbinder</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span>
<a name="line-1016"></a>      <span class='hs-comment'>-- The function's kind has a binder. Is it visible or invisible?</span>
<a name="line-1017"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>all_kindbinder</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>ki_binder</span><span class='hs-conop'>:</span><span class='hs-varid'>ki_binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1018"></a>       <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1019"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Specified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyCoBinderArgFlag</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1020"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>HsTypeArg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg</span>
<a name="line-1021"></a>         <span class='hs-comment'>-- Invisible and specified binder with visible kind argument</span>
<a name="line-1022"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (vis kind app)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span>
<a name="line-1023"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-1024"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoBinderArgFlag</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1025"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nakedSubstTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1026"></a>                    <span class='hs-comment'>-- nakedSubstTy: see Note [The well-kinded type invariant]</span>
<a name="line-1027"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1028"></a>                            <span class='hs-varid'>unsetWOptM</span> <span class='hs-conid'>Opt_WarnPartialTypeSignatures</span> <span class='hs-varop'>$</span>
<a name="line-1029"></a>                            <span class='hs-varid'>setXOptM</span> <span class='hs-conid'>LangExt.PartialTypeSignatures</span> <span class='hs-varop'>$</span>
<a name="line-1030"></a>                            <span class='hs-comment'>-- see Note [Wildcards in visible kind application]</span>
<a name="line-1031"></a>                            <span class='hs-varid'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindLevel</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1032"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (vis kind app)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1033"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubstBinderAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>arg'</span>
<a name="line-1034"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span>
<a name="line-1035"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-1036"></a>                       <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-1037"></a>
<a name="line-1038"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1039"></a>          <span class='hs-comment'>-- Instantiate if not specified or if there is no kind application</span>
<a name="line-1040"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (invis normal app)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoBinderArgFlag</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1041"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyBinder</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1042"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-1043"></a>                        <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-layout'>}</span>
<a name="line-1044"></a>
<a name="line-1045"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- if binder is visible</span>
<a name="line-1046"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-1047"></a>             <span class='hs-conid'>HsValArg</span> <span class='hs-varid'>ty</span> <span class='hs-comment'>-- check the next argument</span>
<a name="line-1048"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (vis normal app)"</span>
<a name="line-1049"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1050"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-1051"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-1052"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1053"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nakedSubstTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1054"></a>                     <span class='hs-comment'>-- nakedSubstTy: see Note [The well-kinded type invariant]</span>
<a name="line-1055"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1056"></a>                               <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1057"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (vis normal app)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1058"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubstBinderAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>arg'</span>
<a name="line-1059"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span>
<a name="line-1060"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-1061"></a>                          <span class='hs-varid'>ki_binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-1062"></a>            <span class='hs-comment'>-- error if the argument is a kind application</span>
<a name="line-1063"></a>             <span class='hs-conid'>HsTypeArg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (error)"</span>
<a name="line-1064"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1065"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span>
<a name="line-1066"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-1067"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span>
<a name="line-1068"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1069"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>ki</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nakedSubstTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span>
<a name="line-1070"></a>                                                  <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>all_kindbinder</span> <span class='hs-varid'>inner_ki</span> <span class='hs-layout'>}</span>
<a name="line-1071"></a>
<a name="line-1072"></a>             <span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcInferApps"</span>  <span class='hs-comment'>-- handled in separate clause of "go"</span>
<a name="line-1073"></a>
<a name="line-1074"></a>       <span class='hs-comment'>-- We've run out of known binders in the functions's kind.</span>
<a name="line-1075"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1076"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>new_ki_binders</span><span class='hs-layout'>)</span>
<a name="line-1077"></a>         <span class='hs-comment'>-- But, after substituting, we have more binders.</span>
<a name="line-1078"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>zapped_subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>new_ki_binders</span> <span class='hs-varid'>new_inner_ki</span> <span class='hs-varid'>all_args</span>
<a name="line-1079"></a>
<a name="line-1080"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1081"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-1082"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>         <span class='hs-comment'>-- Even after substituting, still no binders. Use matchExpectedFunKind</span>
<a name="line-1084"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferApps (no binder)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_inner_ki</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zapped_subst</span><span class='hs-layout'>)</span>
<a name="line-1085"></a>               <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>substed_inner_ki</span>
<a name="line-1086"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_k</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-keyglyph'>]</span>
<a name="line-1087"></a>                     <span class='hs-varid'>subst'</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapped_subst</span> <span class='hs-varop'>`extendTCvInScopeSet`</span> <span class='hs-varid'>new_in_scope</span>
<a name="line-1088"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst'</span>
<a name="line-1089"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>fun</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [The well-kinded type invariant]</span>
<a name="line-1090"></a>                    <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkAnonBinder</span> <span class='hs-varid'>arg_k</span><span class='hs-keyglyph'>]</span>
<a name="line-1091"></a>                    <span class='hs-varid'>res_k</span> <span class='hs-varid'>all_args</span> <span class='hs-layout'>}</span>
<a name="line-1092"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>substed_inner_ki</span>
<a name="line-1093"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span>
<a name="line-1094"></a>      <span class='hs-keyword'>where</span>
<a name="line-1095"></a>        <span class='hs-varid'>substed_inner_ki</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1096"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>new_ki_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inner_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPiTys</span> <span class='hs-varid'>substed_inner_ki</span>
<a name="line-1097"></a>        <span class='hs-varid'>zapped_subst</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst</span>
<a name="line-1098"></a>        <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_hs_args</span><span class='hs-layout'>)</span>
<a name="line-1099"></a>
<a name="line-1100"></a>    <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Cannot apply function of kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1101"></a>                           <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to visible kind argument"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1102"></a>
<a name="line-1103"></a><a name="appTypeToArg"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1104"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-1105"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppTy</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1106"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-varid'>l</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppKindTy</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1108"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span>
<a name="line-1109"></a>
<a name="line-1110"></a><a name="tcTyApps"></a><span class='hs-comment'>-- | Applies a type to a list of arguments.</span>
<a name="line-1111"></a><span class='hs-comment'>-- Always consumes all the arguments, using 'matchExpectedFunKind' as</span>
<a name="line-1112"></a><span class='hs-comment'>-- necessary. If you wish to apply a type to a list of HsTypes, this is</span>
<a name="line-1113"></a><span class='hs-comment'>-- your function.</span>
<a name="line-1114"></a><span class='hs-comment'>-- Used for type-checking types only.</span>
<a name="line-1115"></a><span class='hs-definition'>tcTyApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-1116"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>        <span class='hs-comment'>-- ^ Function (for printing only)</span>
<a name="line-1117"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- ^ Function</span>
<a name="line-1118"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- ^ Function kind (zonked)</span>
<a name="line-1119"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ Args</span>
<a name="line-1120"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (f args, result kind)   result kind is zonked</span>
<a name="line-1121"></a><span class='hs-comment'>-- Precondition: see precondition for tcInferApps</span>
<a name="line-1122"></a><span class='hs-definition'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>args</span>
<a name="line-1123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>args</span>
<a name="line-1124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1125"></a>          <span class='hs-comment'>-- The mkNakedCastTy is for (IT3) of Note [The tcType invariant]</span>
<a name="line-1126"></a>
<a name="line-1127"></a><a name="tcTyApp"></a><span class='hs-definition'>tcTyApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- only HsAppTy or HsAppKindTy</span>
<a name="line-1128"></a><span class='hs-definition'>tcTyApp</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>e</span>
<a name="line-1129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>e</span>
<a name="line-1130"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span>
<a name="line-1131"></a>          <span class='hs-comment'>-- NB: (IT4) of Note [The tcType invariant] ensures that fun_kind is zonked</span>
<a name="line-1132"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>hs_args</span> <span class='hs-layout'>}</span>
<a name="line-1133"></a><a name="checkExpectedKindMode"></a><span class='hs-comment'>--------------------------</span>
<a name="line-1134"></a><span class='hs-comment'>-- Internally-callable version of checkExpectedKind</span>
<a name="line-1135"></a><span class='hs-definition'>checkExpectedKindMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-1136"></a>                      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-1137"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>        <span class='hs-comment'>-- type we're checking</span>
<a name="line-1138"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>      <span class='hs-comment'>-- type we're checking</span>
<a name="line-1139"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- kind of that type</span>
<a name="line-1140"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- expected kind</span>
<a name="line-1141"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1142"></a><span class='hs-definition'>checkExpectedKindMode</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_sat</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-1143"></a>
<a name="line-1144"></a><a name="checkExpectedKind"></a><span class='hs-comment'>-- | This instantiates invisible arguments for the type being checked if it must</span>
<a name="line-1145"></a><span class='hs-comment'>-- be saturated and is not yet saturated. It then calls and uses the result</span>
<a name="line-1146"></a><span class='hs-comment'>-- from checkExpectedKindX to build the final type</span>
<a name="line-1147"></a><span class='hs-comment'>-- Obeys Note [The tcType invariant]</span>
<a name="line-1148"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-1149"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>RequireSaturation</span>  <span class='hs-comment'>-- ^ Do we require all type families to be saturated?</span>
<a name="line-1150"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>           <span class='hs-comment'>-- ^ type we're checking (for printing)</span>
<a name="line-1151"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- ^ type we're checking</span>
<a name="line-1152"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>         <span class='hs-comment'>-- ^ the known kind of that type</span>
<a name="line-1153"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>         <span class='hs-comment'>-- ^ the expected kind</span>
<a name="line-1154"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1155"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>sat</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act</span> <span class='hs-varid'>exp</span>
<a name="line-1156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_act</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1157"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1158"></a>             <span class='hs-comment'>-- if the family tycon must be saturated and is not yet satured</span>
<a name="line-1159"></a>             <span class='hs-comment'>-- If we don't do this, we get #11246</span>
<a name="line-1160"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>YesSaturation</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sat</span>
<a name="line-1161"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mightBeUnsaturatedTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-1162"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-1163"></a>                   <span class='hs-comment'>-- we need to instantiate all invisible arguments up until saturation</span>
<a name="line-1164"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>tc_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitPiTysInvisibleN</span>
<a name="line-1165"></a>                                                        <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1166"></a>                                                        <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-1167"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_args</span>
<a name="line-1168"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind:satTyFam"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act</span>
<a name="line-1169"></a>                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1170"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1171"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-1172"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkExpectedKindX</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>new_act</span> <span class='hs-varid'>exp</span>
<a name="line-1173"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span> <span class='hs-varop'>`mkNakedAppTys`</span> <span class='hs-varid'>new_args</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1174"></a>
<a name="line-1175"></a><a name="checkExpectedKindX"></a><span class='hs-definition'>checkExpectedKindX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-1176"></a>                   <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span>                 <span class='hs-comment'>-- HsType whose kind we're checking</span>
<a name="line-1177"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- the known kind of that type, k</span>
<a name="line-1178"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>               <span class='hs-comment'>-- the expected kind, exp_kind</span>
<a name="line-1179"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercionN</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>    <span class='hs-comment'>-- (the new args, the coercion)</span>
<a name="line-1181"></a><span class='hs-comment'>-- Instantiate a kind (if necessary) and then call unifyType</span>
<a name="line-1182"></a><span class='hs-comment'>--      (checkExpectedKind ty act_kind exp_kind)</span>
<a name="line-1183"></a><span class='hs-comment'>-- checks that the actual kind act_kind is compatible</span>
<a name="line-1184"></a><span class='hs-comment'>--      with the expected kind exp_kind</span>
<a name="line-1185"></a><span class='hs-definition'>checkExpectedKindX</span> <span class='hs-varid'>pp_hs_ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- We need to make sure that both kinds have the same number of implicit</span>
<a name="line-1187"></a>         <span class='hs-comment'>-- foralls out front. If the actual kind has more, instantiate accordingly.</span>
<a name="line-1188"></a>         <span class='hs-comment'>-- Otherwise, just pass the type &amp; kind through: the errors are caught</span>
<a name="line-1189"></a>         <span class='hs-comment'>-- in unifyType.</span>
<a name="line-1190"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>n_exp_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1191"></a>             <span class='hs-varid'>n_act_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>act_kind</span>
<a name="line-1192"></a>             <span class='hs-varid'>n_to_inst</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_act_invis_bndrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_exp_invis_bndrs</span>
<a name="line-1193"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstTyBinders</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitPiTysInvisibleN</span> <span class='hs-varid'>n_to_inst</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span>
<a name="line-1194"></a>
<a name="line-1195"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_kind'</span>
<a name="line-1196"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1197"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pp_hs_ty</span>
<a name="line-1198"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- the hs_ty is visible</span>
<a name="line-1199"></a>
<a name="line-1200"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKindX"</span> <span class='hs-varop'>$</span>
<a name="line-1201"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pp_hs_ty</span>
<a name="line-1202"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"act_kind:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span>
<a name="line-1203"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"act_kind':"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind'</span>
<a name="line-1204"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"exp_kind:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>]</span>
<a name="line-1205"></a>
<a name="line-1206"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>act_kind'</span> <span class='hs-varop'>`tcEqType`</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1207"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- This is very common</span>
<a name="line-1208"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>act_kind'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1209"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span>
<a name="line-1210"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1211"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>                      <span class='hs-comment'>-- See Note [The tcType invariant]</span>
<a name="line-1213"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1214"></a>
<a name="line-1215"></a><a name="tcHsMbContext"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1216"></a><span class='hs-definition'>tcHsMbContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-1217"></a><span class='hs-definition'>tcHsMbContext</span> <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1218"></a><span class='hs-definition'>tcHsMbContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>cxt</span>
<a name="line-1219"></a>
<a name="line-1220"></a><a name="tcHsContext"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-1221"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>typeLevelMode</span>
<a name="line-1222"></a>
<a name="line-1223"></a><a name="tcLHsPredType"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-1224"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>typeLevelMode</span>
<a name="line-1225"></a>
<a name="line-1226"></a><a name="tc_hs_context"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-1227"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-1228"></a>
<a name="line-1229"></a><a name="tc_lhs_pred"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-1230"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1231"></a>
<a name="line-1232"></a><a name="tcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1233"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1234"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-1235"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-1236"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-1237"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1238"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-1239"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1240"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- Important: zonk before returning</span>
<a name="line-1241"></a>                          <span class='hs-comment'>-- We may have the application ((a::kappa) b)</span>
<a name="line-1242"></a>                          <span class='hs-comment'>-- where kappa is already unified to (k1 -&gt; k2)</span>
<a name="line-1243"></a>                          <span class='hs-comment'>-- Then we want to see that arrow.  Best done</span>
<a name="line-1244"></a>                          <span class='hs-comment'>-- here because we are also maintaining</span>
<a name="line-1245"></a>                          <span class='hs-comment'>-- Note [The tcType invariant], so we don't just</span>
<a name="line-1246"></a>                          <span class='hs-comment'>-- want to zonk the kind, leaving the TyVar</span>
<a name="line-1247"></a>                          <span class='hs-comment'>-- un-zonked  (Trac #14873)</span>
<a name="line-1248"></a>                          <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1249"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1250"></a>
<a name="line-1251"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1252"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- See Note [GADT kind self-reference]</span>
<a name="line-1253"></a>                     <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1254"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>TyConPE</span><span class='hs-layout'>)</span>
<a name="line-1255"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1256"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc_tc</span><span class='hs-layout'>)</span>
<a name="line-1257"></a>                        <span class='hs-comment'>-- (IT6) of Note [The tcType invariant]</span>
<a name="line-1258"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>tc_tc</span> <span class='hs-varop'>`mkNakedCastTy`</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>tc_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1259"></a>                        <span class='hs-comment'>-- the mkNakedCastTy ensures (IT5) of Note [The tcType invariant]</span>
<a name="line-1260"></a>
<a name="line-1261"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1262"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span>
<a name="line-1263"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1264"></a>
<a name="line-1265"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1266"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DataKinds</span>
<a name="line-1267"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>specialPromotedDc</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1268"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsDC</span>
<a name="line-1269"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamInstTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1270"></a>                       <span class='hs-comment'>-- see Trac #15245</span>
<a name="line-1271"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>FamDataConPE</span>
<a name="line-1272"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-1273"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-varid'>theta</span> <span class='hs-keyword'>of</span>
<a name="line-1274"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$</span>
<a name="line-1275"></a>                                    <span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-varid'>pred</span>
<a name="line-1276"></a>                       <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-1277"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>dc</span>
<a name="line-1278"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1279"></a>
<a name="line-1280"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-1281"></a>
<a name="line-1282"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1283"></a>  <span class='hs-keyword'>where</span>
<a name="line-1284"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1285"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DataKinds</span>
<a name="line-1286"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_level</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1287"></a>                               <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span>
<a name="line-1288"></a>                               <span class='hs-varid'>isKindTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1289"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsTC</span> <span class='hs-layout'>}</span>
<a name="line-1290"></a>
<a name="line-1291"></a>    <span class='hs-comment'>-- We cannot promote a data constructor with a context that contains</span>
<a name="line-1292"></a>    <span class='hs-comment'>-- constraints other than equalities, so error if we find one.</span>
<a name="line-1293"></a>    <span class='hs-comment'>-- See Note [Constraints handled in types] in Inst.</span>
<a name="line-1294"></a>    <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PredType</span>
<a name="line-1295"></a>    <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>go</span>
<a name="line-1296"></a>      <span class='hs-keyword'>where</span>
<a name="line-1297"></a>        <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1298"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>pred</span>
<a name="line-1299"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span>  <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-1300"></a>                      <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>
<a name="line-1301"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1302"></a>
<a name="line-1303"></a><span class='hs-comment'>{-
<a name="line-1304"></a>Note [GADT kind self-reference]
<a name="line-1305"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1306"></a>
<a name="line-1307"></a>A promoted type cannot be used in the body of that type's declaration.
<a name="line-1308"></a>Trac #11554 shows this example, which made GHC loop:
<a name="line-1309"></a>
<a name="line-1310"></a>  import Data.Kind
<a name="line-1311"></a>  data P (x :: k) = Q
<a name="line-1312"></a>  data A :: Type where
<a name="line-1313"></a>    B :: forall (a :: A). P a -&gt; A
<a name="line-1314"></a>
<a name="line-1315"></a>In order to check the constructor B, we need to have the promoted type A, but in
<a name="line-1316"></a>order to get that promoted type, B must first be checked. To prevent looping, a
<a name="line-1317"></a>TyConPE promotion error is given when tcTyVar checks an ATcTyCon in kind mode.
<a name="line-1318"></a>Any ATcTyCon is a TyCon being defined in the current recursive group (see data
<a name="line-1319"></a>type decl for TcTyThing), and all such TyCons are illegal in kinds.
<a name="line-1320"></a>
<a name="line-1321"></a>Trac #11962 proposes checking the head of a data declaration separately from
<a name="line-1322"></a>its constructors. This would allow the example above to pass.
<a name="line-1323"></a>
<a name="line-1324"></a>Note [Body kind of a HsForAllTy]
<a name="line-1325"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1326"></a>The body of a forall is usually a type, but in principle
<a name="line-1327"></a>there's no reason to prohibit *unlifted* types.
<a name="line-1328"></a>In fact, GHC can itself construct a function with an
<a name="line-1329"></a>unboxed tuple inside a for-all (via CPR analysis; see
<a name="line-1330"></a>typecheck/should_compile/tc170).
<a name="line-1331"></a>
<a name="line-1332"></a>Moreover in instance heads we get forall-types with
<a name="line-1333"></a>kind Constraint.
<a name="line-1334"></a>
<a name="line-1335"></a>It's tempting to check that the body kind is either * or #. But this is
<a name="line-1336"></a>wrong. For example:
<a name="line-1337"></a>
<a name="line-1338"></a>  class C a b
<a name="line-1339"></a>  newtype N = Mk Foo deriving (C a)
<a name="line-1340"></a>
<a name="line-1341"></a>We're doing newtype-deriving for C. But notice how `a` isn't in scope in
<a name="line-1342"></a>the predicate `C a`. So we quantify, yielding `forall a. C a` even though
<a name="line-1343"></a>`C a` has kind `* -&gt; Constraint`. The `forall a. C a` is a bit cheeky, but
<a name="line-1344"></a>convenient. Bottom line: don't check for * or # here.
<a name="line-1345"></a>
<a name="line-1346"></a>Note [Body kind of a HsQualTy]
<a name="line-1347"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1348"></a>If ctxt is non-empty, the HsQualTy really is a /function/, so the
<a name="line-1349"></a>kind of the result really is '*', and in that case the kind of the
<a name="line-1350"></a>body-type can be lifted or unlifted.
<a name="line-1351"></a>
<a name="line-1352"></a>However, consider
<a name="line-1353"></a>    instance Eq a =&gt; Eq [a] where ...
<a name="line-1354"></a>or
<a name="line-1355"></a>    f :: (Eq a =&gt; Eq [a]) =&gt; blah
<a name="line-1356"></a>Here both body-kind of the HsQualTy is Constraint rather than *.
<a name="line-1357"></a>Rather crudely we tell the difference by looking at exp_kind. It's
<a name="line-1358"></a>very convenient to typecheck instance types like any other HsSigType.
<a name="line-1359"></a>
<a name="line-1360"></a>Admittedly the '(Eq a =&gt; Eq [a]) =&gt; blah' case is erroneous, but it's
<a name="line-1361"></a>better to reject in checkValidType.  If we say that the body kind
<a name="line-1362"></a>should be '*' we risk getting TWO error messages, one saying that Eq
<a name="line-1363"></a>[a] doens't have kind '*', and one saying that we need a Constraint to
<a name="line-1364"></a>the left of the outer (=&gt;).
<a name="line-1365"></a>
<a name="line-1366"></a>How do we figure out the right body kind?  Well, it's a bit of a
<a name="line-1367"></a>kludge: I just look at the expected kind.  If it's Constraint, we
<a name="line-1368"></a>must be in this instance situation context. It's a kludge because it
<a name="line-1369"></a>wouldn't work if any unification was involved to compute that result
<a name="line-1370"></a>kind -- but it isn't.  (The true way might be to use the 'mode'
<a name="line-1371"></a>parameter, but that seemed like a sledgehammer to crack a nut.)
<a name="line-1372"></a>
<a name="line-1373"></a>Note [Inferring tuple kinds]
<a name="line-1374"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1375"></a>Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
<a name="line-1376"></a>we try to figure out whether it's a tuple of kind * or Constraint.
<a name="line-1377"></a>  Step 1: look at the expected kind
<a name="line-1378"></a>  Step 2: infer argument kinds
<a name="line-1379"></a>
<a name="line-1380"></a>If after Step 2 it's not clear from the arguments that it's
<a name="line-1381"></a>Constraint, then it must be *.  Once having decided that we re-check
<a name="line-1382"></a>the Check the arguments again to give good error messages
<a name="line-1383"></a>in eg. `(Maybe, Maybe)`
<a name="line-1384"></a>
<a name="line-1385"></a>Note that we will still fail to infer the correct kind in this case:
<a name="line-1386"></a>
<a name="line-1387"></a>  type T a = ((a,a), D a)
<a name="line-1388"></a>  type family D :: Constraint -&gt; Constraint
<a name="line-1389"></a>
<a name="line-1390"></a>While kind checking T, we do not yet know the kind of D, so we will default the
<a name="line-1391"></a>kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.
<a name="line-1392"></a>
<a name="line-1393"></a>Note [Desugaring types]
<a name="line-1394"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1395"></a>The type desugarer is phase 2 of dealing with HsTypes.  Specifically:
<a name="line-1396"></a>
<a name="line-1397"></a>  * It transforms from HsType to Type
<a name="line-1398"></a>
<a name="line-1399"></a>  * It zonks any kinds.  The returned type should have no mutable kind
<a name="line-1400"></a>    or type variables (hence returning Type not TcType):
<a name="line-1401"></a>      - any unconstrained kind variables are defaulted to (Any *) just
<a name="line-1402"></a>        as in TcHsSyn.
<a name="line-1403"></a>      - there are no mutable type variables because we are
<a name="line-1404"></a>        kind-checking a type
<a name="line-1405"></a>    Reason: the returned type may be put in a TyCon or DataCon where
<a name="line-1406"></a>    it will never subsequently be zonked.
<a name="line-1407"></a>
<a name="line-1408"></a>You might worry about nested scopes:
<a name="line-1409"></a>        ..a:kappa in scope..
<a name="line-1410"></a>            let f :: forall b. T '[a,b] -&gt; Int
<a name="line-1411"></a>In this case, f's type could have a mutable kind variable kappa in it;
<a name="line-1412"></a>and we might then default it to (Any *) when dealing with f's type
<a name="line-1413"></a>signature.  But we don't expect this to happen because we can't get a
<a name="line-1414"></a>lexically scoped type variable with a mutable kind variable in it.  A
<a name="line-1415"></a>delicate point, this.  If it becomes an issue we might need to
<a name="line-1416"></a>distinguish top-level from nested uses.
<a name="line-1417"></a>
<a name="line-1418"></a>Moreover
<a name="line-1419"></a>  * it cannot fail,
<a name="line-1420"></a>  * it does no unifications
<a name="line-1421"></a>  * it does no validity checking, except for structural matters, such as
<a name="line-1422"></a>        (a) spurious ! annotations.
<a name="line-1423"></a>        (b) a class used as a type
<a name="line-1424"></a>
<a name="line-1425"></a>Note [Kind of a type splice]
<a name="line-1426"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1427"></a>Consider these terms, each with TH type splice inside:
<a name="line-1428"></a>     [| e1 :: Maybe $(..blah..) |]
<a name="line-1429"></a>     [| e2 :: $(..blah..) |]
<a name="line-1430"></a>When kind-checking the type signature, we'll kind-check the splice
<a name="line-1431"></a>$(..blah..); we want to give it a kind that can fit in any context,
<a name="line-1432"></a>as if $(..blah..) :: forall k. k.
<a name="line-1433"></a>
<a name="line-1434"></a>In the e1 example, the context of the splice fixes kappa to *.  But
<a name="line-1435"></a>in the e2 example, we'll desugar the type, zonking the kind unification
<a name="line-1436"></a>variables as we go.  When we encounter the unconstrained kappa, we
<a name="line-1437"></a>want to default it to '*', not to (Any *).
<a name="line-1438"></a>
<a name="line-1439"></a>Help functions for type applications
<a name="line-1440"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1441"></a>-}</span>
<a name="line-1442"></a>
<a name="line-1443"></a><a name="addTypeCtxt"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1444"></a>        <span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.</span>
<a name="line-1445"></a>        <span class='hs-comment'>-- Omit invisible ones and ones user's won't grok</span>
<a name="line-1446"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing</span>   <span class='hs-comment'>-- "In the type '_'" just isn't helpful.</span>
<a name="line-1447"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-1448"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>thing</span>
<a name="line-1449"></a>  <span class='hs-keyword'>where</span>
<a name="line-1450"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>
<a name="line-1452"></a><span class='hs-comment'>{-
<a name="line-1453"></a>************************************************************************
<a name="line-1454"></a>*                                                                      *
<a name="line-1455"></a>                Type-variable binders
<a name="line-1456"></a>%*                                                                      *
<a name="line-1457"></a>%************************************************************************
<a name="line-1458"></a>
<a name="line-1459"></a>Note [Dependent LHsQTyVars]
<a name="line-1460"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1461"></a>We track (in the renamer) which explicitly bound variables in a
<a name="line-1462"></a>LHsQTyVars are manifestly dependent; only precisely these variables
<a name="line-1463"></a>may be used within the LHsQTyVars. We must do this so that kcLHsQTyVars
<a name="line-1464"></a>can produce the right TyConBinders, and tell Anon vs. Required.
<a name="line-1465"></a>
<a name="line-1466"></a>Example   data T k1 (a:k1) (b:k2) c
<a name="line-1467"></a>               = MkT (Proxy a) (Proxy b) (Proxy c)
<a name="line-1468"></a>
<a name="line-1469"></a>Here
<a name="line-1470"></a>  (a:k1),(b:k2),(c:k3)
<a name="line-1471"></a>       are Anon     (explicitly specified as a binder, not used
<a name="line-1472"></a>                     in the kind of any other binder
<a name="line-1473"></a>  k1   is Required  (explicitly specifed as a binder, but used
<a name="line-1474"></a>                     in the kind of another binder i.e. dependently)
<a name="line-1475"></a>  k2   is Specified (not explicitly bound, but used in the kind
<a name="line-1476"></a>                     of another binder)
<a name="line-1477"></a>  k3   in Inferred  (not lexically in scope at all, but inferred
<a name="line-1478"></a>                     by kind inference)
<a name="line-1479"></a>and
<a name="line-1480"></a>  T :: forall {k3} k1. forall k3 -&gt; k1 -&gt; k2 -&gt; k3 -&gt; *
<a name="line-1481"></a>
<a name="line-1482"></a>See Note [VarBndrs, TyCoVarBinders, TyConBinders, and visibility]
<a name="line-1483"></a>in TyCoRep.
<a name="line-1484"></a>
<a name="line-1485"></a>kcLHsQTyVars uses the hsq_dependent field to decide whether
<a name="line-1486"></a>k1, a, b, c should be Required or Anon.
<a name="line-1487"></a>
<a name="line-1488"></a>Earlier, thought it would work simply to do a free-variable check
<a name="line-1489"></a>during kcLHsQTyVars, but this is bogus, because there may be
<a name="line-1490"></a>unsolved equalities about. And we don't want to eagerly solve the
<a name="line-1491"></a>equalities, because we may get further information after
<a name="line-1492"></a>kcLHsQTyVars is called.  (Recall that kcLHsQTyVars is called
<a name="line-1493"></a>only from getInitialKind.)
<a name="line-1494"></a>This is what implements the rule that all variables intended to be
<a name="line-1495"></a>dependent must be manifestly so.
<a name="line-1496"></a>
<a name="line-1497"></a>Sidenote: It's quite possible that later, we'll consider (t -&gt; s)
<a name="line-1498"></a>as a degenerate case of some (pi (x :: t) -&gt; s) and then this will
<a name="line-1499"></a>all get more permissive.
<a name="line-1500"></a>
<a name="line-1501"></a>Note [Keeping scoped variables in order: Explicit]
<a name="line-1502"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1503"></a>When the user writes `forall a b c. blah`, we bring a, b, and c into
<a name="line-1504"></a>scope and then check blah. In the process of checking blah, we might
<a name="line-1505"></a>learn the kinds of a, b, and c, and these kinds might indicate that
<a name="line-1506"></a>b depends on c, and thus that we should reject the user-written type.
<a name="line-1507"></a>
<a name="line-1508"></a>One approach to doing this would be to bring each of a, b, and c into
<a name="line-1509"></a>scope, one at a time, creating an implication constraint and
<a name="line-1510"></a>bumping the TcLevel for each one. This would work, because the kind
<a name="line-1511"></a>of, say, b would be untouchable when c is in scope (and the constraint
<a name="line-1512"></a>couldn't float out because c blocks it). However, it leads to terrible
<a name="line-1513"></a>error messages, complaining about skolem escape. While it is indeed
<a name="line-1514"></a>a problem of skolem escape, we can do better.
<a name="line-1515"></a>
<a name="line-1516"></a>Instead, our approach is to bring the block of variables into scope
<a name="line-1517"></a>all at once, creating one implication constraint for the lot. The
<a name="line-1518"></a>user-written variables are skolems in the implication constraint. In
<a name="line-1519"></a>TcSimplify.setImplicationStatus, we check to make sure that the ordering
<a name="line-1520"></a>is correct, choosing ImplicationStatus IC_BadTelescope if they aren't.
<a name="line-1521"></a>Then, in TcErrors, we report if there is a bad telescope. This way,
<a name="line-1522"></a>we can report a suggested ordering to the user if there is a problem.
<a name="line-1523"></a>
<a name="line-1524"></a>Note [Keeping scoped variables in order: Implicit]
<a name="line-1525"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1526"></a>When the user implicitly quantifies over variables (say, in a type
<a name="line-1527"></a>signature), we need to come up with some ordering on these variables.
<a name="line-1528"></a>This is done by bumping the TcLevel, bringing the tyvars into scope,
<a name="line-1529"></a>and then type-checking the thing_inside. The constraints are all
<a name="line-1530"></a>wrapped in an implication, which is then solved. Finally, we can
<a name="line-1531"></a>zonk all the binders and then order them with scopedSort.
<a name="line-1532"></a>
<a name="line-1533"></a>It's critical to solve before zonking and ordering in order to uncover
<a name="line-1534"></a>any unifications. You might worry that this eager solving could cause
<a name="line-1535"></a>trouble elsewhere. I don't think it will. Because it will solve only
<a name="line-1536"></a>in an increased TcLevel, it can't unify anything that was mentioned
<a name="line-1537"></a>elsewhere. Additionally, we require that the order of implicitly
<a name="line-1538"></a>quantified variables is manifest by the scope of these variables, so
<a name="line-1539"></a>we're not going to learn more information later that will help order
<a name="line-1540"></a>these variables.
<a name="line-1541"></a>
<a name="line-1542"></a>Note [Recipe for checking a signature]
<a name="line-1543"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1544"></a>Checking a user-written signature requires several steps:
<a name="line-1545"></a>
<a name="line-1546"></a> 1. Generate constraints.
<a name="line-1547"></a> 2. Solve constraints.
<a name="line-1548"></a> 3. Zonk.
<a name="line-1549"></a> 4. Promote tyvars and/or kind-generalize.
<a name="line-1550"></a> 5. Zonk.
<a name="line-1551"></a> 6. Check validity.
<a name="line-1552"></a>
<a name="line-1553"></a>There may be some surprises in here:
<a name="line-1554"></a>
<a name="line-1555"></a>Step 2 is necessary for two reasons: most signatures also bring
<a name="line-1556"></a>implicitly quantified variables into scope, and solving is necessary
<a name="line-1557"></a>to get these in the right order (see Note [Keeping scoped variables in
<a name="line-1558"></a>order: Implicit]). Additionally, solving is necessary in order to
<a name="line-1559"></a>kind-generalize correctly.
<a name="line-1560"></a>
<a name="line-1561"></a>In Step 4, we have to deal with the fact that metatyvars generated
<a name="line-1562"></a>in the type may have a bumped TcLevel, because explicit foralls
<a name="line-1563"></a>raise the TcLevel. To avoid these variables from ever being visible
<a name="line-1564"></a>in the surrounding context, we must obey the following dictum:
<a name="line-1565"></a>
<a name="line-1566"></a>  Every metavariable in a type must either be
<a name="line-1567"></a>    (A) promoted
<a name="line-1568"></a>    (B) generalized, or
<a name="line-1569"></a>    (C) zapped to Any
<a name="line-1570"></a>
<a name="line-1571"></a>If a variable is generalized, then it becomes a skolem and no longer
<a name="line-1572"></a>has a proper TcLevel. (I'm ignoring the TcLevel on a skolem here, as
<a name="line-1573"></a>it's not really in play here.) On the other hand, if it is not
<a name="line-1574"></a>generalized (because we're not generalizing the construct -- e.g., pattern
<a name="line-1575"></a>sig -- or because the metavars are constrained -- see kindGeneralizeLocal)
<a name="line-1576"></a>we need to promote to maintain (MetaTvInv) of Note [TcLevel and untouchable type variables]
<a name="line-1577"></a>in TcType.
<a name="line-1578"></a>
<a name="line-1579"></a>For more about (C), see Note [Naughty quantification candidates] in TcMType.
<a name="line-1580"></a>
<a name="line-1581"></a>After promoting/generalizing, we need to zonk *again* because both
<a name="line-1582"></a>promoting and generalizing fill in metavariables.
<a name="line-1583"></a>
<a name="line-1584"></a>To avoid the double-zonk, we do two things:
<a name="line-1585"></a> 1. When we're not generalizing:
<a name="line-1586"></a>    zonkPromoteType and friends zonk and promote at the same time.
<a name="line-1587"></a>    Accordingly, the function does steps 3-5 all at once, preventing
<a name="line-1588"></a>    the need for multiple traversals.
<a name="line-1589"></a>
<a name="line-1590"></a> 2. When we are generalizing:
<a name="line-1591"></a>    kindGeneralize does not require a zonked type -- it zonks as it
<a name="line-1592"></a>    gathers free variables. So this way effectively sidesteps step 3.
<a name="line-1593"></a>-}</span>
<a name="line-1594"></a>
<a name="line-1595"></a><a name="tcWildCardBinders"></a><span class='hs-definition'>tcWildCardBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1596"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1597"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1598"></a><span class='hs-definition'>tcWildCardBinders</span> <span class='hs-varid'>wc_names</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1599"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newWildTyVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>wc_names</span>
<a name="line-1600"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>wcs</span>
<a name="line-1601"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>wc_prs</span> <span class='hs-varop'>$</span>
<a name="line-1602"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>wc_prs</span> <span class='hs-layout'>}</span>
<a name="line-1603"></a>
<a name="line-1604"></a><a name="newWildTyVar"></a><span class='hs-definition'>newWildTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1605"></a><span class='hs-comment'>-- ^ New unification variable for a wildcard</span>
<a name="line-1606"></a><span class='hs-definition'>newWildTyVar</span>
<a name="line-1607"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1608"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-1609"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-1610"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysTvName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-1611"></a>             <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-1612"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"newWildTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-1613"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>}</span>
<a name="line-1614"></a>
<a name="line-1615"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1616"></a>*                                                                      *
<a name="line-1617"></a>             Kind inference for type declarations
<a name="line-1618"></a>*                                                                      *
<a name="line-1619"></a>********************************************************************* -}</span>
<a name="line-1620"></a>
<a name="line-1621"></a><span class='hs-comment'>{- Note [The initial kind of a type constructor]
<a name="line-1622"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1623"></a>kcLHsQTyVars is responsible for getting the initial kind of
<a name="line-1624"></a>a type constructor.
<a name="line-1625"></a>
<a name="line-1626"></a>It has two cases:
<a name="line-1627"></a>
<a name="line-1628"></a> * The TyCon has a CUSK.  In that case, find the full, final,
<a name="line-1629"></a>   poly-kinded kind of the TyCon.  It's very like a term-level
<a name="line-1630"></a>   binding where we have a complete type signature for the
<a name="line-1631"></a>   function.
<a name="line-1632"></a>
<a name="line-1633"></a> * It does not have a CUSK.  Find a monomorphic kind, with
<a name="line-1634"></a>   unification variables in it; they will be generalised later.
<a name="line-1635"></a>   It's very like a term-level binding where we do not have
<a name="line-1636"></a>   a type signature (or, more accurately, where we have a
<a name="line-1637"></a>   partial type signature), so we infer the type and generalise.
<a name="line-1638"></a>-}</span>
<a name="line-1639"></a>
<a name="line-1640"></a>
<a name="line-1641"></a><a name="kcLHsQTyVars"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1642"></a><span class='hs-comment'>-- | Kind-check a 'LHsQTyVars'. If the decl under consideration has a complete,</span>
<a name="line-1643"></a><span class='hs-comment'>-- user-supplied kind signature (CUSK), generalise the result.</span>
<a name="line-1644"></a><span class='hs-comment'>-- Used in 'getInitialKind' (for tycon kinds and other kinds)</span>
<a name="line-1645"></a><span class='hs-comment'>-- and in kind-checking (but not for tycon kinds, which are checked with</span>
<a name="line-1646"></a><span class='hs-comment'>-- tcTyClDecls). See Note [CUSKs: complete user-supplied kind signatures]</span>
<a name="line-1647"></a><span class='hs-comment'>-- in HsDecls.</span>
<a name="line-1648"></a><span class='hs-comment'>--</span>
<a name="line-1649"></a><span class='hs-comment'>-- This function does not do telescope checking.</span>
<a name="line-1650"></a><span class='hs-definition'>kcLHsQTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-1651"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-1652"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>              <span class='hs-comment'>-- ^ True &lt;=&gt; the decl being checked has a CUSK</span>
<a name="line-1653"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1654"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>          <span class='hs-comment'>-- ^ The result kind</span>
<a name="line-1655"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded TcTyCon</span>
<a name="line-1656"></a><span class='hs-definition'>kcLHsQTyVars</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>cusk</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1657"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cusk</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcLHsQTyVars_Cusk</span>    <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1658"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcLHsQTyVars_NonCusk</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1659"></a>
<a name="line-1660"></a>
<a name="line-1661"></a><a name="kcLHsQTyVars_Cusk"></a><span class='hs-definition'>kcLHsQTyVars_Cusk</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcLHsQTyVars_NonCusk</span>
<a name="line-1662"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-1663"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-1664"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1665"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>          <span class='hs-comment'>-- ^ The result kind</span>
<a name="line-1666"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded TcTyCon</span>
<a name="line-1667"></a>
<a name="line-1668"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1669"></a><span class='hs-definition'>kcLHsQTyVars_Cusk</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-1670"></a>  <span class='hs-varid'>user_tyvars</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsQTvsRn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span>
<a name="line-1671"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_dependent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_names</span> <span class='hs-layout'>}</span>
<a name="line-1672"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1673"></a>  <span class='hs-comment'>-- CUSK case</span>
<a name="line-1674"></a>  <span class='hs-comment'>-- See note [Required, Specified, and Inferred for types] in TcTyClsDecls</span>
<a name="line-1675"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>$</span>
<a name="line-1676"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1677"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushTcLevelM_</span>                               <span class='hs-varop'>$</span>
<a name="line-1678"></a>              <span class='hs-varid'>solveEqualities</span>                             <span class='hs-varop'>$</span>
<a name="line-1679"></a>              <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>kv_ns</span>            <span class='hs-varop'>$</span>
<a name="line-1680"></a>              <span class='hs-varid'>bindExplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1681"></a>              <span class='hs-varid'>thing_inside</span>
<a name="line-1682"></a>
<a name="line-1683"></a>           <span class='hs-comment'>-- Now, because we're in a CUSK,</span>
<a name="line-1684"></a>           <span class='hs-comment'>-- we quantify over the mentioned kind vars</span>
<a name="line-1685"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_req_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1686"></a>             <span class='hs-varid'>all_kinds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_kind</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>spec_req_tkvs</span>
<a name="line-1687"></a>
<a name="line-1688"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>candidates</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKinds</span> <span class='hs-varid'>all_kinds</span>
<a name="line-1689"></a>             <span class='hs-comment'>-- 'candidates' are all the variables that we are going to</span>
<a name="line-1690"></a>             <span class='hs-comment'>-- skolemise and then quantify over.  We do not include spec_req_tvs</span>
<a name="line-1691"></a>             <span class='hs-comment'>-- because they are /already/ skolems</span>
<a name="line-1692"></a>
<a name="line-1693"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inf_candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>candidates</span> <span class='hs-varop'>`delCandidates`</span> <span class='hs-varid'>spec_req_tkvs</span>
<a name="line-1694"></a>
<a name="line-1695"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inferred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>inf_candidates</span>
<a name="line-1696"></a>                     <span class='hs-comment'>-- NB: 'inferred' comes back sorted in dependency order</span>
<a name="line-1697"></a>
<a name="line-1698"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-1699"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_tvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1700"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span>           <span class='hs-varid'>res_kind</span>
<a name="line-1701"></a>
<a name="line-1702"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mentioned_kv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>candidateKindVars</span> <span class='hs-varid'>candidates</span>
<a name="line-1703"></a>             <span class='hs-varid'>specified</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scopedSort</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-1704"></a>                                <span class='hs-comment'>-- NB: maintain the L-R order of scoped_kvs</span>
<a name="line-1705"></a>
<a name="line-1706"></a>             <span class='hs-varid'>final_tc_binders</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkNamedTyConBinders</span> <span class='hs-conid'>Inferred</span>  <span class='hs-varid'>inferred</span>
<a name="line-1707"></a>                              <span class='hs-varop'>++</span> <span class='hs-varid'>mkNamedTyConBinders</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>specified</span>
<a name="line-1708"></a>                              <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRequiredTyConBinder</span> <span class='hs-varid'>mentioned_kv_set</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1709"></a>
<a name="line-1710"></a>             <span class='hs-varid'>all_tv_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarNamePairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-1711"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>user_tyvars</span><span class='hs-layout'>)</span>
<a name="line-1712"></a>                               <span class='hs-varid'>final_tc_binders</span>
<a name="line-1713"></a>                               <span class='hs-varid'>res_kind</span>
<a name="line-1714"></a>                               <span class='hs-varid'>all_tv_prs</span>
<a name="line-1715"></a>                               <span class='hs-conid'>True</span> <span class='hs-comment'>{- it is generalised -}</span> <span class='hs-varid'>flav</span>
<a name="line-1716"></a>         <span class='hs-comment'>-- If the ordering from</span>
<a name="line-1717"></a>         <span class='hs-comment'>-- Note [Required, Specified, and Inferred for types] in TcTyClsDecls</span>
<a name="line-1718"></a>         <span class='hs-comment'>-- doesn't work, we catch it here, before an error cascade</span>
<a name="line-1719"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidTelescope</span> <span class='hs-varid'>tycon</span>
<a name="line-1720"></a>
<a name="line-1721"></a>          <span class='hs-comment'>-- If any of the specified tyvars aren't actually mentioned in a binder's</span>
<a name="line-1722"></a>          <span class='hs-comment'>-- kind (or the return kind), then we're in the CUSK case from</span>
<a name="line-1723"></a>          <span class='hs-comment'>-- Note [Free-floating kind vars]</span>
<a name="line-1724"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unmentioned_kvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>mentioned_kv_set</span><span class='hs-layout'>)</span> <span class='hs-varid'>specified</span>
<a name="line-1725"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportFloatingKvs</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>binderVar</span> <span class='hs-varid'>final_tc_binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>unmentioned_kvs</span>
<a name="line-1726"></a>
<a name="line-1727"></a>
<a name="line-1728"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcLHsQTyVars: cusk"</span> <span class='hs-varop'>$</span>
<a name="line-1729"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"name"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-1730"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kv_ns"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-1731"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"hs_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-1732"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"dep_names"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dep_names</span>
<a name="line-1733"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"scoped_kvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-1734"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tc_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1735"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"res_kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span>
<a name="line-1736"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"candidates"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>candidates</span>
<a name="line-1737"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"inferred"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inferred</span>
<a name="line-1738"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"specified"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>specified</span>
<a name="line-1739"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"final_tc_binders"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_tc_binders</span>
<a name="line-1740"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mkTyConKind final_tc_bndrs res_kind"</span>
<a name="line-1741"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>final_tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-1742"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"all_tv_prs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_tv_prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-1743"></a>
<a name="line-1744"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span>
<a name="line-1745"></a>  <span class='hs-keyword'>where</span>
<a name="line-1746"></a>    <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcFlavourIsOpen</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1747"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1748"></a>
<a name="line-1749"></a><span class='hs-definition'>kcLHsQTyVars_Cusk</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XLHsQTyVars</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kcLHsQTyVars"</span>
<a name="line-1750"></a>
<a name="line-1751"></a><a name="kcLHsQTyVars_NonCusk"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1752"></a><span class='hs-definition'>kcLHsQTyVars_NonCusk</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-1753"></a>  <span class='hs-varid'>user_tyvars</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsQTvsRn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span>
<a name="line-1754"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_dependent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dep_names</span> <span class='hs-layout'>}</span>
<a name="line-1755"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1756"></a>  <span class='hs-comment'>-- Non_CUSK case</span>
<a name="line-1757"></a>  <span class='hs-comment'>-- See note [Required, Specified, and Inferred for types] in TcTyClsDecls</span>
<a name="line-1758"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1759"></a>           <span class='hs-comment'>-- Why bindImplicitTKBndrs_Q_Tv which uses newTyVarTyVar?</span>
<a name="line-1760"></a>           <span class='hs-comment'>-- See Note [Inferring kinds for type declarations] in TcTyClsDecls</span>
<a name="line-1761"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span> <span class='hs-varid'>kv_ns</span>            <span class='hs-varop'>$</span>
<a name="line-1762"></a>              <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-1763"></a>              <span class='hs-varid'>thing_inside</span>
<a name="line-1764"></a>              <span class='hs-comment'>-- Why "_Tv" not "_Skol"? See third wrinkle in</span>
<a name="line-1765"></a>              <span class='hs-comment'>-- Note [Inferring kinds for type declarations] in TcTyClsDecls,</span>
<a name="line-1766"></a>
<a name="line-1767"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>   <span class='hs-comment'>-- NB: Don't add scoped_kvs to tyConTyVars, because they</span>
<a name="line-1768"></a>               <span class='hs-comment'>-- might unify with kind vars in other types in a mutually</span>
<a name="line-1769"></a>               <span class='hs-comment'>-- recursive group.</span>
<a name="line-1770"></a>               <span class='hs-comment'>-- See Note [Inferring kinds for type declarations] in TcTyClsDecls</span>
<a name="line-1771"></a>             <span class='hs-varid'>tc_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_tc_binder</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-1772"></a>               <span class='hs-comment'>-- Also, note that tc_binders has the tyvars from only the</span>
<a name="line-1773"></a>               <span class='hs-comment'>-- user-written tyvarbinders. See S1 in Note [How TcTyCons work]</span>
<a name="line-1774"></a>               <span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-1775"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>user_tyvars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span>
<a name="line-1776"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarNamePairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1777"></a>                               <span class='hs-conid'>False</span> <span class='hs-comment'>-- not yet generalised</span>
<a name="line-1778"></a>                               <span class='hs-varid'>flav</span>
<a name="line-1779"></a>
<a name="line-1780"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcLHsQTyVars: not-cusk"</span> <span class='hs-varop'>$</span>
<a name="line-1781"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dep_names</span>
<a name="line-1782"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-1783"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1784"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span>
<a name="line-1785"></a>  <span class='hs-keyword'>where</span>
<a name="line-1786"></a>    <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcFlavourIsOpen</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1787"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1788"></a>
<a name="line-1789"></a>    <span class='hs-varid'>mk_tc_binder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConBinder</span>
<a name="line-1790"></a>    <span class='hs-comment'>-- See Note [Dependent LHsQTyVars]</span>
<a name="line-1791"></a>    <span class='hs-varid'>mk_tc_binder</span> <span class='hs-varid'>hs_tv</span> <span class='hs-varid'>tv</span>
<a name="line-1792"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>hs_tv</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>dep_names</span>
<a name="line-1793"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Required</span> <span class='hs-varid'>tv</span>
<a name="line-1794"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1795"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-varid'>tv</span>
<a name="line-1796"></a>
<a name="line-1797"></a><span class='hs-definition'>kcLHsQTyVars_NonCusk</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XLHsQTyVars</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kcLHsQTyVars"</span>
<a name="line-1798"></a>
<a name="line-1799"></a>
<a name="line-1800"></a><span class='hs-comment'>{- Note [Kind-checking tyvar binders for associated types]
<a name="line-1801"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1802"></a>When kind-checking the type-variable binders for associated
<a name="line-1803"></a>   data/newtype decls
<a name="line-1804"></a>   family decls
<a name="line-1805"></a>we behave specially for type variables that are already in scope;
<a name="line-1806"></a>that is, bound by the enclosing class decl.  This is done in
<a name="line-1807"></a>kcLHsQTyVarBndrs:
<a name="line-1808"></a>  * The use of tcImplicitQTKBndrs
<a name="line-1809"></a>  * The tcLookupLocal_maybe code in kc_hs_tv
<a name="line-1810"></a>
<a name="line-1811"></a>See Note [Associated type tyvar names] in Class and
<a name="line-1812"></a>    Note [TyVar binders for associated decls] in HsDecls
<a name="line-1813"></a>
<a name="line-1814"></a>We must do the same for family instance decls, where the in-scope
<a name="line-1815"></a>variables may be bound by the enclosing class instance decl.
<a name="line-1816"></a>Hence the use of tcImplicitQTKBndrs in tcFamTyPatsAndGen.
<a name="line-1817"></a>
<a name="line-1818"></a>Note [Kind variable ordering for associated types]
<a name="line-1819"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1820"></a>What should be the kind of `T` in the following example? (#15591)
<a name="line-1821"></a>
<a name="line-1822"></a>  class C (a :: Type) where
<a name="line-1823"></a>    type T (x :: f a)
<a name="line-1824"></a>
<a name="line-1825"></a>As per Note [Ordering of implicit variables] in RnTypes, we want to quantify
<a name="line-1826"></a>the kind variables in left-to-right order of first occurrence in order to
<a name="line-1827"></a>support visible kind application. But we cannot perform this analysis on just
<a name="line-1828"></a>T alone, since its variable `a` actually occurs /before/ `f` if you consider
<a name="line-1829"></a>the fact that `a` was previously bound by the parent class `C`. That is to say,
<a name="line-1830"></a>the kind of `T` should end up being:
<a name="line-1831"></a>
<a name="line-1832"></a>  T :: forall a f. f a -&gt; Type
<a name="line-1833"></a>
<a name="line-1834"></a>(It wouldn't necessarily be /wrong/ if the kind ended up being, say,
<a name="line-1835"></a>forall f a. f a -&gt; Type, but that would not be as predictable for users of
<a name="line-1836"></a>visible kind application.)
<a name="line-1837"></a>
<a name="line-1838"></a>In contrast, if `T` were redefined to be a top-level type family, like `T2`
<a name="line-1839"></a>below:
<a name="line-1840"></a>
<a name="line-1841"></a>  type family T2 (x :: f (a :: Type))
<a name="line-1842"></a>
<a name="line-1843"></a>Then `a` first appears /after/ `f`, so the kind of `T2` should be:
<a name="line-1844"></a>
<a name="line-1845"></a>  T2 :: forall f a. f a -&gt; Type
<a name="line-1846"></a>
<a name="line-1847"></a>In order to make this distinction, we need to know (in kcLHsQTyVars) which
<a name="line-1848"></a>type variables have been bound by the parent class (if there is one). With
<a name="line-1849"></a>the class-bound variables in hand, we can ensure that we always quantify
<a name="line-1850"></a>these first.
<a name="line-1851"></a>-}</span>
<a name="line-1852"></a>
<a name="line-1853"></a>
<a name="line-1854"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1855"></a>*                                                                      *
<a name="line-1856"></a>             Expected kinds
<a name="line-1857"></a>*                                                                      *
<a name="line-1858"></a>********************************************************************* -}</span>
<a name="line-1859"></a>
<a name="line-1860"></a><a name="ContextKind"></a><span class='hs-comment'>-- | Describes the kind expected in a certain context.</span>
<a name="line-1861"></a><a name="ContextKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-conid'>Kind</span>   <span class='hs-comment'>-- ^ a specific kind</span>
<a name="line-1862"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnyKind</span>        <span class='hs-comment'>-- ^ any kind will do</span>
<a name="line-1863"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpenKind</span>       <span class='hs-comment'>-- ^ something of the form @TYPE _@</span>
<a name="line-1864"></a>
<a name="line-1865"></a><a name="newExpectedKind"></a><span class='hs-comment'>-----------------------</span>
<a name="line-1866"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1867"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TheKind</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-1868"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-conid'>AnyKind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1869"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-conid'>OpenKind</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-1870"></a>
<a name="line-1871"></a><a name="expectedKindInCtxt"></a><span class='hs-comment'>-----------------------</span>
<a name="line-1872"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span>
<a name="line-1873"></a><span class='hs-comment'>-- Depending on the context, we might accept any kind (for instance, in a TH</span>
<a name="line-1874"></a><span class='hs-comment'>-- splice), or only certain kinds (like in type signatures).</span>
<a name="line-1875"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1876"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>ThBrackCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1877"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhciCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1878"></a><span class='hs-comment'>-- The types in a 'default' decl can have varying kinds</span>
<a name="line-1879"></a><span class='hs-comment'>-- See Note [Extended defaults]" in TcEnv</span>
<a name="line-1880"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>DefaultDeclCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1881"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>TypeAppCtxt</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-1882"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1883"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1884"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>SpecInstCtxt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1885"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpenKind</span>
<a name="line-1886"></a>
<a name="line-1887"></a>
<a name="line-1888"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1889"></a>*                                                                      *
<a name="line-1890"></a>             Bringing type variables into scope
<a name="line-1891"></a>*                                                                      *
<a name="line-1892"></a>********************************************************************* -}</span>
<a name="line-1893"></a>
<a name="line-1894"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-1895"></a><span class='hs-comment'>-- Implicit binders</span>
<a name="line-1896"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-1897"></a>
<a name="line-1898"></a><a name="bindImplicitTKBndrs_Skol"></a><span class='hs-definition'>bindImplicitTKBndrs_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Tv</span><span class='hs-layout'>,</span>
<a name="line-1899"></a>  <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span>
<a name="line-1900"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1901"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1903"></a><span class='hs-definition'>bindImplicitTKBndrs_Skol</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-varid'>newFlexiKindedSkolemTyVar</span>
<a name="line-1904"></a><a name="bindImplicitTKBndrs_Tv"></a><span class='hs-definition'>bindImplicitTKBndrs_Tv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-varid'>newFlexiKindedTyVarTyVar</span>
<a name="line-1905"></a><a name="bindImplicitTKBndrs_Q_Skol"></a><span class='hs-definition'>bindImplicitTKBndrs_Q_Skol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>newImplicitTyVarQ</span> <span class='hs-varid'>newFlexiKindedSkolemTyVar</span><span class='hs-layout'>)</span>
<a name="line-1906"></a><a name="bindImplicitTKBndrs_Q_Tv"></a><span class='hs-definition'>bindImplicitTKBndrs_Q_Tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>newImplicitTyVarQ</span> <span class='hs-varid'>newFlexiKindedTyVarTyVar</span><span class='hs-layout'>)</span>
<a name="line-1907"></a>
<a name="line-1908"></a><a name="bindImplicitTKBndrsX"></a><span class='hs-definition'>bindImplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- new_tv function</span>
<a name="line-1909"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-1910"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1911"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- these tyvars are dependency-ordered</span>
<a name="line-1912"></a><span class='hs-comment'>-- * Guarantees to call solveLocalEqualities to unify</span>
<a name="line-1913"></a><span class='hs-comment'>--   all constraints from thing_inside.</span>
<a name="line-1914"></a><span class='hs-comment'>--</span>
<a name="line-1915"></a><span class='hs-comment'>-- * Returned TcTyVars have the supplied HsTyVarBndrs,</span>
<a name="line-1916"></a><span class='hs-comment'>--   but may be in different order to the original [Name]</span>
<a name="line-1917"></a><span class='hs-comment'>--   (because of sorting to respect dependency)</span>
<a name="line-1918"></a><span class='hs-comment'>--</span>
<a name="line-1919"></a><span class='hs-comment'>-- * Returned TcTyVars have zonked kinds</span>
<a name="line-1920"></a><span class='hs-comment'>--   See Note [Keeping scoped variables in order: Implicit]</span>
<a name="line-1921"></a><span class='hs-definition'>bindImplicitTKBndrsX</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1922"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_names</span>
<a name="line-1923"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tkvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1924"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindImplicitTKBndrs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tkvs</span><span class='hs-layout'>)</span>
<a name="line-1925"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1926"></a>
<a name="line-1927"></a><a name="newImplicitTyVarQ"></a><span class='hs-definition'>newImplicitTyVarQ</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1928"></a><span class='hs-comment'>-- Behave like new_tv, except that if the tyvar is in scope, use it</span>
<a name="line-1929"></a><span class='hs-definition'>newImplicitTyVarQ</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span>
<a name="line-1930"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>name</span>
<a name="line-1931"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span>
<a name="line-1932"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span>
<a name="line-1933"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1934"></a>
<a name="line-1935"></a><a name="newFlexiKindedTyVar"></a><span class='hs-definition'>newFlexiKindedTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-1936"></a><span class='hs-definition'>newFlexiKindedTyVar</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span>
<a name="line-1937"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1938"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1939"></a>
<a name="line-1940"></a><a name="newFlexiKindedSkolemTyVar"></a><span class='hs-definition'>newFlexiKindedSkolemTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-1941"></a><span class='hs-definition'>newFlexiKindedSkolemTyVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newFlexiKindedTyVar</span> <span class='hs-varid'>newSkolemTyVar</span>
<a name="line-1942"></a>
<a name="line-1943"></a><a name="newFlexiKindedTyVarTyVar"></a><span class='hs-definition'>newFlexiKindedTyVarTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-1944"></a><span class='hs-definition'>newFlexiKindedTyVarTyVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newFlexiKindedTyVar</span> <span class='hs-varid'>newTyVarTyVar</span>
<a name="line-1945"></a>
<a name="line-1946"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-1947"></a><span class='hs-comment'>-- Explicit binders</span>
<a name="line-1948"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-1949"></a>
<a name="line-1950"></a><a name="bindExplicitTKBndrs_Skol"></a><span class='hs-definition'>bindExplicitTKBndrs_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Tv</span>
<a name="line-1951"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1952"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1953"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1954"></a>
<a name="line-1955"></a><span class='hs-definition'>bindExplicitTKBndrs_Skol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcHsTyVarBndr</span> <span class='hs-varid'>newSkolemTyVar</span><span class='hs-layout'>)</span>
<a name="line-1956"></a><a name="bindExplicitTKBndrs_Tv"></a><span class='hs-definition'>bindExplicitTKBndrs_Tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcHsTyVarBndr</span> <span class='hs-varid'>newTyVarTyVar</span><span class='hs-layout'>)</span>
<a name="line-1957"></a>
<a name="line-1958"></a><a name="bindExplicitTKBndrs_Q_Skol"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span>
<a name="line-1959"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span>
<a name="line-1960"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1961"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1962"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1963"></a>
<a name="line-1964"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcHsQTyVarBndr</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>newSkolemTyVar</span><span class='hs-layout'>)</span>
<a name="line-1965"></a><a name="bindExplicitTKBndrs_Q_Tv"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Tv</span>   <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcHsQTyVarBndr</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>newTyVarTyVar</span><span class='hs-layout'>)</span>
<a name="line-1966"></a>
<a name="line-1967"></a><a name="bindExplicitTKBndrsX"></a><span class='hs-comment'>-- | Used during the "kind-checking" pass in TcTyClsDecls only,</span>
<a name="line-1968"></a><span class='hs-comment'>-- and even then only for data-con declarations.</span>
<a name="line-1969"></a><span class='hs-definition'>bindExplicitTKBndrsX</span>
<a name="line-1970"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-1971"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-1972"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1973"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1974"></a><span class='hs-definition'>bindExplicitTKBndrsX</span> <span class='hs-varid'>tc_tv</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1975"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindExplicTKBndrs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span>
<a name="line-1976"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span>
<a name="line-1977"></a>  <span class='hs-keyword'>where</span>
<a name="line-1978"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1979"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1980"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span>
<a name="line-1981"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_tv</span> <span class='hs-varid'>hs_tv</span>
<a name="line-1982"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span>
<a name="line-1983"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1984"></a>
<a name="line-1985"></a><a name="tcHsTyVarBndr"></a><span class='hs-comment'>-----------------</span>
<a name="line-1986"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-1987"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1988"></a><span class='hs-comment'>-- Returned TcTyVar has the same name; no cloning</span>
<a name="line-1989"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1990"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1991"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_nm</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1992"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span><span class='hs-layout'>)</span>
<a name="line-1993"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarBndrKindCtxt</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span>
<a name="line-1994"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_nm</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1995"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XTyVarBndr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsTyVarBndr"</span>
<a name="line-1996"></a>
<a name="line-1997"></a><a name="tcHsQTyVarBndr"></a><span class='hs-comment'>-----------------</span>
<a name="line-1998"></a><span class='hs-definition'>tcHsQTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span>
<a name="line-1999"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2000"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2001"></a><span class='hs-comment'>-- Just like tcHsTyVarBndr, but also</span>
<a name="line-2002"></a><span class='hs-comment'>--   - uses the in-scope TyVar from class, if it exists</span>
<a name="line-2003"></a><span class='hs-comment'>--   - takes a ContextKind to use for the no-sig case</span>
<a name="line-2004"></a><span class='hs-definition'>tcHsQTyVarBndr</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2005"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>tv_nm</span>
<a name="line-2006"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span>
<a name="line-2007"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span>
<a name="line-2008"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-2009"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_nm</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2010"></a>
<a name="line-2011"></a><span class='hs-definition'>tcHsQTyVarBndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>new_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span><span class='hs-layout'>)</span>
<a name="line-2012"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarBndrKindCtxt</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span>
<a name="line-2013"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>tv_nm</span>
<a name="line-2014"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span>
<a name="line-2015"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2016"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>hs_tv</span><span class='hs-layout'>)</span>
<a name="line-2017"></a>                                        <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2018"></a>                       <span class='hs-comment'>-- This unify rejects:</span>
<a name="line-2019"></a>                       <span class='hs-comment'>--    class C (m :: * -&gt; *) where</span>
<a name="line-2020"></a>                       <span class='hs-comment'>--      type F (m :: *) = ...</span>
<a name="line-2021"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-2022"></a>
<a name="line-2023"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>tv_nm</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-2024"></a>  <span class='hs-keyword'>where</span>
<a name="line-2025"></a>    <span class='hs-varid'>hs_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>noExt</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>tv_nm</span><span class='hs-layout'>)</span>
<a name="line-2026"></a>            <span class='hs-comment'>-- Used for error messages only</span>
<a name="line-2027"></a>
<a name="line-2028"></a><span class='hs-definition'>tcHsQTyVarBndr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XTyVarBndr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsTyVarBndr"</span>
<a name="line-2029"></a>
<a name="line-2030"></a>
<a name="line-2031"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2032"></a><span class='hs-comment'>-- Binding type/class variables in the</span>
<a name="line-2033"></a><span class='hs-comment'>-- kind-checking and typechecking phases</span>
<a name="line-2034"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2035"></a>
<a name="line-2036"></a><a name="bindTyClTyVars"></a><span class='hs-definition'>bindTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-2037"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2038"></a><span class='hs-comment'>-- ^ Used for the type variables of a type or class decl</span>
<a name="line-2039"></a><span class='hs-comment'>-- in the "kind checking" and "type checking" pass,</span>
<a name="line-2040"></a><span class='hs-comment'>-- but not in the initial-kind run.</span>
<a name="line-2041"></a><span class='hs-definition'>bindTyClTyVars</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2042"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupTcTyCon</span> <span class='hs-varid'>tycon_name</span>
<a name="line-2043"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scoped_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyConScopedTyVars</span> <span class='hs-varid'>tycon</span>
<a name="line-2044"></a>             <span class='hs-varid'>res_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tycon</span>
<a name="line-2045"></a>             <span class='hs-varid'>binders</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tycon</span>
<a name="line-2046"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindTyClTyVars"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-2047"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>scoped_prs</span> <span class='hs-varop'>$</span>
<a name="line-2048"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-layout'>}</span>
<a name="line-2049"></a>
<a name="line-2050"></a><a name="kcLookupTcTyCon"></a><span class='hs-comment'>-- getInitialKind has made a suitably-shaped kind for the type or class</span>
<a name="line-2051"></a><span class='hs-comment'>-- Look it up in the local environment. This is used only for tycons</span>
<a name="line-2052"></a><span class='hs-comment'>-- that we're currently type-checking, so we're sure to find a TcTyCon.</span>
<a name="line-2053"></a><span class='hs-definition'>kcLookupTcTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>
<a name="line-2054"></a><span class='hs-definition'>kcLookupTcTyCon</span> <span class='hs-varid'>nm</span>
<a name="line-2055"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>nm</span>
<a name="line-2056"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyword'>of</span>
<a name="line-2057"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-2058"></a>           <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcLookupTcTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_ty_thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2059"></a>
<a name="line-2060"></a>
<a name="line-2061"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2062"></a>*                                                                      *
<a name="line-2063"></a>             Kind generalisation
<a name="line-2064"></a>*                                                                      *
<a name="line-2065"></a>********************************************************************* -}</span>
<a name="line-2066"></a>
<a name="line-2067"></a><a name="zonkAndScopedSort"></a><span class='hs-definition'>zonkAndScopedSort</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2068"></a><span class='hs-definition'>zonkAndScopedSort</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-2069"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-2070"></a>          <span class='hs-comment'>-- Use zonkTcTyCoVarBndr because a skol_tv might be a TyVarTv</span>
<a name="line-2071"></a>
<a name="line-2072"></a>       <span class='hs-comment'>-- Do a stable topological sort, following</span>
<a name="line-2073"></a>       <span class='hs-comment'>-- Note [Ordering of implicit variables] in RnTypes</span>
<a name="line-2074"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>scopedSort</span> <span class='hs-varid'>spec_tkvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2075"></a>
<a name="line-2076"></a><a name="kindGeneralize"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2077"></a><span class='hs-comment'>-- Quantify the free kind variables of a kind or type</span>
<a name="line-2078"></a><span class='hs-comment'>-- In the latter case the type is closed, so it has no free</span>
<a name="line-2079"></a><span class='hs-comment'>-- type variables.  So in both cases, all the free vars are kind vars</span>
<a name="line-2080"></a><span class='hs-comment'>-- Input needn't be zonked. All variables to be quantified must</span>
<a name="line-2081"></a><span class='hs-comment'>-- have a TcLevel higher than the ambient TcLevel.</span>
<a name="line-2082"></a><span class='hs-comment'>-- NB: You must call solveEqualities or solveLocalEqualities before</span>
<a name="line-2083"></a><span class='hs-comment'>-- kind generalization</span>
<a name="line-2084"></a><span class='hs-comment'>--</span>
<a name="line-2085"></a><span class='hs-comment'>-- NB: this function is just a specialised version of</span>
<a name="line-2086"></a><span class='hs-comment'>--        kindGeneralizeLocal emptyWC kind_or_type</span>
<a name="line-2087"></a><span class='hs-comment'>--</span>
<a name="line-2088"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2089"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2090"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kindGeneralise1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kt</span><span class='hs-layout'>)</span>
<a name="line-2091"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKind</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2092"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-2093"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kindGeneralize"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2094"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2095"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>}</span>
<a name="line-2096"></a>
<a name="line-2097"></a><a name="kindGeneralizeLocal"></a><span class='hs-comment'>-- | This variant of 'kindGeneralize' refuses to generalize over any</span>
<a name="line-2098"></a><span class='hs-comment'>-- variables free in the given WantedConstraints. Instead, it promotes</span>
<a name="line-2099"></a><span class='hs-comment'>-- these variables into an outer TcLevel. All variables to be quantified must</span>
<a name="line-2100"></a><span class='hs-comment'>-- have a TcLevel higher than the ambient TcLevel. See also</span>
<a name="line-2101"></a><span class='hs-comment'>-- Note [Promoting unification variables] in TcSimplify</span>
<a name="line-2102"></a><span class='hs-definition'>kindGeneralizeLocal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2103"></a><span class='hs-definition'>kindGeneralizeLocal</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-2105"></a>       <span class='hs-comment'>-- This bit is very much like decideMonoTyVars in TcSimplify,</span>
<a name="line-2106"></a>       <span class='hs-comment'>-- but constraints are so much simpler in kinds, it is much</span>
<a name="line-2107"></a>       <span class='hs-comment'>-- easier here. (In particular, we never quantify over a</span>
<a name="line-2108"></a>       <span class='hs-comment'>-- constraint in a type.)</span>
<a name="line-2109"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>constrained</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyCoVarsAndFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-2110"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>constrained</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteTyVarSet</span> <span class='hs-varid'>constrained</span>
<a name="line-2111"></a>
<a name="line-2112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-2113"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mono_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>constrained</span>
<a name="line-2114"></a>
<a name="line-2115"></a>         <span class='hs-comment'>-- use the "Kind" variant here, as any types we see</span>
<a name="line-2116"></a>         <span class='hs-comment'>-- here will already have all type variables quantified;</span>
<a name="line-2117"></a>         <span class='hs-comment'>-- thus, every free variable is really a kv, never a tv.</span>
<a name="line-2118"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKind</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2119"></a>
<a name="line-2120"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kindGeneralizeLocal"</span> <span class='hs-varop'>$</span>
<a name="line-2121"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Wanted:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span>
<a name="line-2122"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind or type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-2123"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tcvs of wanted:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2124"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"constrained:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>constrained</span><span class='hs-layout'>)</span>
<a name="line-2125"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mono_tvs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>mono_tvs</span><span class='hs-layout'>)</span>
<a name="line-2126"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"dvs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-2127"></a>
<a name="line-2128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>mono_tvs</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>}</span>
<a name="line-2129"></a>
<a name="line-2130"></a><span class='hs-comment'>{- Note [Levels and generalisation]
<a name="line-2131"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2132"></a>Consider
<a name="line-2133"></a>  f x = e
<a name="line-2134"></a>with no type signature. We are currently at level i.
<a name="line-2135"></a>We must
<a name="line-2136"></a>  * Push the level to level (i+1)
<a name="line-2137"></a>  * Allocate a fresh alpha[i+1] for the result type
<a name="line-2138"></a>  * Check that e :: alpha[i+1], gathering constraint WC
<a name="line-2139"></a>  * Solve WC as far as possible
<a name="line-2140"></a>  * Zonking the result type alpha[i+1], say to beta[i-1] -&gt; gamma[i]
<a name="line-2141"></a>  * Find the free variables with level &gt; i, in this case gamma[i]
<a name="line-2142"></a>  * Skolemise those free variables and quantify over them, giving
<a name="line-2143"></a>       f :: forall g. beta[i-1] -&gt; g
<a name="line-2144"></a>  * Emit the residiual constraint wrapped in an implication for g,
<a name="line-2145"></a>    thus   forall g. WC
<a name="line-2146"></a>
<a name="line-2147"></a>All of this happens for types too.  Consider
<a name="line-2148"></a>  f :: Int -&gt; (forall a. Proxy a -&gt; Int)
<a name="line-2149"></a>
<a name="line-2150"></a>Note [Kind generalisation]
<a name="line-2151"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2152"></a>We do kind generalisation only at the outer level of a type signature.
<a name="line-2153"></a>For example, consider
<a name="line-2154"></a>  T :: forall k. k -&gt; *
<a name="line-2155"></a>  f :: (forall a. T a -&gt; Int) -&gt; Int
<a name="line-2156"></a>When kind-checking f's type signature we generalise the kind at
<a name="line-2157"></a>the outermost level, thus:
<a name="line-2158"></a>  f1 :: forall k. (forall (a:k). T k a -&gt; Int) -&gt; Int  -- YES!
<a name="line-2159"></a>and *not* at the inner forall:
<a name="line-2160"></a>  f2 :: (forall k. forall (a:k). T k a -&gt; Int) -&gt; Int  -- NO!
<a name="line-2161"></a>Reason: same as for HM inference on value level declarations,
<a name="line-2162"></a>we want to infer the most general type.  The f2 type signature
<a name="line-2163"></a>would be *less applicable* than f1, because it requires a more
<a name="line-2164"></a>polymorphic argument.
<a name="line-2165"></a>
<a name="line-2166"></a>NB: There are no explicit kind variables written in f's signature.
<a name="line-2167"></a>When there are, the renamer adds these kind variables to the list of
<a name="line-2168"></a>variables bound by the forall, so you can indeed have a type that's
<a name="line-2169"></a>higher-rank in its kind. But only by explicit request.
<a name="line-2170"></a>
<a name="line-2171"></a>Note [Kinds of quantified type variables]
<a name="line-2172"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2173"></a>tcTyVarBndrsGen quantifies over a specified list of type variables,
<a name="line-2174"></a>*and* over the kind variables mentioned in the kinds of those tyvars.
<a name="line-2175"></a>
<a name="line-2176"></a>Note that we must zonk those kinds (obviously) but less obviously, we
<a name="line-2177"></a>must return type variables whose kinds are zonked too. Example
<a name="line-2178"></a>    (a :: k7)  where  k7 := k9 -&gt; k9
<a name="line-2179"></a>We must return
<a name="line-2180"></a>    [k9, a:k9-&gt;k9]
<a name="line-2181"></a>and NOT
<a name="line-2182"></a>    [k9, a:k7]
<a name="line-2183"></a>Reason: we're going to turn this into a for-all type,
<a name="line-2184"></a>   forall k9. forall (a:k7). blah
<a name="line-2185"></a>which the type checker will then instantiate, and instantiate does not
<a name="line-2186"></a>look through unification variables!
<a name="line-2187"></a>
<a name="line-2188"></a>Hence using zonked_kinds when forming tvs'.
<a name="line-2189"></a>
<a name="line-2190"></a>-}</span>
<a name="line-2191"></a>
<a name="line-2192"></a><a name="etaExpandAlgTyCon"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-2193"></a><span class='hs-definition'>etaExpandAlgTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-2194"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2195"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-2196"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-2197"></a><span class='hs-comment'>--      e.g.  data T a :: * -&gt; * -&gt; * where ...</span>
<a name="line-2198"></a><span class='hs-comment'>-- This function makes up suitable (kinded) TyConBinders for the</span>
<a name="line-2199"></a><span class='hs-comment'>-- argument kinds.  E.g. in this case it might return</span>
<a name="line-2200"></a><span class='hs-comment'>--   ([b::*, c::*], *)</span>
<a name="line-2201"></a><span class='hs-comment'>-- Never emits constraints.</span>
<a name="line-2202"></a><span class='hs-comment'>-- It's a little trickier than you might think: see</span>
<a name="line-2203"></a><span class='hs-comment'>-- Note [TyConBinders for the result kind signature of a data type]</span>
<a name="line-2204"></a><span class='hs-definition'>etaExpandAlgTyCon</span> <span class='hs-varid'>tc_bndrs</span> <span class='hs-varid'>kind</span>
<a name="line-2205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-2206"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>uniqs</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-2207"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-2208"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>occ</span>
<a name="line-2209"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allNameStrings</span>
<a name="line-2210"></a>                         <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-2211"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-2212"></a>                         <span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-2213"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>lhs_occs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2214"></a>              <span class='hs-varid'>new_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>uniqs</span>
<a name="line-2215"></a>              <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>lhs_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2216"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_occs</span> <span class='hs-varid'>new_uniqs</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2217"></a>  <span class='hs-keyword'>where</span>
<a name="line-2218"></a>    <span class='hs-varid'>lhs_tvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>binderVar</span> <span class='hs-varid'>tc_bndrs</span>
<a name="line-2219"></a>    <span class='hs-varid'>lhs_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>lhs_tvs</span>
<a name="line-2220"></a>
<a name="line-2221"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>uniqs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>kind</span>
<a name="line-2222"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitPiTy_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-2223"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2224"></a>
<a name="line-2225"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-2226"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs'</span> <span class='hs-varid'>uniqs'</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-2227"></a>            <span class='hs-keyword'>where</span>
<a name="line-2228"></a>              <span class='hs-varid'>arg'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>arg</span>
<a name="line-2229"></a>              <span class='hs-varid'>tv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg'</span>
<a name="line-2230"></a>              <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-2231"></a>              <span class='hs-varid'>tcb</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>AnonTCB</span>
<a name="line-2232"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-conop'>:</span><span class='hs-varid'>uniqs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqs</span>
<a name="line-2233"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>occ</span><span class='hs-conop'>:</span><span class='hs-varid'>occs'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occs</span>
<a name="line-2234"></a>
<a name="line-2235"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-2236"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>uniqs</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-2237"></a>            <span class='hs-keyword'>where</span>
<a name="line-2238"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-2239"></a>              <span class='hs-varid'>tcb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-2240"></a>
<a name="line-2241"></a><a name="badKindSig"></a><span class='hs-definition'>badKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2242"></a><span class='hs-definition'>badKindSig</span> <span class='hs-varid'>check_for_type</span> <span class='hs-varid'>kind</span>
<a name="line-2243"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind signature on data type declaration has non-*"</span>
<a name="line-2244"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>check_for_type</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>empty</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"and non-variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2245"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"return kind"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2246"></a>        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2247"></a>
<a name="line-2248"></a><a name="tcbVisibilities"></a><span class='hs-definition'>tcbVisibilities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBndrVis</span><span class='hs-keyglyph'>]</span>
<a name="line-2249"></a><span class='hs-comment'>-- Result is in 1-1 correpondence with orig_args</span>
<a name="line-2250"></a><span class='hs-definition'>tcbVisibilities</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>orig_args</span>
<a name="line-2251"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>orig_args</span>
<a name="line-2252"></a>  <span class='hs-keyword'>where</span>
<a name="line-2253"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2254"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-2255"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-2256"></a>
<a name="line-2257"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2258"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitPiTy_maybe</span> <span class='hs-varid'>fun_kind</span>
<a name="line-2259"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcb</span> <span class='hs-keyword'>of</span>
<a name="line-2260"></a>          <span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnonTCB</span>      <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>inner_kind</span> <span class='hs-varid'>subst</span>  <span class='hs-varid'>args</span>
<a name="line-2261"></a>          <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>vis</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>inner_kind</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>args</span>
<a name="line-2262"></a>                 <span class='hs-keyword'>where</span>
<a name="line-2263"></a>                    <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span>
<a name="line-2264"></a>
<a name="line-2265"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-2266"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>all_args</span>
<a name="line-2267"></a>
<a name="line-2268"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2269"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addTcbVisibilities"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span>
<a name="line-2270"></a>
<a name="line-2271"></a>
<a name="line-2272"></a><span class='hs-comment'>{- Note [TyConBinders for the result kind signature of a data type]
<a name="line-2273"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2274"></a>Given
<a name="line-2275"></a>  data T (a::*) :: * -&gt; forall k. k -&gt; *
<a name="line-2276"></a>we want to generate the extra TyConBinders for T, so we finally get
<a name="line-2277"></a>  (a::*) (b::*) (k::*) (c::k)
<a name="line-2278"></a>The function etaExpandAlgTyCon generates these extra TyConBinders from
<a name="line-2279"></a>the result kind signature.
<a name="line-2280"></a>
<a name="line-2281"></a>We need to take care to give the TyConBinders
<a name="line-2282"></a>  (a) OccNames that are fresh (because the TyConBinders of a TyCon
<a name="line-2283"></a>      must have distinct OccNames
<a name="line-2284"></a>
<a name="line-2285"></a>  (b) Uniques that are fresh (obviously)
<a name="line-2286"></a>
<a name="line-2287"></a>For (a) we need to avoid clashes with the tyvars declared by
<a name="line-2288"></a>the user before the "::"; in the above example that is 'a'.
<a name="line-2289"></a>And also see Note [Avoid name clashes for associated data types].
<a name="line-2290"></a>
<a name="line-2291"></a>For (b) suppose we have
<a name="line-2292"></a>   data T :: forall k. k -&gt; forall k. k -&gt; *
<a name="line-2293"></a>where the two k's are identical even up to their uniques.  Surprisingly,
<a name="line-2294"></a>this can happen: see Trac #14515.
<a name="line-2295"></a>
<a name="line-2296"></a>It's reasonably easy to solve all this; just run down the list with a
<a name="line-2297"></a>substitution; hence the recursive 'go' function.  But it has to be
<a name="line-2298"></a>done.
<a name="line-2299"></a>
<a name="line-2300"></a>Note [Avoid name clashes for associated data types]
<a name="line-2301"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2302"></a>Consider    class C a b where
<a name="line-2303"></a>               data D b :: * -&gt; *
<a name="line-2304"></a>When typechecking the decl for D, we'll invent an extra type variable
<a name="line-2305"></a>for D, to fill out its kind.  Ideally we don't want this type variable
<a name="line-2306"></a>to be 'a', because when pretty printing we'll get
<a name="line-2307"></a>            class C a b where
<a name="line-2308"></a>               data D b a0
<a name="line-2309"></a>(NB: the tidying happens in the conversion to IfaceSyn, which happens
<a name="line-2310"></a>as part of pretty-printing a TyThing.)
<a name="line-2311"></a>
<a name="line-2312"></a>That's why we look in the LocalRdrEnv to see what's in scope. This is
<a name="line-2313"></a>important only to get nice-looking output when doing ":info C" in GHCi.
<a name="line-2314"></a>It isn't essential for correctness.
<a name="line-2315"></a>
<a name="line-2316"></a>
<a name="line-2317"></a>************************************************************************
<a name="line-2318"></a>*                                                                      *
<a name="line-2319"></a>             Partial signatures
<a name="line-2320"></a>*                                                                      *
<a name="line-2321"></a>************************************************************************
<a name="line-2322"></a>
<a name="line-2323"></a>-}</span>
<a name="line-2324"></a>
<a name="line-2325"></a><a name="tcHsPartialSigType"></a><span class='hs-definition'>tcHsPartialSigType</span>
<a name="line-2326"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-2327"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>       <span class='hs-comment'>-- The type signature</span>
<a name="line-2328"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Wildcards</span>
<a name="line-2329"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>       <span class='hs-comment'>-- Extra-constraints wildcard</span>
<a name="line-2330"></a>         <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Original tyvar names, in correspondence with ...</span>
<a name="line-2331"></a>         <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- ... Implicitly and explicitly bound type variables</span>
<a name="line-2332"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span>        <span class='hs-comment'>-- Theta part</span>
<a name="line-2333"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>)</span>           <span class='hs-comment'>-- Tau part</span>
<a name="line-2334"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature]</span>
<a name="line-2335"></a><span class='hs-definition'>tcHsPartialSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2336"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span>         <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ib_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2337"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_hs_tvs</span>
<a name="line-2338"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ib_ty</span>
<a name="line-2339"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>explicit_hs_tvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsSigmaTy</span> <span class='hs-varid'>hs_ty</span>
<a name="line-2340"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-2341"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>explicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2342"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardBinders</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2343"></a>               <span class='hs-varid'>bindImplicitTKBndrs_Tv</span> <span class='hs-varid'>implicit_hs_tvs</span>       <span class='hs-varop'>$</span>
<a name="line-2344"></a>               <span class='hs-varid'>bindExplicitTKBndrs_Tv</span> <span class='hs-varid'>explicit_hs_tvs</span>       <span class='hs-varop'>$</span>
<a name="line-2345"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Instantiate the type-class context; but if there</span>
<a name="line-2346"></a>                      <span class='hs-comment'>-- is an extra-constraints wildcard, just discard it here</span>
<a name="line-2347"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPartialContext</span> <span class='hs-varid'>hs_ctxt</span>
<a name="line-2348"></a>
<a name="line-2349"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_tau</span>
<a name="line-2350"></a>
<a name="line-2351"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2352"></a>
<a name="line-2353"></a>         <span class='hs-comment'>-- We must return these separately, because all the zonking below</span>
<a name="line-2354"></a>         <span class='hs-comment'>-- might change the name of a TyVarTv. This, in turn, causes trouble</span>
<a name="line-2355"></a>         <span class='hs-comment'>-- in partial type signatures that bind scoped type variables, as</span>
<a name="line-2356"></a>         <span class='hs-comment'>-- we bring the wrong name into scope in the function body.</span>
<a name="line-2357"></a>         <span class='hs-comment'>-- Test case: partial-sigs/should_compile/LocalDefinitionBug</span>
<a name="line-2358"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarName</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>explicit_tvs</span><span class='hs-layout'>)</span>
<a name="line-2359"></a>
<a name="line-2360"></a>       <span class='hs-comment'>-- Spit out the wildcards (including the extra-constraints one)</span>
<a name="line-2361"></a>       <span class='hs-comment'>-- as "hole" constraints, so that they'll be reported if necessary</span>
<a name="line-2362"></a>       <span class='hs-comment'>-- See Note [Extra-constraint holes in partial type signatures]</span>
<a name="line-2363"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitWildCardHoleConstraints</span> <span class='hs-varid'>wcs</span>
<a name="line-2364"></a>
<a name="line-2365"></a>         <span class='hs-comment'>-- The TyVarTvs created above will sometimes have too high a TcLevel</span>
<a name="line-2366"></a>         <span class='hs-comment'>-- (note that they are generated *after* bumping the level in</span>
<a name="line-2367"></a>         <span class='hs-comment'>-- the tc{Im,Ex}plicitTKBndrsSig functions. Bumping the level</span>
<a name="line-2368"></a>         <span class='hs-comment'>-- is still important here, because the kinds of these variables</span>
<a name="line-2369"></a>         <span class='hs-comment'>-- do indeed need to have the higher level, so they can unify</span>
<a name="line-2370"></a>         <span class='hs-comment'>-- with other local type variables. But, now that we've type-checked</span>
<a name="line-2371"></a>         <span class='hs-comment'>-- everything (and solved equalities in the tcImplicit call)</span>
<a name="line-2372"></a>         <span class='hs-comment'>-- we need to promote the TyVarTvs so we don't violate the TcLevel</span>
<a name="line-2373"></a>         <span class='hs-comment'>-- invariant</span>
<a name="line-2374"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-2375"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>explicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>explicit_tvs</span>
<a name="line-2376"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>theta</span>
<a name="line-2377"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tau</span>
<a name="line-2378"></a>
<a name="line-2379"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>explicit_tvs</span>
<a name="line-2380"></a>
<a name="line-2381"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-varid'>all_tvs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-2382"></a>
<a name="line-2383"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPartialSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>all_tvs</span><span class='hs-layout'>)</span>
<a name="line-2384"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>all_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2385"></a>
<a name="line-2386"></a><span class='hs-definition'>tcHsPartialSigType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWC</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsImplicitBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsPartialSigType"</span>
<a name="line-2387"></a><span class='hs-definition'>tcHsPartialSigType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsWildCardBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsPartialSigType"</span>
<a name="line-2388"></a>
<a name="line-2389"></a><a name="tcPartialContext"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsContext</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-2390"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-varid'>hs_theta</span>
<a name="line-2391"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_theta1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_ctxt_last</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>hs_theta</span>
<a name="line-2392"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ignoreParens</span> <span class='hs-varid'>hs_ctxt_last</span>
<a name="line-2393"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcWildCardOcc</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>constraintKind</span>
<a name="line-2394"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLHsPredType</span> <span class='hs-varid'>hs_theta1</span>
<a name="line-2395"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>wc_tv_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2396"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2397"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLHsPredType</span> <span class='hs-varid'>hs_theta</span>
<a name="line-2398"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2399"></a>
<a name="line-2400"></a><span class='hs-comment'>{- Note [Extra-constraint holes in partial type signatures]
<a name="line-2401"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2402"></a>Consider
<a name="line-2403"></a>  f :: (_) =&gt; a -&gt; a
<a name="line-2404"></a>  f x = ...
<a name="line-2405"></a>
<a name="line-2406"></a>* The renamer leaves '_' untouched.
<a name="line-2407"></a>
<a name="line-2408"></a>* Then, in tcHsPartialSigType, we make a new hole TcTyVar, in
<a name="line-2409"></a>  tcWildCardBinders.
<a name="line-2410"></a>
<a name="line-2411"></a>* TcBinds.chooseInferredQuantifiers fills in that hole TcTyVar
<a name="line-2412"></a>  with the inferred constraints, e.g. (Eq a, Show a)
<a name="line-2413"></a>
<a name="line-2414"></a>* TcErrors.mkHoleError finally reports the error.
<a name="line-2415"></a>
<a name="line-2416"></a>An annoying difficulty happens if there are more than 62 inferred
<a name="line-2417"></a>constraints. Then we need to fill in the TcTyVar with (say) a 70-tuple.
<a name="line-2418"></a>Where do we find the TyCon?  For good reasons we only have constraint
<a name="line-2419"></a>tuples up to 62 (see Note [How tuples work] in TysWiredIn).  So how
<a name="line-2420"></a>can we make a 70-tuple?  This was the root cause of Trac #14217.
<a name="line-2421"></a>
<a name="line-2422"></a>It's incredibly tiresome, because we only need this type to fill
<a name="line-2423"></a>in the hole, to communicate to the error reporting machinery.  Nothing
<a name="line-2424"></a>more.  So I use a HACK:
<a name="line-2425"></a>
<a name="line-2426"></a>* I make an /ordinary/ tuple of the constraints, in
<a name="line-2427"></a>  TcBinds.chooseInferredQuantifiers. This is ill-kinded because
<a name="line-2428"></a>  ordinary tuples can't contain constraints, but it works fine. And for
<a name="line-2429"></a>  ordinary tuples we don't have the same limit as for constraint
<a name="line-2430"></a>  tuples (which need selectors and an assocated class).
<a name="line-2431"></a>
<a name="line-2432"></a>* Because it is ill-kinded, it trips an assert in writeMetaTyVar,
<a name="line-2433"></a>  so now I disable the assertion if we are writing a type of
<a name="line-2434"></a>  kind Constraint.  (That seldom/never normally happens so we aren't
<a name="line-2435"></a>  losing much.)
<a name="line-2436"></a>
<a name="line-2437"></a>Result works fine, but it may eventually bite us.
<a name="line-2438"></a>
<a name="line-2439"></a>
<a name="line-2440"></a>************************************************************************
<a name="line-2441"></a>*                                                                      *
<a name="line-2442"></a>      Pattern signatures (i.e signatures that occur in patterns)
<a name="line-2443"></a>*                                                                      *
<a name="line-2444"></a>********************************************************************* -}</span>
<a name="line-2445"></a>
<a name="line-2446"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-2447"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>          <span class='hs-comment'>-- The type signature</span>
<a name="line-2448"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Wildcards</span>
<a name="line-2449"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-2450"></a>                                              <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-2451"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- The type</span>
<a name="line-2452"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-2453"></a><span class='hs-comment'>-- (a) patterns           e.g  f (x::Int) = e</span>
<a name="line-2454"></a><span class='hs-comment'>-- (b) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-2455"></a><span class='hs-comment'>--</span>
<a name="line-2456"></a><span class='hs-comment'>-- This may emit constraints</span>
<a name="line-2457"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature]</span>
<a name="line-2458"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2459"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span>   <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ib_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2460"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>HsIB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsib_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_vars</span>
<a name="line-2461"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>hsib_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ib_ty</span>
<a name="line-2462"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-2463"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>sig_vars</span>
<a name="line-2464"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-2465"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveLocalEqualities</span> <span class='hs-str'>"tcHsPatSigType"</span> <span class='hs-varop'>$</span>
<a name="line-2466"></a>                 <span class='hs-comment'>-- Always solve local equalities if possible,</span>
<a name="line-2467"></a>                 <span class='hs-comment'>-- else casts get in the way of deep skolemisation</span>
<a name="line-2468"></a>                 <span class='hs-comment'>-- (Trac #16033)</span>
<a name="line-2469"></a>               <span class='hs-varid'>tcWildCardBinders</span> <span class='hs-varid'>sig_wcs</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2470"></a>               <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>sig_tkvs</span>                           <span class='hs-varop'>$</span>
<a name="line-2471"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-2472"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2473"></a>
<a name="line-2474"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitWildCardHoleConstraints</span> <span class='hs-varid'>wcs</span>
<a name="line-2475"></a>
<a name="line-2476"></a>          <span class='hs-comment'>-- sig_ty might have tyvars that are at a higher TcLevel (if hs_ty</span>
<a name="line-2477"></a>          <span class='hs-comment'>-- contains a forall). Promote these.</span>
<a name="line-2478"></a>          <span class='hs-comment'>-- Ex: f (x :: forall a. Proxy a -&gt; ()) = ... x ...</span>
<a name="line-2479"></a>          <span class='hs-comment'>-- When we instantiate x, we have to compare the kind of the argument</span>
<a name="line-2480"></a>          <span class='hs-comment'>-- to a's kind, which will be a metavariable.</span>
<a name="line-2481"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPromoteType</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2482"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2483"></a>
<a name="line-2484"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarNamePairs</span> <span class='hs-varid'>sig_tkvs</span>
<a name="line-2485"></a>
<a name="line-2486"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPatSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_vars</span><span class='hs-layout'>)</span>
<a name="line-2487"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2488"></a>  <span class='hs-keyword'>where</span>
<a name="line-2489"></a>    <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2490"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-2491"></a>
<a name="line-2492"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-2493"></a>               <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSkolemTyVar</span>
<a name="line-2494"></a>               <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newTauTyVar</span>
<a name="line-2495"></a>      <span class='hs-comment'>-- See Note [Pattern signature binders]</span>
<a name="line-2496"></a>
<a name="line-2497"></a>
<a name="line-2498"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWC</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsImplicitBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsPatSigType"</span>
<a name="line-2499"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsWildCardBndrs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcHsPatSigType"</span>
<a name="line-2500"></a>
<a name="line-2501"></a><a name="tcPatSig"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                    <span class='hs-comment'>-- True &lt;=&gt; pattern binding</span>
<a name="line-2502"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-2503"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpSigmaType</span>
<a name="line-2504"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- The type to use for "inside" the signature</span>
<a name="line-2505"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-2506"></a>                                    <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-2507"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The wildcards</span>
<a name="line-2508"></a>                 <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- Coercion due to unification with actual ty</span>
<a name="line-2509"></a>                                    <span class='hs-comment'>-- Of shape:  res_ty ~ sig_ty</span>
<a name="line-2510"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>res_ty</span>
<a name="line-2511"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>sig</span>
<a name="line-2512"></a>        <span class='hs-comment'>-- sig_tvs are the type variables free in 'sig',</span>
<a name="line-2513"></a>        <span class='hs-comment'>-- and not already in scope. These are the ones</span>
<a name="line-2514"></a>        <span class='hs-comment'>-- that should be brought into scope</span>
<a name="line-2515"></a>
<a name="line-2516"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-2517"></a>                <span class='hs-comment'>-- Just do the subsumption check and return</span>
<a name="line-2518"></a>                  <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2519"></a>                          <span class='hs-varid'>tcSubTypeET</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2520"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-2521"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-2522"></a>                <span class='hs-comment'>-- Type signature binds at least one scoped type variable</span>
<a name="line-2523"></a>
<a name="line-2524"></a>                <span class='hs-comment'>-- A pattern binding cannot bind scoped type variables</span>
<a name="line-2525"></a>                <span class='hs-comment'>-- It is more convenient to make the test here</span>
<a name="line-2526"></a>                <span class='hs-comment'>-- than in the renamer</span>
<a name="line-2527"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>when</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2528"></a>
<a name="line-2529"></a>                <span class='hs-comment'>-- Check that all newly-in-scope tyvars are in fact</span>
<a name="line-2530"></a>                <span class='hs-comment'>-- constrained by the pattern.  This catches tiresome</span>
<a name="line-2531"></a>                <span class='hs-comment'>-- cases like</span>
<a name="line-2532"></a>                <span class='hs-comment'>--      type T a = Int</span>
<a name="line-2533"></a>                <span class='hs-comment'>--      f :: Int -&gt; Int</span>
<a name="line-2534"></a>                <span class='hs-comment'>--      f (x :: T a) = ...</span>
<a name="line-2535"></a>                <span class='hs-comment'>-- Here 'a' doesn't get a binding.  Sigh</span>
<a name="line-2536"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exactTyCoVarsOfType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-2537"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypeList</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-2538"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badPatTyVarTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-2539"></a>
<a name="line-2540"></a>        <span class='hs-comment'>-- Now do a subsumption check of the pattern signature against res_ty</span>
<a name="line-2541"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2542"></a>                  <span class='hs-varid'>tcSubTypeET</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2543"></a>
<a name="line-2544"></a>        <span class='hs-comment'>-- Phew!</span>
<a name="line-2545"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-2546"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2547"></a>  <span class='hs-keyword'>where</span>
<a name="line-2548"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>tidy_env</span>
<a name="line-2549"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>sig_ty</span>
<a name="line-2550"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readExpType</span> <span class='hs-varid'>res_ty</span>   <span class='hs-comment'>-- should be filled in by now</span>
<a name="line-2551"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>res_ty</span>
<a name="line-2552"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"When checking that the pattern signature:"</span><span class='hs-layout'>)</span>
<a name="line-2553"></a>                                  <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-2554"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"fits the type of its context:"</span><span class='hs-layout'>)</span>
<a name="line-2555"></a>                                          <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2556"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2557"></a>
<a name="line-2558"></a><a name="patBindSigErr"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2559"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-2560"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"You cannot bind scoped type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-2561"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2562"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"in a pattern binding signature"</span><span class='hs-layout'>)</span>
<a name="line-2563"></a>
<a name="line-2564"></a><span class='hs-comment'>{- Note [Pattern signature binders]
<a name="line-2565"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2566"></a>See also Note [Type variables in the type environment] in TcRnTypes.
<a name="line-2567"></a>Consider
<a name="line-2568"></a>
<a name="line-2569"></a>  data T where
<a name="line-2570"></a>    MkT :: forall a. a -&gt; (a -&gt; Int) -&gt; T
<a name="line-2571"></a>
<a name="line-2572"></a>  f :: T -&gt; ...
<a name="line-2573"></a>  f (MkT x (f :: b -&gt; c)) = &lt;blah&gt;
<a name="line-2574"></a>
<a name="line-2575"></a>Here
<a name="line-2576"></a> * The pattern (MkT p1 p2) creates a *skolem* type variable 'a_sk',
<a name="line-2577"></a>   It must be a skolem so that that it retains its identity, and
<a name="line-2578"></a>   TcErrors.getSkolemInfo can thereby find the binding site for the skolem.
<a name="line-2579"></a>
<a name="line-2580"></a> * The type signature pattern (f :: b -&gt; c) makes freshs meta-tyvars
<a name="line-2581"></a>   beta and gamma (TauTvs), and binds "b" :-&gt; beta, "c" :-&gt; gamma in the
<a name="line-2582"></a>   environment
<a name="line-2583"></a>
<a name="line-2584"></a> * Then unification makes beta := a_sk, gamma := Int
<a name="line-2585"></a>   That's why we must make beta and gamma a MetaTv,
<a name="line-2586"></a>   not a SkolemTv, so that it can unify to a_sk (or Int, respectively).
<a name="line-2587"></a>
<a name="line-2588"></a> * Finally, in '&lt;blah&gt;' we have the envt "b" :-&gt; beta, "c" :-&gt; gamma,
<a name="line-2589"></a>   so we return the pairs ("b" :-&gt; beta, "c" :-&gt; gamma) from tcHsPatSigType,
<a name="line-2590"></a>
<a name="line-2591"></a>Another example (Trac #13881):
<a name="line-2592"></a>   fl :: forall (l :: [a]). Sing l -&gt; Sing l
<a name="line-2593"></a>   fl (SNil :: Sing (l :: [y])) = SNil
<a name="line-2594"></a>When we reach the pattern signature, 'l' is in scope from the
<a name="line-2595"></a>outer 'forall':
<a name="line-2596"></a>   "a" :-&gt; a_sk :: *
<a name="line-2597"></a>   "l" :-&gt; l_sk :: [a_sk]
<a name="line-2598"></a>We make up a fresh meta-TauTv, y_sig, for 'y', and kind-check
<a name="line-2599"></a>the pattern signature
<a name="line-2600"></a>   Sing (l :: [y])
<a name="line-2601"></a>That unifies y_sig := a_sk.  We return from tcHsPatSigType with
<a name="line-2602"></a>the pair ("y" :-&gt; y_sig).
<a name="line-2603"></a>
<a name="line-2604"></a>For RULE binders, though, things are a bit different (yuk).
<a name="line-2605"></a>  RULE "foo" forall (x::a) (y::[a]).  f x y = ...
<a name="line-2606"></a>Here this really is the binding site of the type variable so we'd like
<a name="line-2607"></a>to use a skolem, so that we get a complaint if we unify two of them
<a name="line-2608"></a>together.  Hence the new_tv function in tcHsPatSigType.
<a name="line-2609"></a>
<a name="line-2610"></a>
<a name="line-2611"></a>************************************************************************
<a name="line-2612"></a>*                                                                      *
<a name="line-2613"></a>        Checking kinds
<a name="line-2614"></a>*                                                                      *
<a name="line-2615"></a>************************************************************************
<a name="line-2616"></a>
<a name="line-2617"></a>-}</span>
<a name="line-2618"></a>
<a name="line-2619"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-2620"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-2621"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2622"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-conid'>YesSaturation</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>kind</span>
<a name="line-2623"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-2624"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2625"></a>
<a name="line-2626"></a><span class='hs-comment'>{-
<a name="line-2627"></a>************************************************************************
<a name="line-2628"></a>*                                                                      *
<a name="line-2629"></a>    Promotion
<a name="line-2630"></a>*                                                                      *
<a name="line-2631"></a>************************************************************************
<a name="line-2632"></a>-}</span>
<a name="line-2633"></a>
<a name="line-2634"></a><a name="zonkPromoteType"></a><span class='hs-comment'>-- | Whenever a type is about to be added to the environment, it's necessary</span>
<a name="line-2635"></a><span class='hs-comment'>-- to make sure that any free meta-tyvars in the type are promoted to the</span>
<a name="line-2636"></a><span class='hs-comment'>-- current TcLevel. (They might be at a higher level due to the level-bumping</span>
<a name="line-2637"></a><span class='hs-comment'>-- in tcExplicitTKBndrs, for example.) This function both zonks *and*</span>
<a name="line-2638"></a><span class='hs-comment'>-- promotes. Why at the same time? See Note [Recipe for checking a signature]</span>
<a name="line-2639"></a><span class='hs-definition'>zonkPromoteType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-2640"></a><span class='hs-definition'>zonkPromoteType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapType</span> <span class='hs-varid'>zonkPromoteMapper</span> <span class='hs-conid'>()</span>
<a name="line-2641"></a>
<a name="line-2642"></a><a name="zonkPromoteMapper"></a><span class='hs-comment'>-- cf. TcMType.zonkTcTypeMapper</span>
<a name="line-2643"></a><span class='hs-definition'>zonkPromoteMapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoMapper</span> <span class='hs-conid'>()</span> <span class='hs-conid'>TcM</span>
<a name="line-2644"></a><span class='hs-definition'>zonkPromoteMapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoMapper</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcm_smart</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2645"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tyvar</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>zonkPromoteTcTyVar</span>
<a name="line-2646"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_covar</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>covar</span>
<a name="line-2647"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_hole</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>hole</span>
<a name="line-2648"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>tybinder</span>
<a name="line-2649"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcm_tycon</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>}</span>
<a name="line-2650"></a>  <span class='hs-keyword'>where</span>
<a name="line-2651"></a>    <span class='hs-varid'>covar</span> <span class='hs-varid'>cv</span>
<a name="line-2652"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-2653"></a>
<a name="line-2654"></a>    <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-2655"></a>    <span class='hs-varid'>hole</span> <span class='hs-varid'>h</span>
<a name="line-2656"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contents</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unpackCoercionHole_maybe</span> <span class='hs-varid'>h</span>
<a name="line-2657"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>contents</span> <span class='hs-keyword'>of</span>
<a name="line-2658"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPromoteCoercion</span> <span class='hs-varid'>co</span>
<a name="line-2659"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>checkCoercionHole</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-2660"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-2661"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHoleCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCoHoleCoVar</span> <span class='hs-varid'>h</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2662"></a>      <span class='hs-keyword'>where</span>
<a name="line-2663"></a>        <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span>
<a name="line-2664"></a>
<a name="line-2665"></a>    <span class='hs-varid'>tybinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-2666"></a>    <span class='hs-varid'>tybinder</span> <span class='hs-varid'>tv</span> <span class='hs-sel'>_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2667"></a>
<a name="line-2668"></a><a name="zonkPromoteTcTyVar"></a><span class='hs-definition'>zonkPromoteTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-2669"></a><span class='hs-definition'>zonkPromoteTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2670"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2671"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>metaTyVarRef</span> <span class='hs-varid'>tv</span>
<a name="line-2672"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>contents</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-2673"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>contents</span> <span class='hs-keyword'>of</span>
<a name="line-2674"></a>           <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>promoted_tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2675"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-varid'>promoted_tv</span> <span class='hs-layout'>}</span>
<a name="line-2676"></a>           <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkPromoteType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-2677"></a>
<a name="line-2678"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- NB: isSkolemTyVar says "True" to pure TyVars</span>
<a name="line-2679"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-2680"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteSkolem</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2681"></a>
<a name="line-2682"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2683"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>zonkPromoteTyCoVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2684"></a>
<a name="line-2685"></a><a name="zonkPromoteTyCoVarKind"></a><span class='hs-definition'>zonkPromoteTyCoVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCoVar</span>
<a name="line-2686"></a><span class='hs-definition'>zonkPromoteTyCoVarKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>zonkPromoteType</span>
<a name="line-2687"></a>
<a name="line-2688"></a><a name="zonkPromoteCoercion"></a><span class='hs-definition'>zonkPromoteCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Coercion</span>
<a name="line-2689"></a><span class='hs-definition'>zonkPromoteCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCoercion</span> <span class='hs-varid'>zonkPromoteMapper</span> <span class='hs-conid'>()</span>
<a name="line-2690"></a>
<a name="line-2691"></a><span class='hs-comment'>{-
<a name="line-2692"></a>************************************************************************
<a name="line-2693"></a>*                                                                      *
<a name="line-2694"></a>        Sort checking kinds
<a name="line-2695"></a>*                                                                      *
<a name="line-2696"></a>************************************************************************
<a name="line-2697"></a>
<a name="line-2698"></a>tcLHsKindSig converts a user-written kind to an internal, sort-checked kind.
<a name="line-2699"></a>It does sort checking and desugaring at the same time, in one single pass.
<a name="line-2700"></a>-}</span>
<a name="line-2701"></a>
<a name="line-2702"></a><a name="tcLHsKindSig"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2703"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_kind</span>
<a name="line-2704"></a><span class='hs-comment'>-- See  Note [Recipe for checking a signature] in TcHsType</span>
<a name="line-2705"></a><span class='hs-comment'>-- Result is zonked</span>
<a name="line-2706"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveLocalEqualities</span> <span class='hs-str'>"tcLHsKindSig"</span> <span class='hs-varop'>$</span>
<a name="line-2707"></a>                 <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kindLevelMode</span> <span class='hs-varid'>hs_kind</span>
<a name="line-2708"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcLHsKindSig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2709"></a>       <span class='hs-comment'>-- No generalization, so we must promote</span>
<a name="line-2710"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkPromoteType</span> <span class='hs-varid'>kind</span>
<a name="line-2711"></a>         <span class='hs-comment'>-- This zonk is very important in the case of higher rank kinds</span>
<a name="line-2712"></a>         <span class='hs-comment'>-- E.g. Trac #13879    f :: forall (p :: forall z (y::z). &lt;blah&gt;).</span>
<a name="line-2713"></a>         <span class='hs-comment'>--                          &lt;more blah&gt;</span>
<a name="line-2714"></a>         <span class='hs-comment'>--      When instantiating p's kind at occurrences of p in &lt;more blah&gt;</span>
<a name="line-2715"></a>         <span class='hs-comment'>--      it's crucial that the kind we instantiate is fully zonked,</span>
<a name="line-2716"></a>         <span class='hs-comment'>--      else we may fail to substitute properly</span>
<a name="line-2717"></a>
<a name="line-2718"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>kind</span>
<a name="line-2719"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcLHsKindSig2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-2720"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-2721"></a>
<a name="line-2722"></a><a name="tc_lhs_kind"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2723"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>k</span>
<a name="line-2724"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2725"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindLevel</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2726"></a>
<a name="line-2727"></a><a name="promotionErr"></a><span class='hs-definition'>promotionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2728"></a><span class='hs-definition'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-2729"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be used here"</span><span class='hs-layout'>)</span>
<a name="line-2730"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2731"></a>  <span class='hs-keyword'>where</span>
<a name="line-2732"></a>    <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-2733"></a>               <span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-varid'>pred</span>
<a name="line-2734"></a>                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it has an unpromotable context"</span>
<a name="line-2735"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-2736"></a>               <span class='hs-conid'>FamDataConPE</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it comes from a data family instance"</span>
<a name="line-2737"></a>               <span class='hs-conid'>NoDataKindsTC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"perhaps you intended to use DataKinds"</span>
<a name="line-2738"></a>               <span class='hs-conid'>NoDataKindsDC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"perhaps you intended to use DataKinds"</span>
<a name="line-2739"></a>               <span class='hs-conid'>PatSynPE</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"pattern synonyms cannot be promoted"</span>
<a name="line-2740"></a>               <span class='hs-conid'>PatSynExPE</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"the existential variables of a pattern synonym"</span>
<a name="line-2741"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"signature do not scope over the pattern"</span> <span class='hs-keyglyph'>]</span>
<a name="line-2742"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it is defined and used in the same recursive group"</span>
<a name="line-2743"></a>
<a name="line-2744"></a><span class='hs-comment'>{-
<a name="line-2745"></a>************************************************************************
<a name="line-2746"></a>*                                                                      *
<a name="line-2747"></a>                Scoped type variables
<a name="line-2748"></a>*                                                                      *
<a name="line-2749"></a>************************************************************************
<a name="line-2750"></a>-}</span>
<a name="line-2751"></a>
<a name="line-2752"></a><a name="badPatTyVarTvs"></a><span class='hs-definition'>badPatTyVarTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2753"></a><span class='hs-definition'>badPatTyVarTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2754"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"The type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>,</span>
<a name="line-2755"></a>                 <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2756"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"should be bound by the pattern signature"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2757"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"but are actually discarded by a type synonym"</span> <span class='hs-keyglyph'>]</span>
<a name="line-2758"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"To fix this, expand the type synonym"</span>
<a name="line-2759"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[Note: I hope to lift this restriction in due course]"</span> <span class='hs-keyglyph'>]</span>
<a name="line-2760"></a>
<a name="line-2761"></a><span class='hs-comment'>{-
<a name="line-2762"></a>************************************************************************
<a name="line-2763"></a>*                                                                      *
<a name="line-2764"></a>          Error messages and such
<a name="line-2765"></a>*                                                                      *
<a name="line-2766"></a>************************************************************************
<a name="line-2767"></a>-}</span>
<a name="line-2768"></a>
<a name="line-2769"></a>
<a name="line-2770"></a><span class='hs-comment'>{- Note [Free-floating kind vars]
<a name="line-2771"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2772"></a>Consider
<a name="line-2773"></a>
<a name="line-2774"></a>  data S a = MkS (Proxy (a :: k))
<a name="line-2775"></a>
<a name="line-2776"></a>According to the rules around implicitly-bound kind variables,
<a name="line-2777"></a>that k scopes over the whole declaration. The renamer grabs
<a name="line-2778"></a>it and adds it to the hsq_implicits field of the HsQTyVars of the
<a name="line-2779"></a>tycon.  So we get
<a name="line-2780"></a>   S :: forall {k}. k -&gt; Type
<a name="line-2781"></a>
<a name="line-2782"></a>That's fine.  But consider this variant:
<a name="line-2783"></a>  data T = MkT (forall (a :: k). Proxy a)
<a name="line-2784"></a>  -- from test ghci/scripts/T7873
<a name="line-2785"></a>
<a name="line-2786"></a>This is not an existential datatype, but a higher-rank one (the forall
<a name="line-2787"></a>to the right of MkT). Again, 'k' scopes over the whole declaration,
<a name="line-2788"></a>but we do not want to get
<a name="line-2789"></a>   T :: forall {k}. Type
<a name="line-2790"></a>Why not? Because the kind variable isn't fixed by anything. For
<a name="line-2791"></a>a variable like k to be implicit, it needs to be mentioned in the kind
<a name="line-2792"></a>of a tycon tyvar. But it isn't.
<a name="line-2793"></a>
<a name="line-2794"></a>Rejecting T depends on whether or not the datatype has a CUSK.
<a name="line-2795"></a>
<a name="line-2796"></a>Non-CUSK (handled in TcTyClsDecls.kcTyClGroup (generalise)):
<a name="line-2797"></a>   When generalising the TyCon we check that every Specified 'k'
<a name="line-2798"></a>   appears free in the kind of the TyCon; that is, in the kind of
<a name="line-2799"></a>   one of its Required arguments, or the result kind.
<a name="line-2800"></a>
<a name="line-2801"></a>CUSK (handled in TcHsType.kcLHsQTyVars, the CUSK case):
<a name="line-2802"></a>   When we determine the tycon's final, never-to-be-changed kind
<a name="line-2803"></a>   in kcLHsQTyVars, we check to make sure all implicitly-bound kind
<a name="line-2804"></a>   vars are indeed mentioned in a kind somewhere. If not, error.
<a name="line-2805"></a>
<a name="line-2806"></a>We also perform free-floating kind var analysis for type family instances
<a name="line-2807"></a>(see #13985). Here is an interesting example:
<a name="line-2808"></a>
<a name="line-2809"></a>    type family   T :: k
<a name="line-2810"></a>    type instance T = (Nothing :: Maybe a)
<a name="line-2811"></a>
<a name="line-2812"></a>Upon a cursory glance, it may appear that the kind variable `a` is
<a name="line-2813"></a>free-floating above, since there are no (visible) LHS patterns in `T`. However,
<a name="line-2814"></a>there is an *invisible* pattern due to the return kind, so inside of GHC, the
<a name="line-2815"></a>instance looks closer to this:
<a name="line-2816"></a>
<a name="line-2817"></a>    type family T @k :: k
<a name="line-2818"></a>    type instance T @(Maybe a) = (Nothing :: Maybe a)
<a name="line-2819"></a>
<a name="line-2820"></a>Here, we can see that `a` really is bound by a LHS type pattern, so `a` is in
<a name="line-2821"></a>fact not free-floating. Contrast that with this example:
<a name="line-2822"></a>
<a name="line-2823"></a>    type instance T = Proxy (Nothing :: Maybe a)
<a name="line-2824"></a>
<a name="line-2825"></a>This would looks like this inside of GHC:
<a name="line-2826"></a>
<a name="line-2827"></a>    type instance T @(*) = Proxy (Nothing :: Maybe a)
<a name="line-2828"></a>
<a name="line-2829"></a>So this time, `a` is neither bound by a visible nor invisible type pattern on
<a name="line-2830"></a>the LHS, so it would be reported as free-floating.
<a name="line-2831"></a>
<a name="line-2832"></a>Finally, here's one more brain-teaser (from #9574). In the example below:
<a name="line-2833"></a>
<a name="line-2834"></a>    class Funct f where
<a name="line-2835"></a>      type Codomain f :: *
<a name="line-2836"></a>    instance Funct ('KProxy :: KProxy o) where
<a name="line-2837"></a>      type Codomain 'KProxy = NatTr (Proxy :: o -&gt; *)
<a name="line-2838"></a>
<a name="line-2839"></a>As it turns out, `o` is not free-floating in this example. That is because `o`
<a name="line-2840"></a>bound by the kind signature of the LHS type pattern 'KProxy. To make this more
<a name="line-2841"></a>obvious, one can also write the instance like so:
<a name="line-2842"></a>
<a name="line-2843"></a>    instance Funct ('KProxy :: KProxy o) where
<a name="line-2844"></a>      type Codomain ('KProxy :: KProxy o) = NatTr (Proxy :: o -&gt; *)
<a name="line-2845"></a>-}</span>
<a name="line-2846"></a>
<a name="line-2847"></a><a name="reportFloatingKvs"></a><span class='hs-comment'>-- See Note [Free-floating kind vars]</span>
<a name="line-2848"></a><span class='hs-definition'>reportFloatingKvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>         <span class='hs-comment'>-- of the tycon</span>
<a name="line-2849"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span> <span class='hs-comment'>-- What sort of TyCon it is</span>
<a name="line-2850"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- all tyvars, not necessarily zonked</span>
<a name="line-2851"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- floating tyvars</span>
<a name="line-2852"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2853"></a><span class='hs-definition'>reportFloatingKvs</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>all_tvs</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2854"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- don't bother zonking if there's no error</span>
<a name="line-2855"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>all_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>all_tvs</span>
<a name="line-2856"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2857"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>all_tvs</span>
<a name="line-2858"></a>             <span class='hs-varid'>tidy_bad_tvs</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyCoVarOcc</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-2859"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>report</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_bad_tvs</span> <span class='hs-layout'>}</span>
<a name="line-2860"></a>  <span class='hs-keyword'>where</span>
<a name="line-2861"></a>    <span class='hs-varid'>report</span> <span class='hs-varid'>tidy_all_tvs</span> <span class='hs-varid'>tidy_bad_tv</span>
<a name="line-2862"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-2863"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_bad_tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2864"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"is implicitly bound in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>flav</span>
<a name="line-2865"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-2866"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"but does not appear as the kind of any"</span>
<a name="line-2867"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"of its type variables. Perhaps you meant"</span>
<a name="line-2868"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to bind it explicitly somewhere?"</span>
<a name="line-2869"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ppWhen</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2870"></a>                 <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type variables with inferred kinds:"</span><span class='hs-layout'>)</span>
<a name="line-2871"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>tidy_all_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2872"></a>
<a name="line-2873"></a>    <span class='hs-varid'>ppr_tv_bndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-2874"></a>    <span class='hs-varid'>pp_tv</span> <span class='hs-varid'>tv</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2875"></a>
<a name="line-2876"></a><a name="failIfEmitsConstraints"></a><span class='hs-comment'>-- | If the inner action emits constraints, report them as errors and fail;</span>
<a name="line-2877"></a><span class='hs-comment'>-- otherwise, propagates the return value. Useful as a wrapper around</span>
<a name="line-2878"></a><span class='hs-comment'>-- 'tcImplicitTKBndrs', which uses solveLocalEqualities, when there won't be</span>
<a name="line-2879"></a><span class='hs-comment'>-- another chance to solve constraints</span>
<a name="line-2880"></a><span class='hs-definition'>failIfEmitsConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2881"></a><span class='hs-definition'>failIfEmitsConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2882"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- We say that we fail if there are constraints!</span>
<a name="line-2883"></a>                   <span class='hs-comment'>-- c.f same checkNoErrs in solveEqualities</span>
<a name="line-2884"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2885"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportAllUnsolved</span> <span class='hs-varid'>lie</span>
<a name="line-2886"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span>
<a name="line-2887"></a>       <span class='hs-layout'>}</span>
<a name="line-2888"></a>
<a name="line-2889"></a><a name="funAppCtxt"></a><span class='hs-comment'>-- | Make an appropriate message for an error in a function argument.</span>
<a name="line-2890"></a><span class='hs-comment'>-- Used for both expressions and types.</span>
<a name="line-2891"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2892"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_no</span>
<a name="line-2893"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2894"></a>                    <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>", namely"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2895"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2896"></a>
<a name="line-2897"></a><a name="addTyConFlavCtxt"></a><span class='hs-comment'>-- | Add a "In the data declaration for T" or some such.</span>
<a name="line-2898"></a><span class='hs-definition'>addTyConFlavCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2899"></a><span class='hs-definition'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-2900"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>flav</span>
<a name="line-2901"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"declaration for"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre></body>
</html>
